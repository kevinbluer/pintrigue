/*!
 * Module dependencies.
 */function QueryStream(e){Stream.call(this);this.query=e;this.readable=!0;this.paused=!1;this._cursor=null;this._destroyed=null;this._fields=null;this._ticks=0;this._inline=T_INIT;var t=this;process.nextTick(function(){t._init()})}var Stream=require("stream").Stream,utils=require("./utils");QueryStream.prototype.__proto__=Stream.prototype;QueryStream.prototype.readable;QueryStream.prototype.paused;var T_INIT=0,T_IDLE=1,T_CONT=2;QueryStream.prototype._init=function(){if(this._destroyed)return;var e=this.query,t=e.model,n=e._optionsForExec(t),r=this;try{e.cast(t)}catch(i){return r.destroy(i)}r._fields=utils.clone(n.fields=e._fields);t.collection.find(e._conditions,n,function(e,t){if(e)return r.destroy(e);r._cursor=t;r._next()})};QueryStream.prototype._next=function(){var e;while(e=this.__next())e.call(this)};QueryStream.prototype.__next=function(){if(this.paused||this._destroyed)return;var e=this;e._inline=T_INIT;e._cursor.nextObject(function(t,n){e._onNextObject(t,n)});if(T_CONT===this._inline)return this.__next;this._inline=T_IDLE};QueryStream.prototype._onNextObject=function(e,t){if(e)return this.destroy(e);if(!t)return this.destroy();if(this.query.options&&this.query.options.lean===!0){this.emit("data",t);this._next();return}var n=new this.query.model(undefined,this._fields);delete n._doc._id;var r=this;n.init(t,this.query,function(e){if(e)return r.destroy(e);r.emit("data",n);T_IDLE===r._inline?r._next():r._inline=T_CONT})};QueryStream.prototype.pause=function(){this.paused=!0};QueryStream.prototype.resume=function(){this.paused=!1;this._next()};QueryStream.prototype.destroy=function(e){if(this._destroyed)return;this._destroyed=!0;this.readable=!1;this._cursor&&this._cursor.close();e&&this.emit("error",e);this.emit("close")};module.exports=exports=QueryStream;