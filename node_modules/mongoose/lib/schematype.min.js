/*!
 * Module dependencies.
 */function SchemaType(e,t,n){this.path=e;this.instance=n;this.validators=[];this.setters=[];this.getters=[];this.options=t;this._index=null;this.selected;for(var r in t)if(this[r]&&"function"==typeof this[r]){if("index"==r&&this._index)continue;var i=Array.isArray(t[r])?t[r]:[t[r]];this[r].apply(this,i)}}var utils=require("./utils"),CastError=require("./errors/cast"),ValidatorError=require("./errors/validator");SchemaType.prototype.default=function(e){if(1===arguments.length){this.defaultValue=typeof e=="function"?e:this.cast(e);return this}arguments.length>1&&(this.defaultValue=utils.args(arguments));return this.defaultValue};SchemaType.prototype.index=function(e){this._index=e;utils.expires(this._index);return this};SchemaType.prototype.unique=function(e){if(!this._index||"Object"!==this._index.constructor.name)this._index={};this._index.unique=e;return this};SchemaType.prototype.sparse=function(e){if(!this._index||"Object"!==this._index.constructor.name)this._index={};this._index.sparse=e;return this};SchemaType.prototype.expires=function(e){if(!this._index||"Object"!==this._index.constructor.name)this._index={};this._index.expires=e;utils.expires(this._index);return this};SchemaType.prototype.set=function(e){if("function"!=typeof e)throw new Error("A setter must be a function.");this.setters.push(e);return this};SchemaType.prototype.get=function(e){if("function"!=typeof e)throw new Error("A getter must be a function.");this.getters.push(e);return this};SchemaType.prototype.validate=function(e,t){if("function"==typeof e||e&&"RegExp"===e.constructor.name){this.validators.push([e,t]);return this}var n=arguments.length,r;while(n--){r=arguments[n];if(!r||"Object"!=r.constructor.name){var i="Invalid validator. Received ("+typeof r+") "+r+". See http://mongoosejs.com/docs/api.html#schematype_SchemaType-validate";throw new Error(i)}this.validate(r.validator,r.msg)}return this};SchemaType.prototype.required=function(e){function n(e){return"isSelected"in this&&!this.isSelected(t.path)&&!this.isModified(t.path)?!0:t.checkRequired(e)}var t=this;if(!1===e){this.isRequired=!1;this.validators=this.validators.filter(function(e){return e[0].name!=="__checkRequired"})}else{this.isRequired=!0;this.validators.push([n,"required"])}return this};SchemaType.prototype.getDefault=function(e,t){var n="function"==typeof this.defaultValue?this.defaultValue.call(e):this.defaultValue;return null!==n&&undefined!==n?this.cast(n,e,t):n};SchemaType.prototype.applySetters=function(e,t,n,r){if(SchemaType._isRef(this,e,n))return e;var i=e,s=this.setters,o=s.length;if(!o)return null===i||undefined===i?i:n?i:this.cast(i,t,n,r);while(o--)i=s[o].call(t,i,this);if(null===i||undefined===i)return i;i=this.cast(i,t,n,r);return i};SchemaType.prototype.applyGetters=function(e,t){if(SchemaType._isRef(this,e,!0))return e;var n=e,r=this.getters,i=r.length;if(!i)return n;while(i--)n=r[i].call(t,n,this);return n};SchemaType.prototype.select=function(t){this.selected=!!t};SchemaType.prototype.doValidate=function(e,t,n){function o(e,n){if(r)return;e===undefined||e?--s||t(null):t(r=new ValidatorError(i,n))}var r=!1,i=this.path,s=this.validators.length;if(!s)return t(null);this.validators.forEach(function(t){var r=t[0],i=t[1];r instanceof RegExp?o(r.test(e),i):"function"==typeof r&&(2===r.length?r.call(n,e,function(e){o(e,i)}):o(r.call(n,e),i))})};SchemaType._isRef=function(e,t,n){if(n&&e.options&&e.options.ref){if(null==t)return!0;if(t._id&&t._id.constructor.name===e.instance)return!0}return!1};module.exports=exports=SchemaType;exports.CastError=CastError;exports.ValidatorError=ValidatorError;