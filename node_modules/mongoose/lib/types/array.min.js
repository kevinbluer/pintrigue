/*!
 * Module dependencies.
 */function MongooseArray(e,t,n){var r=[];r.push.apply(r,e);r.__proto__=MongooseArray.prototype;r._atomics={};r.validators=[];r._path=t;if(n){r._parent=n;r._schema=n.schema.path(t)}return r}var EmbeddedDocument=require("./embedded"),Document=require("../document"),ObjectId=require("./objectid");MongooseArray.prototype=new Array;MongooseArray.prototype._atomics;MongooseArray.prototype._parent;MongooseArray.prototype._cast=function(e){var t=this._schema.caster.cast,n=this._parent;return t.call(null,e,n)};MongooseArray.prototype._markModified=function(e,t){var n=this._parent,r;if(n){arguments.length?r=[this._path,this.indexOf(e),t].join("."):r=this._path;n.markModified(r)}return this};MongooseArray.prototype._registerAtomic=function(e,t){if("$set"==e){this._atomics={$set:t};this._markModified();return this}var n=this._atomics;if("$pop"==e&&!("$pop"in n)){var r=this;this._parent.once("save",function(){r._popped=r._shifted=null})}if(this._atomics.$set)return this;if(!Object.keys(n).length||e in n){if(e==="$pullAll"||e==="$pushAll"||e==="$addToSet"){n[e]||(n[e]=[]);n[e]=n[e].concat(t)}else if(e==="$pullDocs"){var i=n.$pull||(n.$pull={}),s=i._id||(i._id={$in:[]});s.$in=s.$in.concat(t)}else n[e]=t;this._markModified();return this}this._atomics={$set:this};this._markModified();return this};MongooseArray.prototype.hasAtomics=function(){return!this._atomics||"Object"!==this._atomics.constructor.name?0:Object.keys(this._atomics).length};MongooseArray.prototype.push=function(){var e=[].map.call(arguments,this._cast,this),t=[].push.apply(this,e);this._registerAtomic("$pushAll",e);return t};MongooseArray.prototype.nonAtomicPush=function(){var e=[].map.call(arguments,this._cast,this),t=[].push.apply(this,e);this._registerAtomic("$set",this);return t};MongooseArray.prototype.$pop=function(){this._registerAtomic("$pop",1);if(this._popped)return;this._popped=!0;return[].pop.call(this)};MongooseArray.prototype.pop=function(){var e=[].pop.call(this);this._registerAtomic("$set",this);return e};MongooseArray.prototype.$shift=function(){this._registerAtomic("$pop",-1);if(this._shifted)return;this._shifted=!0;return[].shift.call(this)};MongooseArray.prototype.shift=function(){var e=[].shift.call(this);this._registerAtomic("$set",this);return e};MongooseArray.prototype.remove=function(){var e=[].map.call(arguments,this._cast,this);e.length==1?this.pull(e[0]):this.pull.apply(this,e);return e};MongooseArray.prototype.pull=function(){var e=[].map.call(arguments,this._cast,this),t=this._parent.get(this._path),n=t.length,r;while(n--){r=t[n];r instanceof EmbeddedDocument?e.some(function(e){return e.equals(r)})&&[].splice.call(t,n,1):~t.indexOf.call(e,r)&&[].splice.call(t,n,1)}e[0]instanceof EmbeddedDocument?this._registerAtomic("$pullDocs",e.map(function(e){return e._id})):this._registerAtomic("$pullAll",e);return this};MongooseArray.prototype.splice=function(){if(arguments.length){var e=[].splice.apply(this,arguments);this._registerAtomic("$set",this)}return e};MongooseArray.prototype.unshift=function(){var e=[].map.call(arguments,this._cast,this);[].unshift.apply(this,e);this._registerAtomic("$set",this);return this.length};MongooseArray.prototype.sort=function(){var e=[].sort.apply(this,arguments);this._registerAtomic("$set",this);return e};MongooseArray.prototype.addToSet=function(){var t=[].map.call(arguments,this._cast,this),n=[],r=t[0]instanceof EmbeddedDocument?"doc":t[0]instanceof Date?"date":"";t.forEach(function(e){var t;switch(r){case"doc":t=this.some(function(t){return t.equals(e)});break;case"date":var i=+e;t=this.some(function(e){return+e===i});break;default:t=~this.indexOf(e)}if(!t){[].push.call(this,e);this._registerAtomic("$addToSet",e);[].push.call(n,e)}},this);return n};MongooseArray.prototype.toObject=function(e){return e&&e.depopulate&&this[0]instanceof Document?this.map(function(e){return e._id}):this.map(function(e){return e})};MongooseArray.prototype.inspect=function(){return"["+this.map(function(e){return" "+e})+" ]"};MongooseArray.prototype.indexOf=function(t){t instanceof ObjectId&&(t=t.toString());for(var n=0,r=this.length;n<r;++n)if(t==this[n])return n;return-1};module.exports=exports=MongooseArray;