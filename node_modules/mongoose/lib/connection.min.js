/*!
 * Module dependencies.
 */function Connection(e){this.base=e;this.collections={};this.models={};this.replica=!1;this.host=null;this.port=null;this.user=null;this.pass=null;this.name=null;this.options=null;this._readyState=STATES.disconnected;this._closeCalled=!1;this._hasOpened=!1}function noop(){}var url=require("url"),utils=require("./utils"),EventEmitter=utils.EventEmitter,driver=global.MONGOOSE_DRIVER_PATH||"./drivers/node-mongodb-native",Model=require("./model"),Schema=require("./schema"),Collection=require(driver+"/collection"),STATES=require("./connectionstate"),assert=require("assert"),rgxProtocol=/^(?:.)+:\/\//;Connection.prototype.__proto__=EventEmitter.prototype;Object.defineProperty(Connection.prototype,"readyState",{get:function(){return this._readyState},set:function(e){if(!(e in STATES))throw new Error("Invalid connection state: "+e);if(this._readyState!==e){this._readyState=e;STATES.connected===e&&(this._hasOpened=!0);this.emit(STATES[e])}}});Connection.prototype.collections;Connection.prototype.db;Connection.prototype.open=function(e,t,n,r,i){var s=this,o;if("string"==typeof t)switch(arguments.length){case 2:n=27017;case 3:switch(typeof n){case"function":i=n,n=27017;break;case"object":r=n,n=27017}break;case 4:"function"==typeof r&&(i=r,r={})}else{switch(typeof t){case"function":i=t,t=undefined;break;case"object":r=t;t=undefined;i=n}rgxProtocol.test(e)||(e="mongodb://"+e);o=url.parse(e);e=o.hostname;n=o.port||27017;t=o.pathname&&o.pathname.replace(/\//g,"")}this.options=this.defaultOptions(r);if(STATES.disconnected!==this.readyState){var u=new Error("Trying to open unclosed connection.");u.state=this.readyState;this.error(u,i);return this}if(!e){this.error(new Error("Missing connection hostname."),i);return this}if(!t){this.error(new Error("Missing connection database."),i);return this}if(o&&o.auth){var a=o.auth.split(":");this.user=a[0];this.pass=a[1]}else if(/@/.test(e)&&/:/.test(e.split("@")[0])){e=e.split("@");var a=e.shift().split(":");e=e.pop();this.user=a[0];this.pass=a[1]}else if(r&&r.user&&r.pass){this.user=r.user;this.pass=r.pass}else this.user=this.pass=undefined;this.name=t;this.host=e;this.port=n;this._open(i);return this};Connection.prototype.openSet=function(e,t,n,r){var e=e.split(","),i=this;switch(arguments.length){case 3:this.name=t;"function"==typeof n&&(r=n,n={});break;case 2:switch(typeof t){case"string":this.name=t;case"function":r=t,t=null;break;case"object":n=t,t=null}}this.options=n=this.defaultOptions(n);if(e.length<2){this.error(new Error("Please provide comma-separated URIs"),r);return this}this.replica=!0;this.host=[];this.port=[];e.forEach(function(e){rgxProtocol.test(e)||(e="mongodb://"+e);var e=url.parse(e);i.host.push(e.hostname);i.port.push(e.port||27017);!i.name&&e.pathname&&e.pathname.replace(/\//g,"")&&(i.name=e.pathname.replace(/\//g,""));if(!i.user&&e.auth){var t=e.auth.split(":");i.user=t[0];i.pass=t[1]}});if(!this.name){this.error(new Error("No database name provided for replica set"),r);return this}this._open(r);return this};Connection.prototype.error=function(e,t){if(t)return t(e);this.emit("error",e)};Connection.prototype._open=function(e){this.readyState=STATES.connecting;this._closeCalled=!1;var t=this,n=this.replica?"doOpenSet":"doOpen";this[n](function(n){if(n){t.readyState=STATES.disconnected;t._hasOpened?e&&e(n):t.error(n,e);return}t.onOpen();e&&e()})};Connection.prototype.onOpen=function(){function t(){e.readyState=STATES.connected;for(var t in e.collections)e.collections[t].onOpen();e.emit("open")}var e=this;e.user&&e.pass?e.db.authenticate(e.user,e.pass,t):t()};Connection.prototype.close=function(e){var t=this;this._closeCalled=!0;switch(this.readyState){case 0:e&&e();break;case 1:this.readyState=STATES.disconnecting;this.doClose(function(n){if(n)t.error(n,e);else{t.onClose();e&&e()}});break;case 2:this.once("open",function(){t.close(e)});break;case 3:if(!e)break;this.once("close",function(){e()})}return this};Connection.prototype.onClose=function(){this.readyState=STATES.disconnected;for(var e in this.collections)this.collections[e].onClose();this.emit("close")};Connection.prototype.collection=function(e,t){e in this.collections||(this.collections[e]=new Collection(e,this,t));return this.collections[e]};Connection.prototype.model=function(e,t,n){if(!this.models[e]){var r=this.base.model(e,t,n,!0),i;if(this!=r.prototype.db){i=function o(e,t,n){if(!(this instanceof o))return new o(e,t,n);r.call(this,e,t,n)};i.__proto__=r;i.prototype.__proto__=r.prototype;i.db=i.prototype.db=this;"string"==typeof t&&(n=t);n||(n=r.prototype.schema.set("collection")||utils.toCollectionName(e));var s="string"!=typeof t?t:r.prototype.schema;i.prototype.collection=this.collection(n,s&&s.options.capped);i.collection=i.prototype.collection;i.init()}this.models[e]=i||r}return this.models[e]};Connection.prototype.setProfiling=function(e,t,n){if(STATES.connected!==this.readyState)return this.on("open",this.setProfiling.bind(this,e,t,n));n||(n=t,t=100);var r={};switch(e){case 0:case"off":r.profile=0;break;case 1:case"slow":r.profile=1;if("number"!=typeof t){t=parseInt(t,10);isNaN(t)&&(t=100)}r.slowms=t;break;case 2:case"all":r.profile=2;break;default:return n(new Error("Invalid profiling level: "+e))}this.db.executeDbCommand(r,function(t,r){if(t)return n(t);var i=r.documents[0];t=1===i.ok?null:new Error("Could not set profiling level to: "+e);n(t,i)})};Connection.prototype.defaultOptions=function(e){var t=e||{};t.server=t.server||{};"auto_reconnect"in t.server||(t.server.auto_reconnect=!0);t.db=t.db||{};t.db.forceServerObjectId=!1;return t};Connection.STATES=STATES;module.exports=Connection;