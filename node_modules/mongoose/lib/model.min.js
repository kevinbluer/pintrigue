/*!
 * Module dependencies.
 */function Model(e,t,n){Document.call(this,e,t,n)}function handleSave(e,t){return tick(function(r,i){if(r){if(t._inserting){t.isNew=!0;t.emit("isNew",!0)}e.error(r);e=t=null;return}t._storeShard();var s;i?s=i.length?i.length:i:s=0;if(t.__version&&!t._inserting){var o=VERSION_INC===(VERSION_INC&t.__version);t.__version=undefined;if(!(s>0)){e.error(new Error("No matching document found."));e=t=null;return}if(o){var u=t.schema.options.versionKey,a=t.getValue(u)|0;t.setValue(u,a+1)}}t.emit("save",t,s);e.complete(t,s);e=t=null})}function operand(e,t,n,r,i,s){s||(s="$set");n[s]||(n[s]={});n[s][r.path]=i;if(!1===e.schema.options.versionKey)return;if(VERSION_ALL===(VERSION_ALL&e.__version))return;switch(s){case"$set":case"$unset":case"$pop":case"$pull":case"$pullAll":case"$push":case"$pushAll":case"$addToSet":break;default:return}"$push"==s||"$pushAll"==s||"$addToSet"==s?e.__version=VERSION_INC:/^\$p/.test(s)?e.increment():Array.isArray(i)?e.increment():/\.\d+/.test(r.path)&&(e.__version=VERSION_WHERE)}function handleAtomics(e,t,n,r,i){if(n.$set&&n.$set[r.path])return;var s=i._atomics,o=Object.keys(s),u=r.schema,a=r.path,f=o.length,i,l;if(0===f){isMongooseObject(i)?i=i.toObject({depopulate:1}):i.valueOf&&(i=i.valueOf());return operand(e,t,n,r,i)}while(f--){l=o[f];i=s[l];isMongooseObject(i)?i=i.toObject({depopulate:1}):Array.isArray(i)?i=i.map(function(e){return isMongooseObject(e)?e.toObject({depopulate:1}):e}):i.valueOf&&(i=i.valueOf());"$addToSet"===l&&(i={$each:i});operand(e,t,n,r,i,l)}}var Document=require("./document"),MongooseArray=require("./types/array"),MongooseBuffer=require("./types/buffer"),MongooseError=require("./error"),Query=require("./query"),Schema=require("./schema"),utils=require("./utils"),isMongooseObject=utils.isMongooseObject,EventEmitter=utils.EventEmitter,merge=utils.merge,Promise=require("./promise"),tick=utils.tick,VERSION_WHERE=1,VERSION_INC=2,VERSION_ALL=VERSION_WHERE|VERSION_INC;Model.prototype.__proto__=Document.prototype;Model.prototype.db;Model.prototype.collection;Model.prototype.modelName;Model.prototype._getPopulationKeys=function(t){if(!t||!t.options.populate)return;var n=Object.keys(t.options.populate),r=n.length,i,s={},o,u;while(r--){i=n[r];u=this.schema.path(i);o=!0;if(!u){var a=i.split("."),f=a.length;while(f--){var l=a.slice(0,f).join("."),c=this.schema.path(l);if(c&&c.caster){s[l]||(s[l]={sub:{}});s[l].sub[a.slice(f).join(".")]=t.options.populate[i];o||(o=!0);break}}}else{s[i]=t.options.populate[i];o||(o=!0)}}return o&&s};Model.prototype._populate=function(t,n,r,i){if(!Array.isArray(n)){var s=r.conditions||{};s._id=n;return this.db.model(r.model||t.options.ref).findOne(s,r.fields,r.options,i)}if(!n.length)return i(null,n);var o=this.db.model(r.model||t.caster.options.ref),s=r&&r.conditions||{};s._id||(s._id={$in:n});o.find(s,r.fields,r.options,function(e,t){if(e)return i(e);if(r.options&&r.options.sort)return i(null,t);var s={};t.forEach(function(e){s[e._id]=e});var o=[];n.forEach(function(e){e in s&&o.push(s[e])});i(null,o)})};Model.prototype.init=function e(t,n,r){function e(t,n,r){function f(){if(--a<0)return r();var l=u[a],c=n+l,h=s.schema.path(c),p=0,d=!1,v;if(!h&&t[l]&&"Object"===t[l].constructor.name)return e(t[l],c+".",f);if(!(t[l]&&h&&i[c]))return f();v=utils.clone(i[c]);if(v.sub){t[l].forEach(function(e){d=!0;var t=Object.keys(v.sub),n=t.length,r;while(n--){r=t[n];e[r]&&function(t){function n(n,r){if(n)return o(n);e[t]=r;--p<1&&!d&&f()}p++;s._populate(h.schema.path(t),e[t],v.sub[t],n)}(r)}});d=!1;if(0===p)return f()}else s._populate(h,t[l],v,function(e,n){if(e)return o(e);t[l]=n;f()})}n=n||"";var u=Object.keys(t),a=u.length;return f()}function o(e){if(o.err)return;r(o.err=e)}if("function"==typeof n){r=n;n=null}var i=this._getPopulationKeys(n);if(!i)return Document.prototype.init.call(this,t,r);var s=this;e(t,"",function(e){if(e)return r(e);Document.prototype.init.call(s,t,r)});return this};Model.prototype.save=function(t){var n=new Promise(t),r=handleSave(n,this),i={};this.schema.options.safe&&(i.safe=this.schema.options.safe);if(this.isNew){var s=this.toObject({depopulate:1});this._version(!0,s);this.collection.insert(s,i,r);this._reset();this.isNew=!1;this.emit("isNew",!1);this._inserting=!0}else{this._inserting=!1;var o=this._delta();if(o){var u=this._where(o[0]);this.collection.update(u,o[1],i,r)}else r(null);this._reset();this.emit("isNew",!1)}};Model.prototype._delta=function(){var t=this._dirty();if(!t.length)return;var n=this,r={},i={},s=t.length,o=0,u,a;for(;o<s;++o){var f=t[o],l=f.value,c=f.schema;if(undefined===l)operand(n,r,i,f,1,"$unset");else if(null===l)operand(n,r,i,f,null);else if(l._path&&l._atomics)handleAtomics(n,r,i,f,l);else if(l._path&&Buffer.isBuffer(l)){l=l.toObject();operand(n,r,i,f,l)}else{l=utils.clone(l);operand(n,r,i,f,l)}}this.__version&&this._version(r,i);return[r,i]};Model.prototype._version=function(t,n){var r=this.schema.options.versionKey;if(!0===t){r&&this.setValue(r,n[r]=0);return}if(!this.isSelected(r))return;VERSION_WHERE===(VERSION_WHERE&this.__version)&&(t[r]=this.getValue(r));if(VERSION_INC===(VERSION_INC&this.__version)){n.$inc||(n.$inc={});n.$inc[r]=1}};Model.prototype.increment=function(){this.__version=VERSION_ALL;return this};Model.prototype._where=function(t){t||(t={});var n,r;if(this._shardval){n=Object.keys(this._shardval);r=n.length;for(var i=0;i<r;++i)t[n[i]]=this._shardval[n[i]]}t._id=this._doc._id;return t};Model.prototype.remove=function(t){if(this._removing)return this;var n=this._removing=new Promise(t),r=this._where(),i=this,s={};this.schema.options.safe&&(s.safe=this.schema.options.safe);this.collection.remove(r,s,tick(function(e){if(e){n.error(e);n=i=i._removing=r=s=null;return}i.emit("remove",i);n.complete();n=i=r=s=null}));return this};Model.prototype._registerHooks=function(){Document.prototype._registerHooks.call(this)};Model.prototype.model=function(t){return this.db.model(t)};for(var i in EventEmitter.prototype)Model[i]=EventEmitter.prototype[i];Model.init=function(){this.schema.options.autoIndex&&this.ensureIndexes();this.schema.emit("init",this)};Model.ensureIndexes=function(t){var n=this.schema.indexes();if(!n.length)return t&&t();var r=this,i=r.schema.options.safe,s=n.length,o;n.forEach(function(e){var n=e[1];n.safe=i;r.collection.ensureIndex(e[0],n,tick(function(e){e&&(o=e);if(--s)return;r.emit("index",o);t&&t(o)}))})};Model.schema;Model.db;Model.collection;Model.base;Model.remove=function(t,n){if("function"==typeof t){n=t;t={}}var r=(new Query(t)).bind(this,"remove");if("undefined"==typeof n)return r;this._applyNamedScope(r);return r.remove(n)};Model.find=function(t,n,r,i){if("function"==typeof t){i=t;t={};n=null;r=null}else if("function"==typeof n){i=n;n=null;r=null}else if("function"==typeof r){i=r;r=null}var s=new Query(t,r);s.bind(this,"find");s.select(n);if("undefined"==typeof i)return s;this._applyNamedScope(s);return s.find(i)};Model._applyNamedScope=function(t){var n=this._cumulativeQuery;if(n){merge(t._conditions,n._conditions);t._fields&&n._fields&&merge(t._fields,n._fields);t.options&&n.options&&merge(t.options,n.options);delete this._cumulativeQuery}return t};Model.findById=function(t,n,r,i){return this.findOne({_id:t},n,r,i)};Model.findOne=function(t,n,r,i){if("function"==typeof r){i=r;r=null}else if("function"==typeof n){i=n;n=null;r=null}else if("function"==typeof t){i=t;t={};n=null;r=null}var s=(new Query(t,r)).select(n).bind(this,"findOne");if("undefined"==typeof i)return s;this._applyNamedScope(s);return s.findOne(i)};Model.count=function(t,n){"function"==typeof t&&(n=t,t={});var r=(new Query(t)).bind(this,"count");if("undefined"==typeof n)return r;this._applyNamedScope(r);return r.count(n)};Model.distinct=function(t,n,r){var i=(new Query(n)).bind(this,"distinct");if("undefined"==typeof r){i._distinctArg=t;return i}this._applyNamedScope(i);return i.distinct(t,r)};Model.where=function(t,n){var r=(new Query).bind(this,"find");return r.where.apply(r,arguments)};Model.$where=function(){var t=(new Query).bind(this,"find");return t.$where.apply(t,arguments)};Model.findOneAndUpdate=function(e,t,n,r){if("function"==typeof n){r=n;n=null}else if(1===arguments.length){if("function"==typeof e){var i="Model.findOneAndUpdate(): First argument must not be a function.\n\n  "+this.modelName+".findOneAndUpdate(conditions, update, options, callback)\n"+"  "+this.modelName+".findOneAndUpdate(conditions, update, options)\n"+"  "+this.modelName+".findOneAndUpdate(conditions, update)\n"+"  "+this.modelName+".findOneAndUpdate(update)\n"+"  "+this.modelName+".findOneAndUpdate()\n";throw new TypeError(i)}t=e;e=undefined}var s;if(n&&n.fields){s=n.fields;n.fields=undefined}var o=new Query(e);o.setOptions(n);o.select(s);o.bind(this,"findOneAndUpdate",t);if("undefined"==typeof r)return o;this._applyNamedScope(o);return o.findOneAndUpdate(r)};Model.findByIdAndUpdate=function(e,t,n,r){var i;if(1===arguments.length){if("function"==typeof e){var s="Model.findByIdAndUpdate(): First argument must not be a function.\n\n  "+this.modelName+".findByIdAndUpdate(id, callback)\n"+"  "+this.modelName+".findByIdAndUpdate(id)\n"+"  "+this.modelName+".findByIdAndUpdate()\n";throw new TypeError(s)}return this.findOneAndUpdate({_id:e},undefined)}i=utils.args(arguments,1);i.unshift({_id:e});return this.findOneAndUpdate.apply(this,i)};Model.findOneAndRemove=function(e,t,n){if(1===arguments.length&&"function"==typeof e){var r="Model.findOneAndRemove(): First argument must not be a function.\n\n  "+this.modelName+".findOneAndRemove(conditions, callback)\n"+"  "+this.modelName+".findOneAndRemove(conditions)\n"+"  "+this.modelName+".findOneAndRemove()\n";throw new TypeError(r)}if("function"==typeof t){n=t;t=undefined}var i;if(t){i=t.select;t.select=undefined}var s=new Query(e);s.setOptions(t);s.select(i);s.bind(this,"findOneAndRemove");if("undefined"==typeof n)return s;this._applyNamedScope(s);return s.findOneAndRemove(n)};Model.findByIdAndRemove=function(e,t,n){if(1===arguments.length&&"function"==typeof e){var r="Model.findByIdAndRemove(): First argument must not be a function.\n\n  "+this.modelName+".findByIdAndRemove(id, callback)\n"+"  "+this.modelName+".findByIdAndRemove(id)\n"+"  "+this.modelName+".findByIdAndRemove()\n";throw new TypeError(r)}return this.findOneAndRemove({_id:e},t,n)};Model.create=function(t,n){if(1===arguments.length)return"function"==typeof t&&t(null);var r=this,i=[null],s,o,u;if(Array.isArray(t))u=t;else{u=utils.args(arguments,0,arguments.length-1);n=arguments[arguments.length-1]}if(0===u.length)return n(null);s=new Promise(n);o=u.length;u.forEach(function(e,t){var u=new r(e);i[t+1]=u;u.save(function(e){if(e)return s.error(e);--o||n.apply(null,i)})})};Model.update=function(t,n,r,i){if(arguments.length<4)if("function"==typeof r){i=r;r=null}else if("function"==typeof n){i=n;n=t;t={};r=null}var s=(new Query(t,r)).bind(this,"update",n);if("undefined"==typeof i)return s;this._applyNamedScope(s);return s.update(n,i)};Model.mapReduce=function(t,n){if("function"!=typeof n)throw new Error("missing callback");var r=this;if(!Model.mapReduce.schema){var i={noId:!0,noVirtualId:!0,strict:!1};Model.mapReduce.schema=new Schema({},i)}t.out||(t.out={inline:1});t.map=String(t.map);t.reduce=String(t.reduce);this.collection.mapReduce(null,null,t,function(e,t,i){if(e)return n(e);if(t.findOne&&t.mapReduce){var s=Model.compile("_mapreduce_"+t.collectionName,Model.mapReduce.schema,t.collectionName,r.db,r.base);s._mapreduce=!0;return n(e,s,i)}n(e,t,i)})};Model.aggregate=function(){return this.collection.aggregate.apply(this.collection,arguments)};Model.compile=function(t,n,r,i,s){function o(e,t,n){if(!(this instanceof o))return new o(e,t,n);Model.call(this,e,t,n)}o.modelName=t;o.__proto__=Model;o.prototype.__proto__=Model.prototype;o.prototype.db=i;o.prototype._setSchema(n);o.prototype.collection=i.collection(r,n.options.capped);for(var u in n.methods)o.prototype[u]=n.methods[u];for(var u in n.statics)o[u]=n.statics[u];n.namedScopes&&n.namedScopes.compile(o);o.model=o.prototype.model;o.options=o.prototype.options;o.db=o.prototype.db;o.schema=o.prototype.schema;o.collection=o.prototype.collection;o.base=s;return o};module.exports=exports=Model;