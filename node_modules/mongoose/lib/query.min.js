/*!
 * Module dependencies.
 */function Query(e,t){this.setOptions(t,!0);this._conditions={};this._updateArg={};e&&this.find(e)}function push(e,t,n){var r=String(n||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(r)){Array.isArray(n)&&(n="["+n+"]");throw new TypeError("Invalid sort value: {"+t+": "+n+" }")}e.push([t,n])}function PopulateOptions(e,t,n,r){this.conditions=t;this.fields=e;this.options=n;this.model=r}function castDoc(e){try{return e._castUpdate(e._updateArg)}catch(t){return t}}function castQuery(e){try{return e.cast(e.model)}catch(t){return t}}var utils=require("./utils"),merge=utils.merge,Promise=require("./promise"),Document=require("./document"),Types=require("./schema/index"),inGroupsOf=utils.inGroupsOf,tick=utils.tick,QueryStream=require("./querystream"),ReadPref=require("mongodb").ReadPreference;Query.prototype.setOptions=function(e,t){if(t){e=this.options=e||{};this.safe=e.safe;var n=this.options.populate;this.options.populate={};if(n&&Array.isArray(n))for(var r=0,i=n.length;r<i;r++)this.options.populate[n[r]]={};return this}if(!e||"Object"!=e.constructor.name)return this;"safe"in e&&(this.safe=e.safe);var s=Object.keys(e),r=s.length,o;while(r--){o=s[r];if("function"==typeof this[o]){var u=Array.isArray(e[o])?e[o]:[e[o]];this[o].apply(this,u)}else this.options[o]=e[o]}return this};Query.prototype.bind=function(t,n,r){this.model=t;this.op=n;t._mapreduce&&(this.options.lean=!0);(n=="update"||n=="findOneAndUpdate")&&merge(this._updateArg,r||{});return this};Query.prototype.exec=function(t,n){var r=new Promise;switch(typeof t){case"function":n=t;t=null;break;case"string":this.op=t}n&&r.addBack(n);if(!this.op){r.complete();return r}if("update"==this.op){this[this.op](this._updateArg,r.resolve.bind(r));return r}if("distinct"==this.op){this.distinct(this._distinctArg,r.resolve.bind(r));return r}this[this.op](r.resolve.bind(r));return r};Query.prototype.find=function(e,t){this.op="find";if("function"==typeof e){t=e;e={}}else e instanceof Query?merge(this._conditions,e._conditions):e instanceof Document?merge(this._conditions,e.toObject()):e&&"Object"===e.constructor.name&&merge(this._conditions,e);return t?this.execFind(t):this};Query.prototype.cast=function(e,t){t||(t=this._conditions);var n=e.schema,r=Object.keys(t),i=r.length,s,o,u,a,f,l;while(i--){a=r[i];l=t[a];if("$or"===a||"$nor"===a){var c=l.length,h;while(c--){h=new Query(l[c]);h.cast(e);l[c]=h._conditions}}else{if(a==="$where"){f=typeof l;if("string"!==f&&"function"!==f)throw new Error("Must have a string or function for $where");"function"===f&&(t[a]=l.toString());continue}if(!n)continue;o=n.path(a);if(!o){var p=a.split("."),d=p.length,v,m,g,y;while(d--){v=p.slice(0,d).join(".");o=n.path(v);if(o)break}if(o)if(o.caster&&o.caster.schema){g={};m=p.slice(d).join(".");g[m]=l;y=new Query(g);y.cast(o.caster);t[a]=y._conditions[m]}else t[a]=l}else{if(l===null||l===undefined)continue;if("Object"===l.constructor.name){s=Object.keys(l).some(function(e){return e.charAt(0)==="$"&&e!=="$id"&&e!=="$ref"});if(!s)t[a]=o.castForQuery(l);else{var b=Object.keys(l),c=b.length,w;while(c--){w=b[c];u=l[w];if("$exists"===w){if("boolean"!=typeof u)throw new Error("$exists parameter must be Boolean");continue}if("$type"===w){if("number"!=typeof u)throw new Error("$type parameter must be Number");continue}"$not"===w?this.cast(e,u):l[w]=o.castForQuery(w,u)}}}else t[a]=o.castForQuery(l)}}}return t};Query.prototype._optionsForExec=function(e){var t=utils.clone(this.options,{retainKeyOrder:!0});delete t.populate;"safe"in t||(t.safe=e.schema.options.safe);return t};Query.prototype._applyPaths=function(){function a(e,t){t||(t="");if(~u.indexOf(e))return;u.push(e);e.eachPath(function(e,n){t&&(e=t+"."+e);n.schema&&a(n.schema,e);f(e,n)})}function f(e,i){if("boolean"!=typeof i.selected)return;if(t&&"+"+e in t){delete t["+"+e];!1===n&&r.length>1&&(t[e]=1);return}(i.selected?s:o).push(e)}var t=this._fields,n,r,i;if(t){r=Object.keys(t);i=r.length;while(i--){if("+"==r[i][0])continue;n=0===t[r[i]];break}}var s=[],o=[],u=[];a(this.model.schema);switch(n){case!0:o.length&&this.select("-"+o.join(" -"));break;case!1:s.length&&this.select(s.join(" "));break;case undefined:o.length&&this.select("-"+o.join(" -"))}return u=o=s=r=t=null};Query.prototype.$where=function(e){this._conditions.$where=e;return this};Query.prototype.where=function(e,t){if(!arguments.length)return this;if("string"!=typeof e)throw new TypeError("path must be a string");this._currPath=e;2===arguments.length&&(this._conditions[e]=t);return this};Query.prototype.equals=function(t){var n=this._currPath;if(!n)throw new Error("equals() must be used after where()");this._conditions[n]=t;return this};Query.prototype.or=function e(t){var e=this._conditions.$or||(this._conditions.$or=[]);Array.isArray(t)||(t=[t]);e.push.apply(e,t);return this};Query.prototype.nor=function t(e){var t=this._conditions.$nor||(this._conditions.$nor=[]);Array.isArray(e)||(e=[e]);t.push.apply(t,e);return this};"gt gte lt lte ne in nin all regex size maxDistance".split(" ").forEach(function(e){Query.prototype[e]=function(t,n){if(arguments.length===1){n=t;t=this._currPath}var r=this._conditions[t]||(this._conditions[t]={});r["$"+e]=n;return this}});Query.prototype.near=function(e,t){if(arguments.length===1){t=e;e=this._currPath}else if(arguments.length===2&&!Array.isArray(t)){t=utils.args(arguments);e=this._currPath}else arguments.length===3&&(t=utils.args(arguments,1));var n=this._conditions[e]||(this._conditions[e]={});n.$near=t;return this};Query.prototype.nearSphere=function(e,t){if(arguments.length===1){t=e;e=this._currPath}else if(arguments.length===2&&!Array.isArray(t)){t=utils.args(arguments);e=this._currPath}else arguments.length===3&&(t=utils.args(arguments,1));var n=this._conditions[e]||(this._conditions[e]={});n.$nearSphere=t;return this};Query.prototype.mod=function(e,t){if(arguments.length===1){t=e;e=this._currPath}else if(arguments.length===2&&!Array.isArray(t)){t=utils.args(arguments);e=this._currPath}else arguments.length===3&&(t=utils.args(arguments,1));var n=this._conditions[e]||(this._conditions[e]={});n.$mod=t;return this};Query.prototype.exists=function(e,t){if(arguments.length===0){e=this._currPath;t=!0}else if(arguments.length===1)if("boolean"==typeof e){t=e;e=this._currPath}else t=!0;var n=this._conditions[e]||(this._conditions[e]={});n.$exists=t;return this};Query.prototype.elemMatch=function(e,t){var n;if("Object"===e.constructor.name){t=e;e=this._currPath}else if("function"==typeof e){n=e;e=this._currPath}else if("Object"!==t.constructor.name){if("function"!=typeof t)throw new Error("Argument error");n=t}var r=this._conditions[e]||(this._conditions[e]={});if(n){t=new Query;n(t);r.$elemMatch=t._conditions}else r.$elemMatch=t;return this};Object.defineProperty(Query.prototype,"within",{get:function(){return this}});Query.prototype.box=function(e,t){if(arguments.length===1){t=e;e=this._currPath}var n=this._conditions[e]||(this._conditions[e]={});n.$within={$box:[t.ll,t.ur]};return this};Query.prototype.center=function(e,t,n){if(arguments.length===1){t=e;e=this._currPath}var r=this._conditions[e]||(this._conditions[e]={});r.$within={$center:[t.center,t.radius]};n&&"Object"==n.constructor.name&&utils.options(n,r.$within);return this};Query.prototype.centerSphere=function(e,t){if(arguments.length===1){t=e;e=this._currPath}var n=this._conditions[e]||(this._conditions[e]={});n.$within={$centerSphere:[t.center,t.radius]};return this};Query.prototype.polygon=function(e,t){if(arguments.length===1){t=e;e=this._currPath}var n=this._conditions[e]||(this._conditions[e]={});n.$within={$polygon:t};return this};Query.prototype.select=function(t){if(!t)return this;var n=this._fields||(this._fields={});if("Object"===t.constructor.name)Object.keys(t).forEach(function(e){n[e]=t[e]});else{if(1!==arguments.length||"string"!=typeof t)throw new TypeError("Invalid select() argument. Must be a string or object.");t.split(/\s+/).forEach(function(e){if(!e)return;var t="-"==e[0]?0:1;t===0&&(e=e.substring(1));n[e]=t})}return this};Query.prototype.slice=function(e,t){if(arguments.length===1){t=e;e=this._currPath}else if(arguments.length===2){if("number"==typeof e){t=[e,t];e=this._currPath}}else arguments.length===3&&(t=utils.args(arguments,1));var n=this._fields||(this._fields={});n[e]={$slice:t};return this};Query.prototype.sort=function(e){if(!e)return this;var t=this.options.sort||(this.options.sort=[]);if("Object"===e.constructor.name)Object.keys(e).forEach(function(n){push(t,n,e[n])});else{if(1!==arguments.length||"string"!=typeof e)throw new TypeError("Invalid sort() argument. Must be a string or object.");e.split(/\s+/).forEach(function(e){if(!e)return;var n="-"==e[0]?-1:1;n===-1&&(e=e.substring(1));push(t,e,n)})}return this};["limit","skip","maxscan","batchSize","comment"].forEach(function(e){Query.prototype[e]=function(t){this.options[e]=t;return this}});Query.prototype.snapshot=function(){this.options.snapshot=!0;return this};Query.prototype.hint=function(e){if(!e)return this;var t=this.options.hint||(this.options.hint={});if("Object"!==e.constructor.name)throw new TypeError("Invalid hint. "+e);for(var n in e)t[n]=e[n];return this};Query.prototype.slaveOk=function(e){this.options.slaveOk=arguments.length?!!e:!0;return this};Query.prototype.read=function(e,t){switch(e){case"p":e="primary";break;case"pp":e="primaryPrefered";break;case"s":e="secondary";break;case"sp":e="secondaryPrefered";break;case"n":e="nearest"}this.options.readPreference=new ReadPref(e,t);return this};Query.prototype.lean=function(e){this.options.lean=arguments.length?!!e:!0;return this};Query.prototype.tailable=function(e){this.options.tailable=arguments.length?!!e:!0;return this};Query.prototype.execFind=function(e){function a(e,r){if(e)return n.error(e);if(!0===o.lean)return n.complete(r);var s=[],a=r.length;if(!a)return n.complete([]);for(var f=0,l=r.length;f<l;f++){s[f]=new t(undefined,u,!0);s[f].init(r[f],i,function(e){if(e)return n.error(e);--a||n.complete(s)})}}var t=this.model,n=new Promise(e);try{this.cast(t)}catch(r){n.error(r);return this}this._applyPaths();var i=this,s=this._conditions,o=this._optionsForExec(t),u=utils.clone(o.fields=this._fields);t.collection.find(s,o,function(e,t){if(e)return n.error(e);t.toArray(tick(a))});return this};Query.prototype.findOne=function(e){this.op="findOne";if(!e)return this;var t=this.model,n=new Promise(e);try{this.cast(t)}catch(r){n.error(r);return this}this._applyPaths();var i=this,s=this._conditions,o=this._optionsForExec(t),u=utils.clone(o.fields=this._fields);t.collection.findOne(s,o,tick(function(e,r){if(e)return n.error(e);if(!r)return n.complete(null);if(!0===o.lean)return n.complete(r);var s=new t(undefined,u,!0);s.init(r,i,function(e){if(e)return n.error(e);n.complete(s)})}));return this};Query.prototype.count=function(e){this.op="count";var t=this.model;try{this.cast(t)}catch(n){return e(n)}var r=this._conditions;t.collection.count(r,tick(e));return this};Query.prototype.distinct=function(e,t){this.op="distinct";var n=this.model;try{this.cast(n)}catch(r){return t(r)}var i=this._conditions;n.collection.distinct(e,i,tick(t));return this};var castOps={$push:1,$pushAll:1,$addToSet:1,$set:1},numberOps={$pop:1,$unset:1,$inc:1};Query.prototype.update=function(t,n){this.op="update";this._updateArg=t;var r=this.model,i=this._optionsForExec(r),s="function"==typeof n,o,u;o=castQuery(this);if(o instanceof Error){if(s){process.nextTick(n.bind(null,o));return this}throw o}u=castDoc(this);if(!u){s&&process.nextTick(n.bind(null,null,0));return this}if(u instanceof Error){if(s){process.nextTick(n.bind(null,u));return this}throw u}s||delete i.safe;r.collection.update(o,u,i,tick(n));return this};Query.prototype._castUpdate=function(t){var n=Object.keys(t),r=n.length,i={},s,o;while(r--){var u=n[r];if("$"!==u[0]){i.$set||(t.$set?i.$set=t.$set:i.$set={});i.$set[u]=t[u];n.splice(r,1);~n.indexOf("$set")||n.push("$set")}else"$set"===u?i.$set||(i[u]=t[u]):i[u]=t[u]}r=n.length;while(r--){u=n[r];o=i[u];if("Object"!==o.constructor.name){var a="Invalid atomic update value for "+u+". "+"Expected an object, received "+typeof o;throw new Error(a)}s|=this._walkUpdatePath(o,u)}return s&&i};Query.prototype._walkUpdatePath=function(t,n,r){var i=this.model.schema.options.strict,s=r?r+".":"",o=Object.keys(t),u=o.length,a=!1,f,l,c;while(u--){l=o[u];c=t[l];if(c&&"Object"===c.constructor.name){f=this._getSchema(s+l);if(f&&f.caster&&n in castOps)if(i&&!f){if("throw"==i)throw new Error("Field `"+l+"` is not in schema.");delete t[l]}else{a=!0;"$each"in c?t[l]={$each:this._castUpdateVal(f,c.$each,n)}:t[l]=this._castUpdateVal(f,c,n)}else a|=this._walkUpdatePath(c,n,s+l)}else{f="$each"===l?this._getSchema(r):this._getSchema(s+l);var h=i&&!f&&!/real|nested/.test(this.model.schema.pathType(s+l));if(h){if("throw"==i)throw new Error("Field `"+s+l+"` is not in schema.");delete t[l]}else{a=!0;t[l]=this._castUpdateVal(f,c,n,l)}}}return a};Query.prototype._castUpdateVal=function(t,n,r,i){if(!t)return r in numberOps?Number(n):n;if(t.caster&&r in castOps&&("Object"===n.constructor.name||Array.isArray(n))){var s=t.cast(n);Array.isArray(n)?n=s:n=s[0]}return r in numberOps?Number(n):/^\$/.test(i)?t.castForQuery(i,n):t.castForQuery(n)};Query.prototype._getSchema=function(t){var n=this.model.schema,r=n.path(t);return r?r:function i(e,t){var n=e.length+1,r,s;while(n--){s=e.slice(0,n).join(".");r=t.path(s);if(r){if(r.caster){if(r.caster instanceof Types.Mixed)return r.caster;if(n!==e.length)return"$"===e[n]?i(e.slice(n+1),r.schema):i(e.slice(n),r.schema)}return r}}}(t.split("."),n)};Query.prototype.remove=function(e){this.op="remove";var t=this.model,n=this._optionsForExec(t),r="function"==typeof e;try{this.cast(t)}catch(i){if(r)return e(i);throw i}r||delete n.safe;var s=this._conditions;t.collection.remove(s,n,tick(e));return this};Query.prototype.findOneAndUpdate=function(e,t,n,r){this.op="findOneAndUpdate";switch(arguments.length){case 3:"function"==typeof n&&(r=n,n={});break;case 2:if("function"==typeof t){r=t;t=e;e=undefined}n=undefined;break;case 1:if("function"==typeof e){r=e;e=n=t=undefined}else{t=e;e=n=undefined}}e&&("Object"===e.constructor.name?merge(this._conditions,e):e instanceof Query?merge(this._conditions,e._conditions):e instanceof Document&&merge(this._conditions,e.toObject()));t&&merge(this._updateArg,t);n&&this.setOptions(n);return r?this._findAndModify("update",r):this};Query.prototype.findOneAndRemove=function(e,t,n){this.op="findOneAndRemove";if("function"==typeof t){n=t;t=undefined}else if("function"==typeof e){n=e;e=undefined}e&&("Object"===e.constructor.name?merge(this._conditions,e):e instanceof Query?merge(this._conditions,e._conditions):e instanceof Document&&merge(this._conditions,e.toObject()));t&&this.setOptions(t);return n?this._findAndModify("remove",n):this};Query.prototype._findAndModify=function(e,t){var n=this.model,r=new Promise(t),i=this,s,o,u,a,f;s=castQuery(this);if(s instanceof Error){process.nextTick(r.error.bind(r,s));return r}f=this._optionsForExec(n);if("remove"==e)f.remove=!0;else{"new"in f||(f.new=!0);"upsert"in f||(f.upsert=!1);o=castDoc(this);if(!o){if(!f.upsert)return this.findOne(t);o={$set:{}}}else if(o instanceof Error){process.nextTick(r.error.bind(r,o));return r}}this._fields&&(u=utils.clone(f.fields=this._fields));a=f.sort||[];n.collection.findAndModify(s,a,o,f,tick(function(e,t){if(e)return r.error(e);if(!t)return r.complete(null);if(!0===f.lean)return r.complete(t);var s=new n(undefined,u,!0);s.init(t,i,function(e){if(e)return r.error(e);r.complete(s)})}));return r};Query.prototype.populate=function(e,t,n,r,i){if("string"!=typeof n){i=r;r=n;n=undefined}this.options.populate[e]=new PopulateOptions(t,r,i,n);return this};PopulateOptions.prototype.constructor=Object;Query.prototype.stream=function(){return new QueryStream(this)};module.exports=Query;module.exports.QueryStream=QueryStream;