/*!
 * Module dependencies.
 */function Document(e,t,n){this._events||(this._events={});this.setMaxListeners(0);if("boolean"==typeof t){this._strictMode=t;this._selected=t=undefined}else{this._strictMode=this.schema.options&&this.schema.options.strict;this._selected=t}this.isNew=!0;this.errors=undefined;this._shardval=undefined;this._saveError=undefined;this._validationError=undefined;this._adhocPaths=undefined;this._removing=undefined;this._inserting=undefined;this.__version=undefined;this.__getters={};this.__id=undefined;this._activePaths=new ActiveRoster;var r=this.schema.requiredPaths();for(var i=0;i<r.length;++i)this._activePaths.require(r[i]);this._doc=this._buildDoc(e,t,n);e&&this.set(e,undefined,!0);this._registerHooks()}function init(e,t,n,r){r=r||"";var i=Object.keys(t),s=i.length,o,u,a;while(s--){a=i[s];u=r+a;o=e.schema.path(u);if(!o&&t[a]&&"Object"===t[a].constructor.name){n[a]||(n[a]={});init(e,t[a],n[a],u+".")}else{t[a]===null?n[a]=null:t[a]!==undefined&&(o?e.try(function(){n[a]=o.cast(t[a],e,!0)}):n[a]=t[a]);e._activePaths.init(u)}}}function compile(e,t,n){var r=Object.keys(e),i=r.length,s,o;while(i--){o=r[i];s=e[o];define(o,"Object"===s.constructor.name&&Object.keys(s).length&&(!s.type||s.type.type)?s:null,t,n,r)}}function define(e,t,n,r,i){var r=r||"",s=(r?r+".":"")+e;t?Object.defineProperty(n,e,{enumerable:!0,get:function(){this.__getters||(this.__getters={});if(!this.__getters[s]){var e=Object.create(this);r||(e._scope=this);var n=0,o=i.length;for(;n<o;++n)Object.defineProperty(e,i[n],{enumerable:!1,writable:!0,configurable:!0,value:undefined});e.toObject=function(){return this.get(s)};compile(t,e,s);this.__getters[s]=e}return this.__getters[s]},set:function(e){return this.set(s,e)}}):Object.defineProperty(n,e,{enumerable:!0,get:function(){return this.get.call(this._scope||this,s)},set:function(e){return this.set.call(this._scope||this,s,e)}})}function applyGetters(e,t,n,r){var i=e.schema,s=Object.keys(i[n]),o=s.length,u;while(o--){u=s[o];var a=u.split("."),f=a.length,l=f-1,c=t,h;for(var p=0;p<f;++p){h=a[p];p===l?c[h]=clone(e.get(u),r):c=c[h]||(c[h]={})}}return t}var EventEmitter=require("events").EventEmitter,MongooseError=require("./error"),MixedSchema=require("./schema/mixed"),Schema=require("./schema"),ValidatorError=require("./schematype").ValidatorError,utils=require("./utils"),clone=utils.clone,isMongooseObject=utils.isMongooseObject,inspect=require("util").inspect,StateMachine=require("./statemachine"),ActiveRoster=StateMachine.ctor("require","modify","init","default"),ValidationError=require("./errors/validation"),DocumentError=require("./errors/document"),deepEqual=utils.deepEqual,hooks=require("hooks"),DocumentArray;Document.prototype.__proto__=EventEmitter.prototype;Document.prototype.schema;Document.prototype.isNew;Document.prototype.id;Document.prototype.errors;Document.prototype._buildDoc=function(e,t,n){var r={},i=this,s,o,u,a;if(t&&"Object"===t.constructor.name){o=Object.keys(t);a=o.length;while(a--)if("_id"!==o[a]){s=0===t[o[a]];break}}var f=Object.keys(this.schema.paths),l=f.length,c=0;for(;c<l;++c){var h=f[c];if("_id"==h){if(n)continue;if(e&&"_id"in e)continue}var p=this.schema.paths[h],d=h.split("."),v=d.length,m=v-1,g=r,y=0;for(;y<v;++y){var b=d[y],w;if(y===m)if(t){if(s){if(h in t)continue;w=p.getDefault(i,!0);if("undefined"!=typeof w){g[b]=w;i._activePaths.default(h)}}else if(h in t){w=p.getDefault(i,!0);if("undefined"!=typeof w){g[b]=w;i._activePaths.default(h)}}}else{w=p.getDefault(i,!0);if("undefined"!=typeof w){g[b]=w;i._activePaths.default(h)}}else g=g[b]||(g[b]={})}}return r};Document.prototype.init=function(e,t){this.isNew=!1;init(this,e,this._doc);this._storeShard();this.emit("init");t&&t(null);return this};Document.prototype._storeShard=function(){var t=this.schema.options.shardKey||this.schema.options.shardkey;if(!t||"Object"!=t.constructor.name)return;var n=this._shardval={},r=Object.keys(t),i=r.length,s;for(var o=0;o<i;++o){s=this.getValue(r[o]);isMongooseObject(s)?n[r[o]]=s.toObject({depopulate:!0}):null!=s&&s.valueOf?n[r[o]]=s.valueOf():n[r[o]]=s}};for(var k in hooks)Document.prototype[k]=Document[k]=hooks[k];Document.prototype.update=function(){var t=utils.args(arguments);t.unshift({_id:this._id});this.constructor.update.apply(this.constructor,t)};Document.prototype.set=function(e,t,n){var r=!0===n,i=n&&!0!==n,s;if(i){s=this._adhocPaths||(this._adhocPaths={});s[e]=Schema.interpretAsType(e,n)}if("string"!=typeof e){if(null!==e&&undefined!==e){var u=t?t+".":"";e instanceof Document&&(e=e._doc);var a=Object.keys(e),f=a.length,l,c;while(f--){c=a[f];if(null==e[c]||"Object"!==e[c].constructor.name||this._path(u+c)instanceof MixedSchema)if(this._strictMode){l=this.schema.pathType(u+c);if("real"===l||"virtual"===l)this.set(u+c,e[c],r);else if("throw"==this._strictMode)throw new Error("Field `"+c+"` is not in schema.")}else undefined!==e[c]&&this.set(u+c,e[c],r);else this.set(e[c],u+c,r)}return this}var o=e;e=t;t=o}var h=this.schema.pathType(e);if("nested"==h&&t&&"Object"==t.constructor.name){this.setValue(e,null);this.set(t,e,r);return this}var p;if("adhocOrUndefined"==h&&this._strictMode)return this;if("virtual"==h){p=this.schema.virtualpath(e);p.applySetters(t,this);return this}p=this._path(e);var d=e.split("."),v;if(d.length<=1)v=e;else{for(var f=0;f<d.length;++f){var m=d[f],g=d.slice(0,f).concat(m).join(".");if(this.isDirectModified(g)||this.get(g)===null){v=g;break}}v||(v=e)}if(!p||null===t||undefined===t){this._set(v,e,r,d,p,t);return this}var y=this,b=r?undefined:this.get(e),w=this.try(function(){t=p.applySetters(t,y,!1,b)});w&&this._set(v,e,r,d,p,t,b);return this};Document.prototype._set=function(e,t,n,r,i,s,o){if(this.isNew)this.markModified(e);else{o||(o=this.get(t));this.isDirectModified(e)||(undefined===s&&!this.isSelected(t)?this.markModified(e,o):undefined===s&&t in this._activePaths.states.default||(deepEqual(s,o)?!n&&null!=s&&t in this._activePaths.states.default&&deepEqual(s,i.getDefault(this,n))&&this.markModified(e,o):this.markModified(e,o)))}var u=this._doc,a=0,f=r.length;for(;a<f;a++){var l=a+1,c=l===f;c?u[r[a]]=s:u[r[a]]&&"Object"===u[r[a]].constructor.name?u=u[r[a]]:u[r[a]]&&Array.isArray(u[r[a]])?u=u[r[a]]:u=u[r[a]]={}}};Document.prototype.getValue=function(e){var t=e.split("."),n=this._doc,r;for(var i=0,s=t.length;i<s;i++){r=t[i];n=n.getValue?n.getValue(r):n[r];if(!n)return n}return n};Document.prototype.setValue=function(e,t){var n=e.split("."),r=this._doc;for(var i=0,s=n.length-1;i<s;i++)r=r[n[i]];r[n[s]]=t;return this};Document.prototype.get=function(e,t){var n;if(t){n=this._adhocPaths||(this._adhocPaths={});n[e]=Schema.interpretAsType(e,t)}var r=this._path(e)||this.schema.virtualpath(e),i=e.split("."),s=this._doc;for(var o=0,u=i.length;o<u;o++)s=null==s?null:s[i[o]];r&&(s=r.applyGetters(s,this));return s};Document.prototype._path=function(e){var t=this._adhocPaths,n=t&&t[e];return n?n:this.schema.path(e)};Document.prototype.markModified=function(e){this._activePaths.modify(e)};Document.prototype.try=function(e,t){var n;try{e.call(t);n=!0}catch(r){this._error(r);n=!1}return n};Document.prototype.modifiedPaths=function(){var e=Object.keys(this._activePaths.states.modify);return e.reduce(function(e,t){var n=t.split(".");return e.concat(n.reduce(function(e,t,r){return e.concat(n.slice(0,r).concat(t).join("."))},[]))},[])};Document.prototype.isModified=function(e){return e?!!~this.modifiedPaths().indexOf(e):this._activePaths.some("modify")};Document.prototype.isDirectModified=function(e){return e in this._activePaths.states.modify};Document.prototype.isInit=function(e){return e in this._activePaths.states.init};Document.prototype.isSelected=function(t){if(this._selected){if("_id"===t)return 0!==this._selected._id;var n=Object.keys(this._selected),r=n.length,i=!1,s;if(1===r&&"_id"===n[0])return 0===this._selected._id;while(r--){s=n[r];if("_id"==s)continue;i=!!this._selected[s];break}if(t in this._selected)return i;r=n.length;var o=t+".";while(r--){s=n[r];if("_id"==s)continue;if(0===s.indexOf(o))return i;if(0===o.indexOf(s))return i}return!i}return!0};Document.prototype.validate=function(e){function s(e){if(r[e])return;r[e]=!0;i++;process.nextTick(function(){var n=t.schema.path(e);if(!n)return--i||o();n.doValidate(t.getValue(e),function(n){n&&t.invalidate(e,n,!0);--i||o()},t)})}function o(){var n=t._validationError;t._validationError=undefined;e(n)}var t=this,n=Object.keys(this._activePaths.states.require).filter(function(e){return!t.isSelected(e)&&!t.isModified(e)?!1:!0});n=n.concat(Object.keys(this._activePaths.states.init));n=n.concat(Object.keys(this._activePaths.states.modify));if(0===n.length){o();return this}var r={},i=0;n.forEach(s);return this};Document.prototype.invalidate=function(e,t){this._validationError||(this._validationError=new ValidationError(this));if(!t||"string"==typeof t)t=new ValidatorError(e,t);this._validationError.errors[e]=t};Document.prototype._reset=function(){var t=this;DocumentArray||(DocumentArray=require("./types/documentarray"));this._activePaths.map("init","modify",function(e){return t.getValue(e)}).filter(function(e){return e&&e instanceof DocumentArray&&e.length}).forEach(function(e){e.forEach(function(e){e._reset()})});this._dirty().forEach(function(e){var t=e.value;t&&t._atomics&&(t._atomics={})});this._activePaths.clear("modify");this._validationError=undefined;this.errors=undefined;var t=this;this.schema.requiredPaths().forEach(function(e){t._activePaths.require(e)});return this};Document.prototype._dirty=function(){var t=this,n=this._activePaths.map("modify",function(e){return{path:e,value:t.getValue(e),schema:t._path(e)}});n.sort(function(e,t){return e.path<t.path?-1:e.path>t.path?1:0});var r=[],i,s;n.forEach(function(e,t){if(e.path.indexOf(i)!==0){i=e.path+".";r.push(e);s=e}else{if(!e.value||!s.value)return;if(s.value._atomics&&s.value.hasAtomics()){s.value._atomics={};s.value._atomics.$set=s.value}}});s=i=null;return r};Document.prototype._setSchema=function(e){compile(e.tree,this);this.schema=e};Document.prototype._registerHooks=function(){if(!this.save)return;DocumentArray||(DocumentArray=require("./types/documentarray"));this.pre("save",function(e){var t=0,n=!1,r=this,i=this._activePaths.map("init","modify",function(e){return r.getValue(e)}).filter(function(e){return e&&e instanceof DocumentArray&&e.length});if(!i.length)return e();i.forEach(function(i){t+=i.length;i.forEach(function(i){if(n)return;i.save(function(i){if(n)return;if(i){n=!0;r._validationError=undefined;return e(i)}--t||e()})})})},function(e){if(this.constructor.listeners("error").length)this.constructor.emit("error",e);else{this.db.listeners("error").length||(e.stack="No listeners detected, throwing. Consider adding an error listener to your connection.\n"+e.stack);this.db.emit("error",e)}}).pre("save",function(t){if(this._saveError){t(this._saveError);this._saveError=null}else t()}).pre("save",function(t){return this.validate(t)});this._doQueue()};Document.prototype._error=function(e){this._saveError=e;return this};Document.prototype._doQueue=function(){var e=this.schema&&this.schema.callQueue;if(e)for(var t=0,n=e.length;t<n;t++)this[e[t][0]].apply(this,e[t][1]);return this};Document.prototype.toObject=function(e){if(!e||"Object"!=e.constructor.name)e=this.schema.options.toObject?clone(this.schema.options.toObject):{};"minimize"in e||(e.minimize=this.schema.options.minimize);var t=clone(this._doc,e);(e.virtuals||e.getters&&!1!==e.virtuals)&&applyGetters(this,t,"virtuals",e);e.getters&&applyGetters(this,t,"paths",e);return t};Document.prototype.toJSON=function(e){if(!e||"Object"!=e.constructor.name)e=this.schema.options.toJSON?clone(this.schema.options.toJSON):{};e.json=!0;return this.toObject(e)};Document.prototype.inspect=function(e){var t=e&&"Object"==e.constructor.name?e:undefined;return inspect(this.toObject(t))};Document.prototype.toString=Document.prototype.inspect;Document.prototype.equals=function(e){var t=this.get("_id"),n=e.get("_id");return t.equals?t.equals(n):t===n};Document.ValidationError=ValidationError;module.exports=exports=Document;exports.Error=DocumentError;