/*!
 * Module dependencies.
 */function Schema(e,t){if(!(this instanceof Schema))return new Schema(e,t);this.paths={};this.subpaths={};this.virtuals={};this.nested={};this.inherits={};this.callQueue=[];this._indexes=[];this.methods={};this.statics={};this.tree={};this._requiredpaths=undefined;this.options=utils.options({safe:!0,strict:!0,capped:!1,versionKey:"__v",minimize:!0,autoIndex:!0,shardKey:null,noId:!1,_id:!0,noVirtualId:!1,id:!0},t);e&&this.add(e);var n=!this.paths._id&&!this.options.noId&&this.options._id;n&&this.add({_id:{type:Schema.ObjectId,auto:!0}});var r=!this.paths.id&&!this.options.noVirtualId&&this.options.id;r&&this.virtual("id").get(idGetter)}function idGetter(){return this.__id?this.__id:this.__id=null==this._id?null:String(this._id)}function getPositionalPath(e,t){var n=t.split(/\.(\d+)\.?/).filter(Boolean);if(n.length<2)return e.paths[n[0]];var r=e.path(n[0]);if(!r)return r;var i=n.length-1,s,o=1;for(;o<n.length;++o){s=n[o];if(o===i&&r&&!r.schema&&!/\D/.test(s)&&r instanceof Types.Array){r=r.caster;continue}if(!/\D/.test(s))continue;r=r.schema.path(s)}return e.subpaths[t]=r}var EventEmitter=require("events").EventEmitter,VirtualType=require("./virtualtype"),utils=require("./utils"),NamedScope,Query,Types;Schema.prototype.__proto__=EventEmitter.prototype;Schema.prototype.paths;Schema.prototype.tree;Schema.prototype.add=function(t,n){n=n||"";for(var r in t){if(null==t[r])throw new TypeError("Invalid value for schema path `"+n+r+"`");if(t[r].constructor.name=="Object"&&(!t[r].type||t[r].type.type))if(Object.keys(t[r]).length){this.nested[n+r]=!0;this.add(t[r],n+r+".")}else this.path(n+r,t[r]);else this.path(n+r,t[r])}};Schema.reserved=Object.create(null);var reserved=Schema.reserved;reserved.on=reserved.db=reserved.init=reserved.isNew=reserved.errors=reserved.schema=reserved.options=reserved.modelName=reserved.collection=1;Schema.prototype.path=function(e,t){if(t==undefined)return this.paths[e]?this.paths[e]:this.subpaths[e]?this.subpaths[e]:/\.\d+\.?$/.test(e)?getPositionalPath(this,e):undefined;if(reserved[e])throw new Error("`"+e+"` may not be used as a schema pathname");var n=e.split(/\./),r=n.pop(),i=this.tree;n.forEach(function(e){i[e]||(i[e]={});i=i[e]});i[r]=utils.clone(t);this.paths[e]=Schema.interpretAsType(e,t);return this};Schema.interpretAsType=function(e,t){t.constructor.name!="Object"&&(t={type:t});var n=t.type&&!t.type.type?t.type:{};if("Object"==n.constructor.name||"mixed"==n)return new Types.Mixed(e,t);if(Array.isArray(n)||Array==n||"array"==n){var r=Array==n||"array"==n?t.cast:n[0];if(r instanceof Schema)return new Types.DocumentArray(e,r,t);if("string"==typeof r)r=Types[r.charAt(0).toUpperCase()+r.substring(1)];else if(r&&(!r.type||r.type.type)&&"Object"==r.constructor.name&&Object.keys(r).length)return new Types.DocumentArray(e,new Schema(r),t);return new Types.Array(e,r||Types.Mixed,t)}var i="string"==typeof n?n:n.name;i&&(i=i.charAt(0).toUpperCase()+i.substring(1));if(undefined==Types[i])throw new TypeError("Undefined type at `"+e+"`\n  Did you try nesting Schemas? "+"You can only nest using refs or arrays.");return new Types[i](e,t)};Schema.prototype.eachPath=function(e){var t=Object.keys(this.paths),n=t.length;for(var r=0;r<n;++r)e(t[r],this.paths[t[r]]);return this};Schema.prototype.requiredPaths=function(){if(this._requiredpaths)return this._requiredpaths;var t=Object.keys(this.paths),n=t.length,r=[];while(n--){var i=t[n];this.paths[i].isRequired&&r.push(i)}return this._requiredpaths=r};Schema.prototype.pathType=function(e){return e in this.paths?"real":e in this.virtuals?"virtual":e in this.nested?"nested":e in this.subpaths?"real":/\.\d+\.?/.test(e)&&getPositionalPath(this,e)?"real":"adhocOrUndefined"};Schema.prototype.queue=function(e,t){this.callQueue.push([e,t]);return this};Schema.prototype.pre=function(){return this.queue("pre",arguments)};Schema.prototype.post=function(e,t){return this.queue("on",arguments)};Schema.prototype.plugin=function(e,t){e(this,t);return this};Schema.prototype.method=function(e,t){if("string"!=typeof e)for(var n in e)this.methods[n]=e[n];else this.methods[e]=t;return this};Schema.prototype.static=function(e,t){if("string"!=typeof e)for(var n in e)this.statics[n]=e[n];else this.statics[e]=t;return this};Schema.prototype.index=function(e,t){t||(t={});t.expires&&utils.expires(t);this._indexes.push([e,t]);return this};Schema.prototype.set=function(e,t){if(arguments.length==1)return this.options[e];this.options[e]=t;return this};Schema.prototype.indexes=function(){function n(i,s){if(~t.indexOf(i))return;t.push(i);var o,u=i.paths;s=s||"";for(var a in u)if(u[a])if(u[a]instanceof Types.DocumentArray)n(u[a].schema,a+".");else{o=u[a]._index;if(o!==!1&&o!==null){var f={};f[s+a]="2d"===o?o:1;var l="Object"===o.constructor.name?o:{};"background"in l||(l.background=!0);e.push([f,l])}}if(s)r(i,s);else{i._indexes.forEach(function(e){"background"in e[1]||(e[1].background=!0)});e=e.concat(i._indexes)}}function r(t,n){var r=t._indexes,i=r.length,s,o,u,a,f,l=0,c;for(l=0;l<i;++l){s=r[l][0];a=Object.keys(s);u=a.length;o={};for(c=0;c<u;++c){f=a[c];o[n+f]=s[f]}e.push([o,r[l][1]])}}var e=[],t=[];n(this);return e};Schema.prototype.virtual=function(e,t){var n=this.virtuals,r=e.split(".");return n[e]=r.reduce(function(n,i,s){n[i]||(n[i]=s===r.length-1?new VirtualType(t,e):{});return n[i]},this.tree)};Schema.prototype.virtualpath=function(e){return this.virtuals[e]};Schema.prototype.namedScope=function(e,t){var n=this.namedScopes||(this.namedScopes=new NamedScope),r=Object.create(n),i=n.scopesByName||(n.scopesByName={});i[e]=r;r.name=e;r.block=t;r.query=new Query;r.decorate(n,{block0:function(e){return function(){e.call(this.query);return this}},blockN:function(e){return function(){e.apply(this.query,arguments);return this}},basic:function(e){return function(){this.query.find(e);return this}}});return r};module.exports=exports=Schema;Schema.Types=require("./schema/index");Types=Schema.Types;NamedScope=require("./namedscope");Query=require("./query");var ObjectId=exports.ObjectId=Types.ObjectId;