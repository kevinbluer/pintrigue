/**
 * Test dependencies.
 */var start=require("./common"),assert=require("assert"),mongoose=start.mongoose,utils=require("../lib/utils"),random=utils.random,Query=require("../lib/query"),Schema=mongoose.Schema,SchemaType=mongoose.SchemaType,CastError=SchemaType.CastError,ObjectId=Schema.ObjectId,MongooseBuffer=mongoose.Types.Buffer,DocumentObjectId=mongoose.Types.ObjectId,fs=require("fs"),names="Aaden Aaron Adrian Aditya Agustin Jim Bob Jonah Frank Sally Lucy".split(" "),Person=new Schema({name:String});mongoose.model("PersonForStream",Person);var collection="personforstream_"+random();describe("cursor stream:",function(){before(function(e){var t=start(),n=t.model("PersonForStream",collection),r=names.map(function(e){return{name:e}});n.create(r,function(n){assert.ifError(n);t.close();e()})});it("works",function(e){function f(){t.close();assert.strictEqual(undefined,u);assert.equal(r,names.length);assert.equal(1,i);assert.equal(1,s);assert.equal(1,o);assert.equal(!0,a._cursor.isClosed());e()}var t=start(),n=t.model("PersonForStream",collection),r=0,i=0,s=0,o=0,u,a=n.find({}).stream();a.on("data",function(e){assert.strictEqual(!0,!!e.name);assert.strictEqual(!0,!!e._id);if(s>0&&0===o){u=new Error("data emitted during pause");return f()}if(++r===3){assert.equal(!1,a.paused);a.pause();assert.equal(!0,a.paused);s++;setTimeout(function(){assert.equal(!0,a.paused);o++;a.resume();assert.equal(!1,a.paused)},20)}});a.on("error",function(e){u=e;f()});a.on("close",function(){i++;f()})});it("immediately destroying a stream prevents the query from executing",function(e){function s(n){assert.ifError(n);assert.equal(0,r);process.nextTick(function(){t.close();assert.strictEqual(null,i._fields);e()})}var t=start(),n=t.model("PersonForStream",collection),r=0,i=n.where("name","Jonah").select("name").findOne().stream();i.on("data",function(){r++});i.on("close",s);i.on("error",s);i.destroy()});it("destroying a stream stops it",function(e){function o(n){++r;setTimeout(function(){t.close();assert.strictEqual(undefined,n);assert.equal(5,i);assert.equal(1,r);assert.equal(!0,s._destroyed);assert.equal(!1,s.readable);assert.equal(!0,s._cursor.isClosed());e()},100)}var t=start(),n=t.model("PersonForStream",collection),r=0,i=0,s=n.where("name").exists().limit(10).select("_id").stream();assert.strictEqual(null,s._destroyed);assert.equal(!0,s.readable);s.on("data",function(e){assert.strictEqual(undefined,e.name);if(++i===5){s.destroy();assert.equal(!1,s.readable)}});s.on("close",o);s.on("error",o)});it("errors",function(e){function u(t){++r;setTimeout(function(){assert.equal("no open connections",t.message);assert.equal(s,5);assert.equal(1,i);assert.equal(1,r);assert.equal(o._destroyed,!0);assert.equal(o.readable,!1);assert.equal(o._cursor.isClosed(),!0);e()},100)}var t=start({server:{auto_reconnect:!1}}),n=t.model("PersonForStream",collection),r=0,i=0,s=0,o=n.find().batchSize(5).stream();o.on("data",function(e){++s===5&&t.close()});o.on("close",function(){i++});o.on("error",u)});it("pipe",function(e){function o(n){t.close();assert.ifError(n);var i=fs.readFileSync(r,"utf8");assert.ok(/Aaden/.test(i));assert.ok(/Aaron/.test(i));assert.ok(/Adrian/.test(i));assert.ok(/Aditya/.test(i));assert.ok(/Agustin/.test(i));fs.unlink(r);e()}var t=start(),n=t.model("PersonForStream",collection),r="/tmp/_mongoose_stream_out.txt",i=fs.createWriteStream(r),s=n.find().sort("name").limit(20).stream();s.pipe(i);s.on("error",o);s.on("close",o)});it("lean",function(e){function u(){t.close();assert.strictEqual(undefined,s);assert.equal(r,names.length);assert.equal(1,i);assert.equal(!0,o._cursor.isClosed());e()}var t=start(),n=t.model("PersonForStream",collection),r=0,i=0,s,o=n.find({}).lean().stream();o.on("data",function(e){assert.strictEqual(!1,e instanceof mongoose.Document);r++});o.on("error",function(e){s=e;u()});o.on("close",function(){i++;u()})})});