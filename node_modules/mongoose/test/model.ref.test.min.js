/**
 * Test dependencies.
 */var start=require("./common"),assert=require("assert"),mongoose=start.mongoose,random=require("../lib/utils").random,Schema=mongoose.Schema,ObjectId=Schema.ObjectId,DocObjectId=mongoose.Types.ObjectId,User=new Schema({name:String,email:String,gender:{type:String,"enum":["male","female"],"default":"male"},age:{type:Number,"default":21},blogposts:[{type:ObjectId,ref:"RefBlogPost"}]}),Comment=new Schema({asers:[{type:ObjectId,ref:"RefUser"}],_creator:{type:ObjectId,ref:"RefUser"},content:String}),BlogPost=new Schema({_creator:{type:ObjectId,ref:"RefUser"},title:String,comments:[Comment],fans:[{type:ObjectId,ref:"RefUser"}]}),posts="blogposts_"+random(),users="users_"+random();mongoose.model("RefBlogPost",BlogPost);mongoose.model("RefUser",User);mongoose.model("RefAlternateUser",User);describe("model: ref:",function(){it("populating a single ref",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"Guillermo",email:"rauchg@gmail.com"},function(i,s){assert.ifError(i);n.create({title:"woot",_creator:s},function(i,s){assert.ifError(i);n.findById(s._id).populate("_creator").exec(function(n,i){t.close();assert.ifError(n);assert.ok(i._creator instanceof r);assert.equal(i._creator.name,"Guillermo");assert.equal(i._creator.email,"rauchg@gmail.com");e()})})})});it("an error in single ref population propagates",function(e){var t=start(),n=t.model("RefBlogPost",posts+"1"),r=t.model("RefUser",users+"1");r.create({name:"Guillermo",email:"rauchg@gmail.com"},function(i,s){assert.ifError(i);n.create({title:"woot",_creator:s},function(i,s){assert.ifError(i);var o=r.findOne;r.findOne=function(){var e=Array.prototype.map.call(arguments,function(e){return"function"==typeof e?function(){e(new Error("woot"))}:e});return o.apply(this,e)};n.findById(s._id).populate("_creator").exec(function(n,r){t.close();assert.ok(n instanceof Error);assert.equal("woot",n.message);e()})})})});it("populating with partial fields selection",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"Guillermo",email:"rauchg@gmail.com"},function(i,s){assert.ifError(i);n.create({title:"woot",_creator:s},function(i,s){assert.ifError(i);n.findById(s._id).populate("_creator","email").exec(function(n,i){t.close();assert.ifError(n);assert.ok(i._creator instanceof r);assert.equal(!1,i._creator.isInit("name"));assert.equal(i._creator.email,"rauchg@gmail.com");e()})})})});it("population of single oid with partial field selection and filter",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"Banana",email:"cats@example.com"},function(i,s){assert.ifError(i);n.create({title:"woot",_creator:s},function(i,s){assert.ifError(i);n.findById(s._id).populate("_creator","email",{name:"Peanut"}).exec(function(i,s){assert.ifError(i);assert.strictEqual(s._creator,null);n.findById(s._id).populate("_creator","email",{name:"Banana"}).exec(function(n,i){t.close();assert.ifError(n);assert.ok(i._creator instanceof r);assert.equal(!1,i._creator.isInit("name"));assert.equal(i._creator.email,"cats@example.com");e()})})})})});it("population and changing a reference",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"Guillermo",email:"rauchg@gmail.com"},function(i,s){assert.ifError(i);n.create({title:"woot",_creator:s},function(i,s){assert.ifError(i);n.findById(s._id).populate("_creator").exec(function(i,s){assert.ifError(i);assert.ok(s._creator instanceof r);assert.equal(s._creator.name,"Guillermo");assert.equal(s._creator.email,"rauchg@gmail.com");r.create({name:"Aaron",email:"aaron.heckmann@10gen.com"},function(r,i){assert.ifError(r);s._creator=i._id;s.save(function(r){assert.ifError(r);n.findById(s._id).populate("_creator").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r._creator.name,"Aaron");assert.equal(r._creator.email,"aaron.heckmann@10gen.com");e()})})})})})})});it("populating with partial fields selection and changing ref",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"Guillermo",email:"rauchg@gmail.com"},function(i,s){assert.ifError(i);n.create({title:"woot",_creator:s},function(i,s){assert.ifError(i);n.findById(s._id).populate("_creator",{name:1}).exec(function(i,s){assert.ifError(i);assert.ok(s._creator instanceof r);assert.equal(s._creator.name,"Guillermo");r.create({name:"Aaron",email:"aaron@learnboost.com"},function(r,i){assert.ifError(r);s._creator=i._id;s.save(function(r){assert.ifError(r);n.findById(s._id).populate("_creator","-email").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r._creator.name,"Aaron");assert.ok(!r._creator.email);e()})})})})})})});it("populating an array of refs and fetching many",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"Fan 1",email:"fan1@learnboost.com"},function(i,s){assert.ifError(i);r.create({name:"Fan 2",email:"fan2@learnboost.com"},function(r,i){assert.ifError(r);n.create({title:"Woot",fans:[s,i]},function(r,o){assert.ifError(r);n.create({title:"Woot",fans:[i,s]},function(r,i){assert.ifError(r);n.find({_id:{$in:[o._id,i._id]}}).populate("fans").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r[0].fans[0].name,"Fan 1");assert.equal(r[0].fans[0].email,"fan1@learnboost.com");assert.equal(r[0].fans[1].name,"Fan 2");assert.equal(r[0].fans[1].email,"fan2@learnboost.com");assert.equal(r[1].fans[0].name,"Fan 2");assert.equal(r[1].fans[0].email,"fan2@learnboost.com");assert.equal(r[1].fans[1].name,"Fan 1");assert.equal(r[1].fans[1].email,"fan1@learnboost.com");e()})})})})})});it("an error in array reference population propagates",function(e){var t=start(),n=t.model("RefBlogPost",posts+"2"),r=t.model("RefUser",users+"2");r.create({name:"Fan 1",email:"fan1@learnboost.com"},function(i,s){assert.ifError(i);r.create({name:"Fan 2",email:"fan2@learnboost.com"},function(i,o){assert.ifError(i);n.create({title:"Woot",fans:[s,o]},function(i,u){assert.ifError(i);n.create({title:"Woot",fans:[o,s]},function(i,s){assert.ifError(i);var o=r.find;r.find=function(){var e=Array.prototype.map.call(arguments,function(e){return"function"==typeof e?function(){e(new Error("woot 2"))}:e});return o.apply(this,e)};n.find({$or:[{_id:u._id},{_id:s._id}]}).populate("fans").exec(function(n,r){t.close();assert.ok(n instanceof Error);assert.equal(n.message,"woot 2");e()})})})})})});it("populating an array of references with fields selection",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"Fan 1",email:"fan1@learnboost.com"},function(i,s){assert.ifError(i);r.create({name:"Fan 2",email:"fan2@learnboost.com"},function(r,i){assert.ifError(r);n.create({title:"Woot",fans:[s,i]},function(r,o){assert.ifError(r);n.create({title:"Woot",fans:[i,s]},function(r,i){assert.ifError(r);n.find({_id:{$in:[o._id,i._id]}}).populate("fans","name").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r[0].fans[0].name,"Fan 1");assert.equal(r[0].fans[0].isInit("email"),!1);assert.equal(r[0].fans[1].name,"Fan 2");assert.equal(r[0].fans[1].isInit("email"),!1);assert.strictEqual(r[0].fans[1].email,undefined);assert.equal(r[1].fans[0].name,"Fan 2");assert.equal(r[1].fans[0].isInit("email"),!1);assert.equal(r[1].fans[1].name,"Fan 1");assert.equal(r[1].fans[1].isInit("email"),!1);e()})})})})})});it("populating an array of references and filtering",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"Fan 1",email:"fan1@learnboost.com"},function(i,s){assert.ifError(i);r.create({name:"Fan 2",email:"fan2@learnboost.com",gender:"female"},function(i,o){assert.ifError(i);r.create({name:"Fan 3",email:"fan3@learnboost.com",gender:"female"},function(r,i){assert.ifError(r);n.create({title:"Woot",fans:[s,o,i]},function(r,u){assert.ifError(r);n.create({title:"Woot",fans:[i,o,s]},function(r,i){assert.ifError(r);n.find({_id:{$in:[u._id,i._id]}}).populate("fans","",{gender:"female",_id:{$in:[o]}}).exec(function(r,s){assert.ifError(r);assert.equal(s[0].fans.length,1);assert.equal(s[0].fans[0].gender,"female");assert.equal(s[0].fans[0].name,"Fan 2");assert.equal(s[0].fans[0].email,"fan2@learnboost.com");assert.equal(s[1].fans.length,1);assert.equal(s[1].fans[0].gender,"female");assert.equal(s[1].fans[0].name,"Fan 2");assert.equal(s[1].fans[0].email,"fan2@learnboost.com");n.find({_id:{$in:[u._id,i._id]}}).populate("fans",!1,{gender:"female"}).exec(function(n,r){t.close();assert.ifError(n);assert.strictEqual(r[0].fans.length,2);assert.equal(r[0].fans[0].gender,"female");assert.equal(r[0].fans[0].name,"Fan 2");assert.equal(r[0].fans[0].email,"fan2@learnboost.com");assert.equal(r[0].fans[1].gender,"female");assert.equal(r[0].fans[1].name,"Fan 3");assert.equal(r[0].fans[1].email,"fan3@learnboost.com");assert.strictEqual(r[1].fans.length,2);assert.equal(r[1].fans[0].gender,"female");assert.equal(r[1].fans[0].name,"Fan 3");assert.equal(r[1].fans[0].email,"fan3@learnboost.com");assert.equal(r[1].fans[1].gender,"female");assert.equal(r[1].fans[1].name,"Fan 2");assert.equal(r[1].fans[1].email,"fan2@learnboost.com");e()})})})})})})})});it("populating an array of references and multi-filtering",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"Fan 1",email:"fan1@learnboost.com"},function(i,s){assert.ifError(i);r.create({name:"Fan 2",email:"fan2@learnboost.com",gender:"female"},function(i,o){assert.ifError(i);r.create({name:"Fan 3",email:"fan3@learnboost.com",gender:"female",age:25},function(r,i){assert.ifError(r);n.create({title:"Woot",fans:[s,o,i]},function(r,u){assert.ifError(r);n.create({title:"Woot",fans:[i,o,s]},function(r,s){assert.ifError(r);n.find({_id:{$in:[u._id,s._id]}}).populate("fans",undefined,{_id:i}).exec(function(r,i){assert.ifError(r);assert.equal(i[0].fans.length,1);assert.equal(i[0].fans[0].gender,"female");assert.equal(i[0].fans[0].name,"Fan 3");assert.equal(i[0].fans[0].email,"fan3@learnboost.com");assert.equal(i[0].fans[0].age,25);assert.equal(i[1].fans.length,1);assert.equal(i[1].fans[0].gender,"female");assert.equal(i[1].fans[0].name,"Fan 3");assert.equal(i[1].fans[0].email,"fan3@learnboost.com");assert.equal(i[1].fans[0].age,25);n.find({_id:{$in:[u._id,s._id]}}).populate("fans",0,{gender:"female"}).exec(function(n,r){t.close();assert.ifError(n);assert.equal(r[0].fans.length,2);assert.equal(r[0].fans[0].gender,"female");assert.equal(r[0].fans[0].name,"Fan 2");assert.equal(r[0].fans[0].email,"fan2@learnboost.com");assert.equal(r[0].fans[1].gender,"female");assert.equal(r[0].fans[1].name,"Fan 3");assert.equal(r[0].fans[1].email,"fan3@learnboost.com");assert.equal(r[0].fans[1].age,25);assert.equal(r[1].fans.length,2);assert.equal(r[1].fans[0].gender,"female");assert.equal(r[1].fans[0].name,"Fan 3");assert.equal(r[1].fans[0].email,"fan3@learnboost.com");assert.equal(r[1].fans[0].age,25);assert.equal(r[1].fans[1].gender,"female");assert.equal(r[1].fans[1].name,"Fan 2");assert.equal(r[1].fans[1].email,"fan2@learnboost.com");e()})})})})})})})});it("populating an array of references and multi-filtering with field selection",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"Fan 1",email:"fan1@learnboost.com"},function(i,s){assert.ifError(i);r.create({name:"Fan 2",email:"fan2@learnboost.com",gender:"female"},function(i,o){assert.ifError(i);r.create({name:"Fan 3",email:"fan3@learnboost.com",gender:"female",age:25},function(r,i){assert.ifError(r);n.create({title:"Woot",fans:[s,o,i]},function(r,u){assert.ifError(r);n.create({title:"Woot",fans:[i,o,s]},function(r,i){assert.ifError(r);n.find({_id:{$in:[u._id,i._id]}}).populate("fans","name email",{gender:"female",age:25}).exec(function(n,r){t.close();assert.ifError(n);assert.strictEqual(r[0].fans.length,1);assert.equal(r[0].fans[0].name,"Fan 3");assert.equal(r[0].fans[0].email,"fan3@learnboost.com");assert.equal(r[0].fans[0].isInit("email"),!0);assert.equal(r[0].fans[0].isInit("gender"),!1);assert.equal(r[0].fans[0].isInit("age"),!1);assert.strictEqual(r[1].fans.length,1);assert.equal(r[1].fans[0].name,"Fan 3");assert.equal(r[1].fans[0].email,"fan3@learnboost.com");assert.equal(r[1].fans[0].isInit("email"),!0);assert.equal(r[1].fans[0].isInit("gender"),!1);assert.equal(r[1].fans[0].isInit("age"),!1);e()})})})})})})});it("populating an array of refs changing one and removing one",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"Fan 1",email:"fan1@learnboost.com"},{name:"Fan 2",email:"fan2@learnboost.com"},{name:"Fan 3",email:"fan3@learnboost.com"},{name:"Fan 4",email:"fan4@learnboost.com"},function(r,i,s,o,u){assert.ifError(r);n.create({title:"Woot",fans:[i,s]},{title:"Woot",fans:[s,i]},function(r,i,s){assert.ifError(r);n.find({_id:{$in:[i._id,s._id]}}).populate("fans","name").exec(function(r,i){assert.ifError(r);assert.equal(i[0].fans[0].name,"Fan 1");assert.equal(i[0].fans[0].isInit("email"),!1);assert.equal(i[0].fans[1].name,"Fan 2");assert.equal(i[0].fans[1].isInit("email"),!1);assert.equal(i[1].fans[0].name,"Fan 2");assert.equal(i[1].fans[0].isInit("email"),!1);assert.equal(i[1].fans[1].name,"Fan 1");assert.equal(i[1].fans[1].isInit("email"),!1);i[1].fans=[o,u];i[1].save(function(r){assert.ifError(r);n.findById(i[1]._id,"",{populate:["fans"]}).exec(function(r,i){assert.ifError(r);assert.equal(i.fans[0].name,"Fan 3");assert.equal(i.fans[1].name,"Fan 4");i.fans.splice(0,1);i.save(function(r){assert.ifError(r);n.findById(i._id).populate("fans").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r.fans.length,1);assert.equal(r.fans[0].name,"Fan 4");e()})})})})})})})});describe("populating sub docs",function(){it("works with findById",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"User 1"},function(i,s){assert.ifError(i);r.create({name:"User 2"},function(r,i){assert.ifError(r);n.create({title:"Woot",_creator:s._id,comments:[{_creator:s._id,content:"Woot woot"},{_creator:i._id,content:"Wha wha"}]},function(r,i){assert.ifError(r);n.findById(i._id).populate("_creator").populate("comments._creator").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r._creator.name,"User 1");assert.equal(r.comments[0]._creator.name,"User 1");assert.equal(r.comments[1]._creator.name,"User 2");e()})})})})});it("works when first doc returned has empty array for populated path (gh-1055)",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"gh-1055-1"},{name:"gh-1055-2"},function(t,r,i){assert.ifError(t);n.create({title:"gh-1055 post1",_creator:r._id,comments:[]},{title:"gh-1055 post2",_creator:r._id,comments:[{_creator:r._id,content:"Woot woot",asers:[]},{_creator:i._id,content:"Wha wha",asers:[r,i]}]},function(t,r,i){assert.ifError(t);var s=!1;n.find({title:/gh-1055/}).sort("title").select("comments").populate("comments._creator").populate("comments.asers").exec(function(t,n){assert.equal(!1,s);s=!0;assert.ifError(t);assert.ok(n.length);assert.ok(n[1].comments[0]._creator);assert.equal("gh-1055-1",n[1].comments[0]._creator.name);e()})})})})});it("populating subdocuments partially",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"User 1",email:"user1@learnboost.com"},function(i,s){assert.ifError(i);r.create({name:"User 2",email:"user2@learnboost.com"},function(r,i){assert.ifError(r);var o=n.create({title:"Woot",comments:[{_creator:s,content:"Woot woot"},{_creator:i,content:"Wha wha"}]},function(r,i){assert.ifError(r);n.findById(i._id).populate("comments._creator","email").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r.comments[0]._creator.email,"user1@learnboost.com");assert.equal(r.comments[0]._creator.isInit("name"),!1);assert.equal(r.comments[1]._creator.email,"user2@learnboost.com");assert.equal(r.comments[1]._creator.isInit("name"),!1);e()})})})})});it("populating subdocuments partially with conditions",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"User 1",email:"user1@learnboost.com"},function(i,s){assert.ifError(i);r.create({name:"User 2",email:"user2@learnboost.com"},function(r,i){assert.ifError(r);var o=n.create({title:"Woot",comments:[{_creator:s,content:"Woot woot"},{_creator:i,content:"Wha wha"}]},function(r,i){assert.ifError(r);n.findById(i._id).populate("comments._creator",{email:1},{name:/User/}).exec(function(n,r){t.close();assert.ifError(n);assert.equal(r.comments[0]._creator.email,"user1@learnboost.com");assert.equal(r.comments[0]._creator.isInit("name"),!1);assert.equal(r.comments[1]._creator.email,"user2@learnboost.com");assert.equal(r.comments[1]._creator.isInit("name"),!1);e()})})})})});it("populating subdocs with invalid/missing subproperties",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"T-100",email:"terminator100@learnboost.com"},function(i,s){assert.ifError(i);r.create({name:"T-1000",email:"terminator1000@learnboost.com"},function(r,i){assert.ifError(r);var s=n.create({title:"Woot",comments:[{_creator:null,content:"Woot woot"},{_creator:i,content:"Wha wha"}]},function(r,s){assert.ifError(r);n.findById(s._id).populate("comments._idontexist","email").exec(function(r,s){assert.ifError(r);assert.ok(s);assert.equal(s.comments.length,2);assert.strictEqual(s.comments[0]._creator,null);assert.equal(s.comments[1]._creator.toString(),i.id);n.findById(s._id).populate("comments._creator","email").exec(function(n,r){t.close();assert.ifError(n);assert.ok(r);assert.equal(r.comments.length,2);assert.strictEqual(r.comments[0]._creator,null);assert.strictEqual(r.comments[0].content,"Woot woot");assert.equal(r.comments[1]._creator.email,"terminator1000@learnboost.com");assert.equal(r.comments[1]._creator.isInit("name"),!1);assert.equal(r.comments[1].content,"Wha wha");e()})})})})})});it("populating subdocuments partially with empty array (gh-481)",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=!1,i=n.create({title:"Woot",comments:[]},function(r,i){assert.ifError(r);n.findById(i._id).populate("comments._creator","email").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r.id,i.id);e()})})});it("populating subdocuments with array including nulls",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users),i=new r({name:"hans zimmer"});i.save(function(r){assert.ifError(r);var s=n.create({title:"Woot",fans:[]},function(r,s){assert.ifError(r);n.collection.update({_id:s._id},{$set:{fans:[null,undefined,i.id,null]}},function(r){assert.ifError(r);n.findById(s._id).populate("fans","name").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r.id,s.id);assert.equal(r.fans.length,1);e()})})})})});it("populating more than one array at a time",function(e){var t=start(),n=t.model("RefUser",users),r=t.model("PopMultiSubDocs",new Schema({users:[{type:ObjectId,ref:"RefUser"}],fans:[{type:ObjectId,ref:"RefUser"}],comments:[Comment]}));n.create({email:"fan1@learnboost.com"},{name:"Fan 2",email:"fan2@learnboost.com",gender:"female"},{name:"Fan 3"},function(n,i,s,o){assert.ifError(n);r.create({users:[o],fans:[i],comments:[{_creator:i,content:"bejeah!"},{_creator:s,content:"chickfila"}]},{users:[i],fans:[s],comments:[{_creator:o,content:"hello"},{_creator:i,content:"world"}]},function(n,i,s){assert.ifError(n);r.where("_id").in([i,s]).populate("fans","name",{gender:"female"}).populate("users","name",{gender:"male"}).populate("comments._creator","email",{name:null}).exec(function(n,r){t.close();assert.ifError(n);assert.ok(r);assert.equal(r.length,2);var i=r[0],s=r[1];assert.strictEqual(i.fans.length,0);assert.strictEqual(s.fans.length,1);assert.equal(s.fans[0].name,"Fan 2");assert.equal(s.fans[0].isInit("email"),!1);assert.equal(s.fans[0].isInit("gender"),!1);assert.equal(i.comments.length,2);assert.equal(s.comments.length,2);assert.ok(i.comments[0]._creator.email);assert.ok(!s.comments[0]._creator);assert.equal(i.comments[0]._creator.email,"fan1@learnboost.com");assert.equal(s.comments[1]._creator.email,"fan1@learnboost.com");assert.equal(i.comments[0]._creator.isInit("name"),!1);assert.equal(s.comments[1]._creator.isInit("name"),!1);assert.equal(i.comments[0].content,"bejeah!");assert.equal(s.comments[1].content,"world");assert.ok(!i.comments[1]._creator);assert.ok(!s.comments[0]._creator);assert.equal(i.comments[1].content,"chickfila");assert.equal(s.comments[0].content,"hello");e()})})})});it("populating multiple children of a sub-array at a time",function(e){var t=start(),n=t.model("RefUser",users),r=t.model("RefBlogPost",posts),i=new Schema({user:{type:ObjectId,ref:"RefUser"},post:{type:ObjectId,ref:"RefBlogPost"}}),s=t.model("PopMultiChildrenOfSubDocInner",i),o=t.model("PopMultiChildrenOfSubDoc",new Schema({kids:[i]}));n.create({name:"Fan 1",email:"fan1@learnboost.com",gender:"male"},{name:"Fan 2",email:"fan2@learnboost.com",gender:"female"},function(n,i,s){assert.ifError(n);r.create({title:"woot"},{title:"yay"},function(n,r,u){assert.ifError(n);o.create({kids:[{user:i,post:r,y:5},{user:s,post:u,y:8}],x:4},function(n,r){assert.ifError(n);o.findById(r).populate("kids.user","name").populate("kids.post","title",{title:"woot"}).exec(function(n,r){t.close();assert.ifError(n);assert.strictEqual(r.kids.length,2);var i=r.kids[0],s=r.kids[1];assert.strictEqual(!0,!s.post);assert.strictEqual(i.user.name,"Fan 1");assert.strictEqual(i.user.email,undefined);assert.strictEqual(i.post.title,"woot");assert.strictEqual(s.user.name,"Fan 2");e()})})})})});it("passing sort options to the populate method",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.create({name:"aaron",age:10},{name:"fan2",age:8},{name:"someone else",age:3},function(r,i,s,o){assert.ifError(r);n.create({fans:[s,o,i]},function(r,i){assert.ifError(r);n.findById(i).populate("fans",null,null,{sort:"name"}).exec(function(r,i){assert.ifError(r);assert.equal(i.fans.length,3);assert.equal(i.fans[0].name,"aaron");assert.equal(i.fans[1].name,"fan2");assert.equal(i.fans[2].name,"someone else");n.findById(i).populate("fans","name",null,{sort:[["name",-1]]}).exec(function(r,i){assert.ifError(r);assert.equal(i.fans.length,3);assert.equal(i.fans[2].name,"aaron");assert.strictEqual(undefined,i.fans[2].age);assert.equal(i.fans[1].name,"fan2");assert.strictEqual(undefined,i.fans[1].age);assert.equal(i.fans[0].name,"someone else");assert.strictEqual(undefined,i.fans[0].age);n.findById(i).populate("fans","age",{age:{$gt:3}},{sort:[["name","desc"]]}).exec(function(n,r){t.close();assert.ifError(n);assert.equal(r.fans.length,2);assert.equal(r.fans[1].age.valueOf(),10);assert.equal(r.fans[0].age.valueOf(),8);e()})})})})})});it("refs should cast to ObjectId from hexstrings",function(){var e=mongoose.model("RefBlogPost",BlogPost),t=new e;t._creator=(new DocObjectId).toString();assert.ok(t._creator instanceof DocObjectId);t.set("_creator",(new DocObjectId).toString());assert.ok(t._creator instanceof DocObjectId)});it("populate should work on String _ids",function(e){var t=start(),n=new Schema({_id:String,name:String}),r=new Schema({author:{type:String,ref:"UserWithStringId"},body:String}),i=t.model("UserWithStringId",n,random()),s=t.model("NoteWithStringId",r,random()),o=new i({_id:"alice",name:"Alice"});o.save(function(n){assert.ifError(n);var r=new s({author:"alice",body:"Buy Milk"});r.save(function(n){assert.ifError(n);s.findById(r.id).populate("author").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r.body,"Buy Milk");assert.ok(r.author);assert.equal(r.author.name,"Alice");e()})})})});it("populate should work on Number _ids",function(e){var t=start(),n=new Schema({_id:Number,name:String}),r=new Schema({author:{type:Number,ref:"UserWithNumberId"},body:String}),i=t.model("UserWithNumberId",n,random()),s=t.model("NoteWithNumberId",r,random()),o=new i({_id:2359,name:"Alice"});o.save(function(n){assert.ifError(n);var r=new s({author:2359,body:"Buy Milk"});r.save(function(n){assert.ifError(n);s.findById(r.id).populate("author").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r.body,"Buy Milk");assert.ok(r.author);assert.equal(r.author.name,"Alice");e()})})})});it("required works on ref fields (gh-577)",function(e){function d(n){assert.strictEqual(null,n);if(--l)return;var r=new f({text:"test"});r.save(function(n){assert.equal("Validation failed",n&&n.message);assert.ok("num"in n.errors);assert.ok("str"in n.errors);assert.ok("user"in n.errors);assert.equal(n.errors.num.type,"required");assert.equal(n.errors.str.type,"required");assert.equal(n.errors.user.type,"required");r.user=p;r.num=1995;r.str="my string";r.save(function(n,r){assert.strictEqual(null,n);f.findById(r.id).populate("user").populate("num").populate("str").exec(function(n,r){assert.ifError(n);r.set({text:"test2"});r.save(function(n,r){t.close();assert.ifError(n);e()})})})})}var t=start(),n=new Schema({email:{type:String,required:!0}}),r=t.model("ObjectIdRefRequiredField",n,random()),i=new Schema({_id:Number,val:Number}),s=t.model("NumberRefRequired",i,random()),o=new Schema({_id:String,val:String}),u=t.model("StringRefRequired",o,random()),a=new Schema({user:{type:ObjectId,ref:"ObjectIdRefRequiredField",required:!0},num:{type:Number,ref:"NumberRefRequired",required:!0},str:{type:String,ref:"StringRefRequired",required:!0},text:String}),f=t.model("CommentWithRequiredField",a),l=3,c=new u({_id:"my string",val:"hello"}),h=new s({_id:1995,val:234}),p=new r({email:"test"});c.save(d);h.save(d);p.save(d)});it("populate works with schemas with both id and _id defined",function(e){var t=start(),n=new Schema({id:String}),r=new Schema({things:[{type:ObjectId,ref:"_idAndid"}]}),i=t.model("_idAndid",n),s=t.model("populateWorksWith_idAndidSchemas",r);i.create({id:"The Tiger That Isn't"},{id:"Users Guide To The Universe"},function(n,r,i){assert.ifError(n);var o=new s({things:[r,i]});o.save(function(n){assert.ifError(n);s.findById(o).populate("things").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r.things.length,2);assert.equal(r.things[0].id,"The Tiger That Isn't");assert.equal(r.things[1].id,"Users Guide To The Universe");e()})})})});it("Update works with populated arrays (gh-602)",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users),i=new r({name:"aphex"}),s=new r({name:"twin"});r.create({name:"aphex"},{name:"twin"},function(r,i,s){assert.ifError(r);var o=n.create({title:"Woot",fans:[]},function(r,o){assert.ifError(r);var u={fans:[i,s]};n.update({_id:o},u,function(r){assert.ifError(r);assert.ok("fans"in u);assert.ok(!("$set"in u));assert.ok(u.fans[0]instanceof mongoose.Document);assert.ok(u.fans[1]instanceof mongoose.Document);n.findById(o,function(n,r){t.close();assert.ifError(n);assert.equal(r.fans.length,2);assert.ok(r.fans[0]instanceof DocObjectId);assert.ok(r.fans[1]instanceof DocObjectId);e()})})})})});it("toJSON should also be called for refs (gh-675)",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefUser",users);r.prototype._toJSON=r.prototype.toJSON;r.prototype.toJSON=function(){var e=this._toJSON();e.was_in_to_json=!0;return e};n.prototype._toJSON=n.prototype.toJSON;n.prototype.toJSON=function(){var e=this._toJSON();e.was_in_to_json=!0;return e};r.create({name:"Jerem",email:"jerem@jolicloud.com"},function(r,i){assert.ifError(r);n.create({title:"Ping Pong",_creator:i},function(r,i){assert.ifError(r);n.findById(i._id).populate("_creator").exec(function(n,r){t.close();assert.ifError(n);var i=r.toJSON();assert.equal(!0,i.was_in_to_json);assert.equal(i._creator.was_in_to_json,!0);e()})})})});it("populate should work on Buffer _ids (gh-686)",function(e){var t=start(),n=new Schema({_id:Buffer,name:String}),r=new Schema({author:{type:Buffer,ref:"UserWithBufferId"},body:String}),i=t.model("UserWithBufferId",n,random()),s=t.model("NoteWithBufferId",r,random()),o=new i({_id:new mongoose.Types.Buffer("YWxpY2U=","base64"),name:"Alice"});o.save(function(n){assert.ifError(n);var r=new s({author:"alice",body:"Buy Milk"});r.save(function(n){assert.ifError(n);s.findById(r.id).populate("author").exec(function(n,r){t.close();assert.ifError(n);assert.equal(r.body,"Buy Milk");assert.ok(r.author);assert.equal(r.author.name,"Alice");e()})})})});it("populating with custom model selection (gh-773)",function(e){var t=start(),n=t.model("RefBlogPost",posts),r=t.model("RefAlternateUser",users);r.create({name:"Daniel",email:"daniel.baulig@gmx.de"},function(i,s){assert.ifError(i);n.create({title:"woot",_creator:s},function(i,s){assert.ifError(i);n.findById(s._id).populate("_creator","email","RefAlternateUser").exec(function(n,i){t.close();assert.ifError(n);assert.ok(i._creator instanceof r);assert.equal(i._creator.isInit("name"),!1);assert.equal(i._creator.email,"daniel.baulig@gmx.de");e()})})})})});