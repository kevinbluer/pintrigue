/**
 * Module dependencies.
 */var start=require("./common"),assert=require("assert"),mongoose=require("./common").mongoose,Schema=mongoose.Schema,random=require("../lib/utils").random,MongooseArray=mongoose.Types.Array,collection="avengers_"+random(),User=new Schema({name:String,pets:[Schema.ObjectId]});mongoose.model("User",User);var Pet=new Schema({name:String});mongoose.model("Pet",Pet);describe("types array",function(){it("behaves and quacks like an Array",function(){var e=new MongooseArray;assert.ok(e instanceof Array);assert.ok(e instanceof MongooseArray);assert.equal(!0,Array.isArray(e));assert.deepEqual(e._atomics.constructor,Object)});describe("hasAtomics",function(){it("does not throw",function(){var e=(new MongooseArray([12,3,4,5])).filter(Boolean),t=!1;try{e.hasAtomics}catch(n){t=!0}assert.ok(!t);var r=(new MongooseArray([67,8])).filter(Boolean);try{r.push(3,4)}catch(n){console.error(n);t=!0}assert.ok(!t)})});describe("indexOf()",function(){it("works",function(e){function l(){r.find({},function(r,a){assert.ifError(r);i.save(function(r){assert.ifError(r);n.findOne({name:"tj"},function(n,r){t.close();assert.ifError(n);assert.equal(r.pets.length,3);assert.equal(r.pets.indexOf(s.id),0);assert.equal(r.pets.indexOf(o.id),1);assert.equal(r.pets.indexOf(u.id),2);assert.equal(r.pets.indexOf(s._id),0);assert.equal(r.pets.indexOf(o._id),1);assert.equal(r.pets.indexOf(u._id),2);e()})})})}var t=start(),n=t.model("User","users_"+random()),r=t.model("Pet","pets"+random()),i=new n({name:"tj"}),s=new r({name:"tobi"}),o=new r({name:"loki"}),u=new r({name:"jane"}),a=[];i.pets.push(s);i.pets.push(o);i.pets.push(u);var f=3;[s,o,u].forEach(function(e){e.save(function(){--f||l()})})})});describe("splice()",function(){it("works",function(e){var t="splicetest-number"+random(),n=start(),r=new Schema({numbers:Array}),i=n.model("splicetestNumber",r,t),s=new i({numbers:[4,5,6,7]});s.save(function(t){assert.ifError(t);i.findById(s._id,function(t,r){assert.ifError(t);var o=r.numbers.splice(1,1);assert.deepEqual(o,[5]);assert.deepEqual(r.numbers.toObject(),[4,6,7]);r.save(function(t){assert.ifError(t);i.findById(s._id,function(t,r){assert.ifError(t);assert.deepEqual(r.numbers.toObject(),[4,6,7]);i.collection.drop(function(t){n.close();assert.ifError(t);e()})})})})})});it("on embedded docs",function(e){var t="splicetest-embeddeddocs"+random(),n=start(),r=new Schema({types:[new Schema({type:String})]}),i=n.model("splicetestEmbeddedDoc",r,t),s=new i({types:[{type:"bird"},{type:"boy"},{type:"frog"},{type:"cloud"}]});s.save(function(t){assert.ifError(t);i.findById(s._id,function(t,r){assert.ifError(t);r.types.$pop();var o=r.types.splice(1,1);assert.equal(o.length,1);assert.equal(o[0].type,"boy");var u=r.types.toObject();assert.equal(u[0].type,"bird");assert.equal(u[1].type,"frog");r.save(function(t){assert.ifError(t);i.findById(s._id,function(t,r){n.close();assert.ifError(t);var i=r.types.toObject();assert.equal(i[0].type,"bird");assert.equal(i[1].type,"frog");e()})})})})})});describe("unshift()",function(){it("works",function(e){var t=start(),n=new Schema({types:[new Schema({type:String})],nums:[Number],strs:[String]}),r=t.model("unshift",n,"unshift"+random()),i=new r({types:[{type:"bird"},{type:"boy"},{type:"frog"},{type:"cloud"}],nums:[1,2,3],strs:"one two three".split(" ")});i.save(function(n){assert.ifError(n);r.findById(i._id,function(n,s){assert.ifError(n);var o=s.types.unshift({type:"tree"}),u=s.nums.unshift(0),f=s.strs.unshift("zero");assert.equal(o,5);assert.equal(u,4);assert.equal(f,4);s.types.push({type:"worm"});var l=s.types.toObject();assert.equal(l[0].type,"tree");assert.equal(l[1].type,"bird");assert.equal(l[2].type,"boy");assert.equal(l[3].type,"frog");assert.equal(l[4].type,"cloud");assert.equal(l[5].type,"worm");l=s.nums.toObject();assert.equal(l[0].valueOf(),0);assert.equal(l[1].valueOf(),1);assert.equal(l[2].valueOf(),2);assert.equal(l[3].valueOf(),3);l=s.strs.toObject();assert.equal(l[0],"zero");assert.equal(l[1],"one");assert.equal(l[2],"two");assert.equal(l[3],"three");s.save(function(n){assert.ifError(n);r.findById(i._id,function(n,r){t.close();assert.ifError(n);var i=r.types.toObject();assert.equal(i[0].type,"tree");assert.equal(i[1].type,"bird");assert.equal(i[2].type,"boy");assert.equal(i[3].type,"frog");assert.equal(i[4].type,"cloud");assert.equal(i[5].type,"worm");i=r.nums.toObject();assert.equal(i[0].valueOf(),0);assert.equal(i[1].valueOf(),1);assert.equal(i[2].valueOf(),2);assert.equal(i[3].valueOf(),3);i=r.strs.toObject();assert.equal(i[0],"zero");assert.equal(i[1],"one");assert.equal(i[2],"two");assert.equal(i[3],"three");e()})})})})})});describe("shift()",function(){it("works",function(e){var t=start(),n=new Schema({types:[new Schema({type:String})],nums:[Number],strs:[String]}),r=t.model("shift",n,"unshift"+random()),i=new r({types:[{type:"bird"},{type:"boy"},{type:"frog"},{type:"cloud"}],nums:[1,2,3],strs:"one two three".split(" ")});i.save(function(n){assert.ifError(n);r.findById(i._id,function(n,s){assert.ifError(n);var o=s.types.shift(),u=s.nums.shift(),f=s.strs.shift();assert.equal(o.type,"bird");assert.equal(u,1);assert.equal(f,"one");var l=s.types.toObject();assert.equal(l[0].type,"boy");assert.equal(l[1].type,"frog");assert.equal(l[2].type,"cloud");s.nums.push(4);l=s.nums.toObject();assert.equal(2,l[0].valueOf());assert.equal(l[1].valueOf(),3);assert.equal(l[2].valueOf(),4);l=s.strs.toObject();assert.equal(l[0],"two");assert.equal(l[1],"three");s.save(function(n){assert.ifError(n);r.findById(i._id,function(n,r){t.close();assert.ifError(n);var i=r.types.toObject();assert.equal(i[0].type,"boy");assert.equal(i[1].type,"frog");assert.equal(i[2].type,"cloud");i=r.nums.toObject();assert.equal(i[0].valueOf(),2);assert.equal(i[1].valueOf(),3);assert.equal(i[2].valueOf(),4);i=r.strs.toObject();assert.equal(i[0],"two");assert.equal(i[1],"three");e()})})})})})});describe("$shift",function(){it("works",function(e){var t=start(),n=new Schema({colors:[]}),r=t.model("Painting",n),i=new r({colors:["blue","green","yellow"]});i.save(function(n){assert.ifError(n);r.findById(i,function(n,i){assert.ifError(n);assert.equal(3,i.colors.length);var s=i.colors.$shift();assert.equal(2,i.colors.length);assert.equal(s,"blue");s=i.colors.$shift();assert.equal(s,undefined);assert.equal(2,i.colors.length);i.save(function(n){assert.equal(null,n);var s=i.colors.$shift();assert.equal(1,i.colors.length);assert.equal(s,"green");i.save(function(n){assert.equal(null,n);r.findById(i,function(n,r){t.close();assert.ifError(n);assert.equal(1,r.colors.length);assert.equal(r.colors[0],"yellow");e()})})})})})})});describe("pop()",function(){it("works",function(e){var t=start(),n=new Schema({types:[new Schema({type:String})],nums:[Number],strs:[String]}),r=t.model("pop",n,"pop"+random()),i=new r({types:[{type:"bird"},{type:"boy"},{type:"frog"},{type:"cloud"}],nums:[1,2,3],strs:"one two three".split(" ")});i.save(function(n){assert.ifError(n);r.findById(i._id,function(n,s){assert.ifError(n);var o=s.types.pop(),u=s.nums.pop(),f=s.strs.pop();assert.equal(o.type,"cloud");assert.equal(u,3);assert.equal(f,"three");var l=s.types.toObject();assert.equal(l[0].type,"bird");assert.equal(l[1].type,"boy");assert.equal(l[2].type,"frog");s.nums.push(4);l=s.nums.toObject();assert.equal(l[0].valueOf(),1);assert.equal(l[1].valueOf(),2);assert.equal(l[2].valueOf(),4);l=s.strs.toObject();assert.equal(l[0],"one");assert.equal(l[1],"two");s.save(function(n){assert.ifError(n);r.findById(i._id,function(n,r){t.close();assert.ifError(n);var i=r.types.toObject();assert.equal(i[0].type,"bird");assert.equal(i[1].type,"boy");assert.equal(i[2].type,"frog");i=r.nums.toObject();assert.equal(i[0].valueOf(),1);assert.equal(i[1].valueOf(),2);assert.equal(i[2].valueOf(),4);i=r.strs.toObject();assert.equal(i[0],"one");assert.equal(i[1],"two");e()})})})})})});describe("pull()",function(){it("works",function(e){var t=start(),n=new Schema({name:String}),r=t.model("Cat",n),i=new Schema({a:[{type:Schema.ObjectId,ref:"Cat"}]}),s=t.model("TestPull",i),o=new r({name:"peanut"});o.save(function(n){assert.ifError(n);var r=new s({a:[o._id]});r.save(function(n){assert.ifError(n);s.findById(r,function(n,r){t.close();assert.ifError(n);assert.equal(1,r.a.length);r.a.pull(o.id);assert.equal(r.a.length,0);e()})})})})});describe("pop()",function(){it("works",function(e){var t=start(),n=new Schema({colors:[]}),r=t.model("Painting",n),i=new r({colors:["blue","green","yellow"]});i.save(function(n){assert.ifError(n);r.findById(i,function(n,i){assert.ifError(n);assert.equal(3,i.colors.length);var s=i.colors.$pop();assert.equal(2,i.colors.length);assert.equal(s,"yellow");s=i.colors.$pop();assert.equal(s,undefined);assert.equal(2,i.colors.length);assert.equal(!1,"$set"in i.colors._atomics,"invalid $atomic op used");i.save(function(n){assert.equal(null,n);var s=i.colors.$pop();assert.equal(1,i.colors.length);assert.equal(s,"green");i.save(function(n){assert.equal(null,n);r.findById(i,function(n,r){t.close();assert.strictEqual(null,n);assert.equal(1,r.colors.length);assert.equal(r.colors[0],"blue");e()})})})})})})});describe("addToSet()",function(){it("works",function(e){var t=start(),n=new Schema({name:String,arr:[]}),r=new Schema({num:[Number],str:[String],doc:[n],date:[Date],id:[Schema.ObjectId]}),i=t.model("testAddToSet",r),s=new i;s.num.push(1,2,3);s.str.push("one","two","tres");s.doc.push({name:"Dubstep",arr:[1]},{name:"Polka",arr:[{x:3}]});var o=new Date,u=new Date(+o+6e4),a=new Date(+o+3e4),f=new Date(+o+2e4),l=new Date(+o+9e4),c=new Date(+o+1e4);s.date.push(o,u);var h=new mongoose.Types.ObjectId,p=new mongoose.Types.ObjectId,d=new mongoose.Types.ObjectId,v=new mongoose.Types.ObjectId,m=new mongoose.Types.ObjectId,g=new mongoose.Types.ObjectId;s.id.push(h,p);s.num.addToSet(3,4,5);assert.equal(5,s.num.length);s.str.addToSet("four","five","two");assert.equal(s.str.length,5);s.id.addToSet(p,d);assert.equal(s.id.length,3);s.doc.addToSet(s.doc[0]);assert.equal(s.doc.length,2);s.doc.addToSet({name:"Waltz",arr:[1]},s.doc[0]);assert.equal(s.doc.length,3);assert.equal(s.date.length,2);s.date.addToSet(o);assert.equal(s.date.length,2);s.date.addToSet(a);assert.equal(s.date.length,3);s.save(function(n){assert.ifError(n);i.findById(s,function(n,r){assert.ifError(n);assert.equal(r.num.length,5);assert.ok(~r.num.indexOf(1));assert.ok(~r.num.indexOf(2));assert.ok(~r.num.indexOf(3));assert.ok(~r.num.indexOf(4));assert.ok(~r.num.indexOf(5));assert.equal(r.str.length,5);assert.ok(~r.str.indexOf("one"));assert.ok(~r.str.indexOf("two"));assert.ok(~r.str.indexOf("tres"));assert.ok(~r.str.indexOf("four"));assert.ok(~r.str.indexOf("five"));assert.equal(r.id.length,3);assert.ok(~r.id.indexOf(h));assert.ok(~r.id.indexOf(p));assert.ok(~r.id.indexOf(d));assert.equal(r.date.length,3);assert.ok(~r.date.indexOf(o.toString()));assert.ok(~r.date.indexOf(u.toString()));assert.ok(~r.date.indexOf(a.toString()));assert.equal(r.doc.length,3);assert.ok(r.doc.some(function(e){return e.name==="Waltz"}));assert.ok(r.doc.some(function(e){return e.name==="Dubstep"}));assert.ok(r.doc.some(function(e){return e.name==="Polka"}));r.num.addToSet(3,4,5,6);assert.equal(r.num.length,6);r.str.addToSet("four","five","two","six");assert.equal(r.str.length,6);r.id.addToSet(p,d,v);assert.equal(r.id.length,4);r.date.addToSet(o,a,f);assert.equal(r.date.length,4);r.doc.addToSet(r.doc[0],{name:"8bit"});assert.equal(r.doc.length,4);r.save(function(n){assert.ifError(n);i.findById(r,function(n,r){assert.ifError(n);assert.equal(r.num.length,6);assert.ok(~r.num.indexOf(1));assert.ok(~r.num.indexOf(2));assert.ok(~r.num.indexOf(3));assert.ok(~r.num.indexOf(4));assert.ok(~r.num.indexOf(5));assert.ok(~r.num.indexOf(6));assert.equal(r.str.length,6);assert.ok(~r.str.indexOf("one"));assert.ok(~r.str.indexOf("two"));assert.ok(~r.str.indexOf("tres"));assert.ok(~r.str.indexOf("four"));assert.ok(~r.str.indexOf("five"));assert.ok(~r.str.indexOf("six"));assert.equal(r.id.length,4);assert.ok(~r.id.indexOf(h));assert.ok(~r.id.indexOf(p));assert.ok(~r.id.indexOf(d));assert.ok(~r.id.indexOf(v));assert.equal(r.date.length,4);assert.ok(~r.date.indexOf(o.toString()));assert.ok(~r.date.indexOf(u.toString()));assert.ok(~r.date.indexOf(a.toString()));assert.ok(~r.date.indexOf(f.toString()));assert.equal(r.doc.length,4);assert.ok(r.doc.some(function(e){return e.name==="Waltz"}));assert.ok(r.doc.some(function(e){return e.name==="Dubstep"}));assert.ok(r.doc.some(function(e){return e.name==="Polka"}));assert.ok(r.doc.some(function(e){return e.name==="8bit"}));r.num.addToSet(7,8);assert.equal(r.num.length,8);r.str.addToSet("seven","eight");assert.equal(r.str.length,8);r.id.addToSet(m,g);assert.equal(r.id.length,6);r.date.addToSet(l,c);assert.equal(r.date.length,6);r.doc.addToSet(r.doc[1],{name:"BigBeat"},{name:"Funk"});assert.equal(r.doc.length,6);r.save(function(n){assert.ifError(n);i.findById(r,function(n,r){t.close();assert.ifError(n);assert.equal(r.num.length,8);assert.ok(~r.num.indexOf(1));assert.ok(~r.num.indexOf(2));assert.ok(~r.num.indexOf(3));assert.ok(~r.num.indexOf(4));assert.ok(~r.num.indexOf(5));assert.ok(~r.num.indexOf(6));assert.ok(~r.num.indexOf(7));assert.ok(~r.num.indexOf(8));assert.equal(r.str.length,8);assert.ok(~r.str.indexOf("one"));assert.ok(~r.str.indexOf("two"));assert.ok(~r.str.indexOf("tres"));assert.ok(~r.str.indexOf("four"));assert.ok(~r.str.indexOf("five"));assert.ok(~r.str.indexOf("six"));assert.ok(~r.str.indexOf("seven"));assert.ok(~r.str.indexOf("eight"));assert.equal(r.id.length,6);assert.ok(~r.id.indexOf(h));assert.ok(~r.id.indexOf(p));assert.ok(~r.id.indexOf(d));assert.ok(~r.id.indexOf(v));assert.ok(~r.id.indexOf(m));assert.ok(~r.id.indexOf(g));assert.equal(r.date.length,6);assert.ok(~r.date.indexOf(o.toString()));assert.ok(~r.date.indexOf(u.toString()));assert.ok(~r.date.indexOf(a.toString()));assert.ok(~r.date.indexOf(f.toString()));assert.ok(~r.date.indexOf(l.toString()));assert.ok(~r.date.indexOf(c.toString()));assert.equal(r.doc.length,6);assert.ok(r.doc.some(function(e){return e.name==="Waltz"}));assert.ok(r.doc.some(function(e){return e.name==="Dubstep"}));assert.ok(r.doc.some(function(e){return e.name==="Polka"}));assert.ok(r.doc.some(function(e){return e.name==="8bit"}));assert.ok(r.doc.some(function(e){return e.name==="BigBeat"}));assert.ok(r.doc.some(function(e){return e.name==="Funk"}));e()})})})})})})})});describe("nonAtomicPush()",function(){it("works",function(e){var t=start(),n=t.model("User"),r=mongoose.Types.ObjectId,i=new n({name:"banana",pets:[new r]});assert.equal(i.pets.length,1);i.pets.nonAtomicPush(new r);assert.equal(i.pets.length,2);i.save(function(s){assert.ifError(s);n.findById(i._id,function(s){assert.ifError(s);assert.equal(i.pets.length,2);var o=i.pets[0],a=i.pets[1],f=new r;i.pets.pull(o);i.pets.nonAtomicPush(f);assert.equal(i.pets.length,2);assert.equal(i.pets[0].toString(),a.toString());assert.equal(i.pets[1].toString(),f.toString());i.save(function(r){assert.ifError(r);n.findById(i._id,function(n){t.close();assert.ifError(n);assert.equal(i.pets.length,2);assert.equal(i.pets[0].toString(),a.toString());assert.equal(i.pets[1].toString(),f.toString());e()})})})})})});describe("sort()",function(){it("order should be saved",function(e){var t=start(),n=t.model("ArraySortOrder",new Schema({x:[Number]})),r=new n({x:[1,4,3,2]});r.save(function(t){assert.ifError(t);n.findById(r,function(t,r){assert.ifError(t);assert.equal(1,r.x[0]);assert.equal(4,r.x[1]);assert.equal(3,r.x[2]);assert.equal(2,r.x[3]);r.x.sort();r.save(function(t){assert.ifError(t);n.findById(r,function(t,r){assert.ifError(t);assert.equal(1,r.x[0]);assert.equal(2,r.x[1]);assert.equal(3,r.x[2]);assert.equal(4,r.x[3]);r.x.sort(function(e,t){return t>e});r.save(function(t){assert.ifError(t);n.findById(r,function(t,n){assert.ifError(t);assert.equal(4,n.x[0]);assert.equal(3,n.x[1]);assert.equal(2,n.x[2]);assert.equal(1,n.x[3]);e()})})})})})})})});describe("setting a doc array",function(){it("should adjust path positions",function(e){var t=start(),n=t.model("subDocPositions",new Schema({em1:[new Schema({name:String})]})),r=new n({em1:[{name:"pos0"},{name:"pos1"},{name:"pos2"}]});r.save(function(i){assert.ifError(i);n.findById(r,function(r,i){assert.ifError(r);var s=i.em1.slice();s[2].name="position two";var o=[];o[1]=s[2];o[2]=s[1];o=o.filter(Boolean);i.em1=o;i.save(function(r){assert.ifError(r);n.findById(i,function(n,r){t.close();assert.ifError(n);assert.equal(r.em1[0].name,"position two");assert.equal(r.em1[1].name,"pos1");e()})})})})})});describe("paths with similar names",function(){it("should be saved",function(e){var t=start(),n=t.model("similarPathNames",new Schema({account:{role:String,roles:[String]},em:[new Schema({name:String})]})),r=new n({account:{role:"teacher",roles:["teacher","admin"]},em:[{name:"bob"}]});r.save(function(i){assert.ifError(i);n.findById(r,function(r,i){assert.ifError(r);i.account.role="president";i.account.roles=["president","janitor"];i.em[0].name="memorable";i.em=[{name:"frida"}];i.save(function(r){assert.ifError(r);n.findById(i,function(n,r){t.close();assert.ifError(n);assert.equal(r.account.role,"president");assert.equal(r.account.roles.length,2);assert.equal(r.account.roles[0],"president");assert.equal(r.account.roles[1],"janitor");assert.equal(r.em.length,1);assert.equal(r.em[0].name,"frida");e()})})})})})});describe("of number",function(){it("allows nulls",function(e){var t=start(),n=new Schema({x:[Number]},{collection:"nullsareallowed"+random()}),r=t.model("nullsareallowed",n),i,s=!1;i=new r({x:[1,null,3]});i.save(function(n){assert.ifError(n);i=new r({x:[1,undefined,3]});i.save(function(n){t.close();assert.ok(n);e()})})})});it("modifying subdoc props and manipulating the array works (gh-842)",function(e){var t=start(),n=new Schema({em:[new Schema({username:String})]}),r=t.model("modifyingSubDocAndPushing",n),i=new r({em:[{username:"Arrietty"}]});i.save(function(n){assert.ifError(n);r.findById(i,function(n,i){assert.ifError(n);assert.equal(i.em[0].username,"Arrietty");i.em[0].username="Shawn";i.em.push({username:"Homily"});i.save(function(n){assert.ifError(n);r.findById(i,function(n,i){assert.ifError(n);assert.equal(i.em.length,2);assert.equal(i.em[0].username,"Shawn");assert.equal(i.em[1].username,"Homily");i.em[0].username="Arrietty";i.em[1].remove();i.save(function(n){assert.ifError(n);r.findById(i,function(n,r){t.close();assert.ifError(n);assert.equal(r.em.length,1);assert.equal(r.em[0].username,"Arrietty");e()})})})})})})});it("pushing top level arrays and subarrays works (gh-1073)",function(e){var t=start(),n=new Schema({em:[new Schema({sub:[String]})]}),r=t.model("gh1073",n),i=new r({em:[{sub:[]}]});i.save(function(t){r.findById(i,function(t,n){assert.ifError(t);n.em[n.em.length-1].sub.push("a");n.em.push({sub:[]});assert.equal(2,n.em.length);assert.equal(1,n.em[0].sub.length);n.save(function(t){assert.ifError(t);r.findById(n,function(t,n){assert.ifError(t);assert.equal(2,n.em.length);assert.equal(1,n.em[0].sub.length);assert.equal("a",n.em[0].sub[0]);e()})})})})});describe("default type",function(){it("casts to Mixed",function(){var e=start(),t=new Schema({num1:Array,num2:[]});mongoose.model("DefaultArraySchema",t);var n=e.model("DefaultArraySchema",collection),r=new n;e.close();assert.equal(r.get("num1").length,0);assert.equal(r.get("num2").length,0);var i=!1,s=!1;try{r.num1.push({x:1});r.num1.push(9);r.num1.push("woah")}catch(o){i=!0}assert.equal(i,!1);try{r.num2.push({x:1});r.num2.push(9);r.num2.push("woah")}catch(o){s=!0}assert.equal(s,!1)})});describe("removing from an array atomically using MongooseArray#remove",function(){it("works",function(e){var t=start(),n=t.model("BlogPost",collection),r=new n;r.numbers.push(1,2,3);r.save(function(i){assert.ifError(i);n.findById(r._id,function(i,s){assert.ifError(i);s.numbers.remove("1");s.save(function(i){assert.ifError(i);n.findById(r.get("_id"),function(i,s){assert.ifError(i);assert.equal(s.numbers.length,2);s.numbers.remove("2","3");s.save(function(i){assert.ifError(i);n.findById(r._id,function(n,r){t.close();assert.ifError(n);assert.equal(0,r.numbers.length);e()})})})})})})})})});