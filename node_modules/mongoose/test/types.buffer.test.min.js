/**
 * Module dependencies.
 */function valid(e){return!e||e.length>10}var start=require("./common"),assert=require("assert"),mongoose=require("./common").mongoose,Schema=mongoose.Schema,random=require("../lib/utils").random,MongooseBuffer=mongoose.Types.Buffer,subBuf=new Schema({name:String,buf:{type:Buffer,validate:[valid,"valid failed"],required:!0}}),UserBuffer=new Schema({name:String,serial:Buffer,array:[Buffer],required:{type:Buffer,required:!0,index:!0},sub:[subBuf]});describe("types.buffer",function(){it("test that a mongoose buffer behaves and quacks like an buffer",function(){var e=new MongooseBuffer;assert.ok(e instanceof Buffer);assert.ok(e instanceof MongooseBuffer);assert.equal(!0,Buffer.isBuffer(e));var e=new MongooseBuffer([195,188,98,101,114]),t=new MongooseBuffer("buffer shtuffs are neat"),n=new MongooseBuffer("aGVsbG8gd29ybGQ=","base64");assert.equal(e.toString("utf8"),"Ã¼ber");assert.equal(t.toString("utf8"),"buffer shtuffs are neat");assert.equal(n.toString("utf8"),"hello world")});it("buffer validation",function(e){var t=start(),n=t.model("UserBuffer",UserBuffer,"usersbuffer_"+random());n.on("index",function(){var r=new n({name:"test validation"});r.validate(function(n){assert.equal(n.message,"Validation failed");assert.equal(n.errors.required.type,"required");r.required=20;r.save(function(n){assert.equal(n.name,"CastError");assert.equal(n.type,"buffer");assert.equal(n.value,20);assert.equal(n.message,'Cast to buffer failed for value "20"');r.required=new Buffer("hello");r.sub.push({name:"Friday Friday"});r.save(function(n){assert.equal(n.message,"Validation failed");assert.equal(n.errors["sub.0.buf"].type,"required");r.sub[0].buf=new Buffer("well well");r.save(function(n){assert.equal(n.message,"Validation failed");assert.equal(n.errors["sub.0.buf"].type,"valid failed");r.sub[0].buf=new Buffer("well well well");r.validate(function(n){t.close();assert.ifError(n);e()})})})})})})});it("buffer storage",function(e){var t=start(),n=t.model("UserBuffer",UserBuffer,"usersbuffer_"+random());n.on("index",function(){var r=new Buffer([123,223,23,42,11]),i=new n({name:"tj",serial:r,required:new Buffer(r)});i.save(function(i){assert.ifError(i);n.find({},function(n,i){t.close();assert.ifError(n);assert.equal(i.length,1);var s=i[0],o=r.toString("base64");assert.equal(o,s.serial.toString("base64"),"buffer mismatch");assert.equal(o,s.required.toString("base64"),"buffer mismatch");e()})})})});it("test write markModified",function(e){function r(e){e._activePaths.clear("modify");e.schema.requiredPaths().forEach(function(t){e._activePaths.require(t)})}var t=start(),n=t.model("UserBuffer",UserBuffer,"usersbuffer_"+random());n.on("index",function(){var i=new Buffer([123,223,23,42,11]),s=new n({name:"tj",serial:i,required:i});s.save(function(i){assert.ifError(i);s.serial.write("aa",1,"ascii");assert.equal(!0,s.isModified("serial"));s.save(function(i){assert.ifError(i);n.findById(s._id,function(n,i){function u(e){assert.equal(!1,e.isModified("required"))}function a(e){assert.equal(!0,e.isModified("required"))}t.close();assert.ifError(n);var o=new Buffer([123,97,97,42,11]);assert.equal(o.toString("base64"),i.serial.toString("base64"),"buffer mismatch");assert.equal(!1,s.isModified("required"));s.serial.copy(s.required,1);assert.equal(!0,s.isModified("required"));assert.equal("e3thYSo=",s.required.toString("base64"));var f={writeUInt8:function(){r(s);u(s);s.required.writeUInt8(3,0,"big");a(s)},writeUInt16:function(){r(s);u(s);s.required.writeUInt16(48879,0,"little");a(s)},writeUInt16LE:function(){r(s);u(s);s.required.writeUInt16LE(48879,0);a(s)},writeUInt16BE:function(){r(s);u(s);s.required.writeUInt16BE(48879,0);a(s)},writeUInt32:function(){r(s);u(s);s.required.writeUInt32(4277009102,0,"little");a(s)},writeUInt32LE:function(){r(s);u(s);s.required.writeUInt32LE(4277009102,0);a(s)},writeUInt32BE:function(){r(s);u(s);s.required.writeUInt32BE(4277009102,0);a(s)},writeInt8:function(){r(s);u(s);s.required.writeInt8(-5,0,"big");a(s)},writeInt16:function(){r(s);u(s);s.required.writeInt16(35,2,"little");a(s);assert.equal(s.required[2],35);assert.equal(s.required[3],0)},writeInt16LE:function(){r(s);u(s);s.required.writeInt16LE(35,2);a(s);assert.equal(s.required[2],35);assert.equal(s.required[3],0)},writeInt16BE:function(){r(s);u(s);s.required.writeInt16BE(35,2);a(s)},writeInt32:function(){r(s);u(s);s.required.writeInt32(35,0,"big");a(s);assert.equal(s.required[0],0);assert.equal(s.required[1],0);assert.equal(s.required[2],0);assert.equal(s.required[3],35);s.required=new Buffer(8)},writeInt32LE:function(){s.required=new Buffer(8);r(s);u(s);s.required.writeInt32LE(35,0);a(s)},writeInt32BE:function(){s.required=new Buffer(8);r(s);u(s);s.required.writeInt32BE(35,0);a(s);assert.equal(s.required[0],0);assert.equal(s.required[1],0);assert.equal(s.required[2],0);assert.equal(s.required[3],35)},writeFloat:function(){s.required=new Buffer(16);r(s);u(s);s.required.writeFloat(2.225073858507201e-308,0,"big");a(s);assert.equal(s.required[0],0);assert.equal(s.required[1],15);assert.equal(s.required[2],255);assert.equal(s.required[3],255);assert.equal(s.required[4],255);assert.equal(s.required[5],255);assert.equal(s.required[6],255);assert.equal(s.required[7],255)},writeFloatLE:function(){s.required=new Buffer(16);r(s);u(s);s.required.writeFloatLE(2.225073858507201e-308,0);a(s)},writeFloatBE:function(){s.required=new Buffer(16);r(s);u(s);s.required.writeFloatBE(2.225073858507201e-308,0);a(s)},writeDoubleLE:function(){s.required=new Buffer(8);r(s);u(s);s.required.writeDoubleLE(0xdeadbeefcafeb800,0);a(s)},writeDoubleBE:function(){s.required=new Buffer(8);r(s);u(s);s.required.writeDoubleBE(0xdeadbeefcafeb800,0);a(s)},fill:function(){s.required=new Buffer(8);r(s);u(s);s.required.fill(0);a(s);for(var e=0;e<s.required.length;e++)assert.strictEqual(s.required[e],0)},set:function(){r(s);u(s);s.required.set(0,1);a(s)}},l=Object.keys(f),c=l.length,h;while(c--){h=l[c];Buffer.prototype[h]&&f[h]()}e()})})})})})});