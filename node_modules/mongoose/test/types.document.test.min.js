/**
 * Module dependencies.
 */function Dummy(){mongoose.Document.call(this,{})}function Subdocument(){var e=new DocumentArray;e._path="jsconf.ar";e._parent=new Dummy;e[0]=this;EmbeddedDocument.call(this,{},e)}var assert=require("assert"),start=require("./common"),mongoose=start.mongoose,EmbeddedDocument=require("../lib/types/embedded"),DocumentArray=require("../lib/types/documentarray"),Schema=mongoose.Schema,SchemaType=mongoose.SchemaType,ValidatorError=SchemaType.ValidatorError,ValidationError=mongoose.Document.ValidationError;Dummy.prototype.__proto__=mongoose.Document.prototype;Dummy.prototype._setSchema(new Schema);Subdocument.prototype.__proto__=EmbeddedDocument.prototype;Subdocument.prototype._setSchema(new Schema({test:{type:String,required:!0},work:{type:String,validate:/^good/}}));var RatingSchema=new Schema({stars:Number}),MovieSchema=new Schema({title:String,ratings:[RatingSchema]});mongoose.model("Movie",MovieSchema);describe("types.document",function(){it("test that save fires errors",function(e){var t=new Subdocument;t.set("test","");t.set("work","nope");t.save(function(n){assert.ok(t.__parent._validationError instanceof ValidationError);assert.equal(t.__parent.errors["jsconf.ar.0.work"].name,"ValidatorError");assert.equal(t.__parent._validationError.toString(),'ValidationError: Validator "required" failed for path test, Validator failed for path work');e()})});it("objects can be passed to #set",function(){var e=new Subdocument;e.set({test:"paradiddle",work:"good flam"});assert.equal(e.test,"paradiddle");assert.equal(e.work,"good flam")});it("Subdocuments can be passed to #set",function(){var e=new Subdocument;e.set({test:"paradiddle",work:"good flam"});assert.equal(e.test,"paradiddle");assert.equal(e.work,"good flam");var t=new Subdocument;t.set(e);assert.equal(t.test,"paradiddle");assert.equal(t.work,"good flam")});it("cached _ids",function(){var e=start(),t=e.model("Movie");e.close();var n=new t;assert.equal(n.id,n.__id);var r=n.id;n._id=new mongoose.Types.ObjectId;assert.equal(n.id,n.__id);assert.strictEqual(!0,r!==n.__id);var i=new t;delete i._doc._id;i.init({_id:new mongoose.Types.ObjectId});assert.equal(i.id,i.__id);assert.strictEqual(!0,n.__id!==i.__id);assert.strictEqual(!0,n.id!==i.id);assert.strictEqual(!0,n.__id!==i.__id)});it("Subdocument#remove (gh-531)",function(e){var t=start(),n=t.model("Movie"),r=new n({title:"Super 8"}),i="4e3d5fc7da5d7eb635063c96",s="4e3d5fc7da5d7eb635063c97",o="4e3d5fc7da5d7eb635063c98",u="4e3d5fc7da5d7eb635063c99";r.ratings.push({stars:9,_id:i});r.ratings.push({stars:8,_id:s});r.ratings.push({stars:7,_id:o});r.ratings.push({stars:6,_id:u});r.save(function(a){assert.ifError(a);assert.equal(r.title,"Super 8");assert.equal(r.ratings.id(i).stars.valueOf(),9);assert.equal(r.ratings.id(s).stars.valueOf(),8);assert.equal(r.ratings.id(o).stars.valueOf(),7);assert.equal(r.ratings.id(u).stars.valueOf(),6);r.ratings.id(i).stars=5;r.ratings.id(s).remove();r.ratings.id(o).stars=4;r.ratings.id(u).stars=3;r.save(function(s){assert.ifError(s);n.findById(r._id,function(s,a){assert.ifError(s);assert.equal(a.title,"Super 8");assert.equal(a.ratings.length,3);assert.equal(a.ratings.id(i).stars.valueOf(),5);assert.equal(a.ratings.id(o).stars.valueOf(),4);assert.equal(a.ratings.id(u).stars.valueOf(),3);a.ratings.id(i).stars=2;a.ratings.id(o).remove();a.ratings.id(u).stars=1;a.save(function(s){assert.ifError(s);n.findById(r._id,function(s,o){assert.ifError(s);assert.equal(o.ratings.length,2);assert.equal(o.ratings.id(i).stars.valueOf(),2);assert.equal(o.ratings.id(u).stars.valueOf(),1);o.ratings[0].remove();o.ratings[0].remove();o.save(function(i){n.findById(r._id,function(n,r){t.close();assert.ifError(n);assert.equal(0,r.ratings.length);e()})})})})})})})})});