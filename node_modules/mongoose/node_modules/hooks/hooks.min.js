// TODO Add in pre and post skipping options
function once(e,t){return function n(){if(n.hookCalled)return;n.hookCalled=!0;e.apply(t,arguments)}}module.exports={hook:function(e,t,n){if(arguments.length===1&&typeof e=="object"){for(var r in e)this.hook(r,e[r]);return}var i=this.prototype||this,s=i._pres=i._pres||{},o=i._posts=i._posts||{};s[e]=s[e]||[];o[e]=o[e]||[];i[e]=function(){function v(e){if("function"==typeof o)return o(e);if(n)return n.call(r,e);throw e}var r=this,s,o=arguments[arguments.length-1],u=this._pres[e],a=this._posts[e],f=u.length,l=-1,c=i[e].numAsyncPres,h=function(){if(arguments[0]instanceof Error)return v(arguments[0]);var t=Array.prototype.slice.call(arguments),n,a;t.length&&(arguments[0]!=null||typeof o!="function")&&(s=t);if(++l<f){n=u[l];if(n.isAsync&&n.length<2)throw new Error("Your pre must have next and done arguments -- e.g., function (next, done, ...)");if(n.length<1)throw new Error("Your pre must have a next argument -- e.g., function (next, ...)");a=(n.isAsync?[once(h),once(d)]:[once(h)]).concat(s);return n.apply(r,a)}if(!i[e].numAsyncPres)return p.apply(r,s)},p=function(){var e=Array.prototype.slice.call(arguments),n,i,o,u,c,h;if(l===f){n=t.apply(r,e);i=a.length;o=-1;u=function(){if(arguments[0]instanceof Error)return v(arguments[0]);var e=Array.prototype.slice.call(arguments,1),t,n;e.length&&(s=e);if(++o<i){t=a[o];if(t.length<1)throw new Error("Your post must have a next argument -- e.g., function (next, ...)");n=[once(u)].concat(s);return t.apply(r,n)}};return i?u():n}};if(c)function d(e){if(e&&e instanceof Error)return v(e);--c||p.apply(r,s)}return h.apply(this,arguments)};i[e].numAsyncPres=0;return this},pre:function(e,t,n,r){if("boolean"!=typeof arguments[1]){r=n;n=t;t=!1}var i=this.prototype||this,s=i._pres=i._pres||{};this._lazySetupHooks(i,e,r);(n.isAsync=t)&&i[e].numAsyncPres++;(s[e]=s[e]||[]).push(n);return this},post:function(e,t,n){if(arguments.length===2){n=t;t=!1}var r=this.prototype||this,i=r._posts=r._posts||{};this._lazySetupHooks(r,e);(i[e]=i[e]||[]).push(n);return this},removePre:function(e,t){var n=this.prototype||this,r=n._pres||n._pres||{};if(!r[e])return this;arguments.length===1?r[e].length=0:r[e]=r[e].filter(function(e){return e!==t});return this},_lazySetupHooks:function(e,t,n){"undefined"==typeof e[t].numAsyncPres&&this.hook(t,e[t],n)}};