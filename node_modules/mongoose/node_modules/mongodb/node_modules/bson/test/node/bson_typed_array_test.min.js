var mongodb=require("../../lib/bson").pure(),testCase=require("nodeunit").testCase,mongoO=require("../../lib/bson").pure(),debug=require("util").debug,inspect=require("util").inspect,Buffer=require("buffer").Buffer,gleak=require("../../tools/gleak"),fs=require("fs"),BSON=mongoO.BSON,Code=mongoO.Code,Binary=mongoO.Binary,Timestamp=mongoO.Timestamp,Long=mongoO.Long,MongoReply=mongoO.MongoReply,ObjectID=mongoO.ObjectID,Symbol=mongoO.Symbol,DBRef=mongoO.DBRef,Double=mongoO.Double,MinKey=mongoO.MinKey,MaxKey=mongoO.MaxKey,BinaryParser=mongoO.BinaryParser,utils=require("./tools/utils"),BSONSE=mongodb,BSONDE=mongodb;BSONDE.BSON_BINARY_SUBTYPE_DEFAULT=0;BSONDE.BSON_BINARY_SUBTYPE_FUNCTION=1;BSONDE.BSON_BINARY_SUBTYPE_BYTE_ARRAY=2;BSONDE.BSON_BINARY_SUBTYPE_UUID=3;BSONDE.BSON_BINARY_SUBTYPE_MD5=4;BSONDE.BSON_BINARY_SUBTYPE_USER_DEFINED=128;BSONSE.BSON_BINARY_SUBTYPE_DEFAULT=0;BSONSE.BSON_BINARY_SUBTYPE_FUNCTION=1;BSONSE.BSON_BINARY_SUBTYPE_BYTE_ARRAY=2;BSONSE.BSON_BINARY_SUBTYPE_UUID=3;BSONSE.BSON_BINARY_SUBTYPE_MD5=4;BSONSE.BSON_BINARY_SUBTYPE_USER_DEFINED=128;var hexStringToBinary=function(e){var t=e.length/2,n="";for(var r=0;r<t;r++)n+=String.fromCharCode(parseInt(e[r*2]+e[r*2+1],16));return n},assertBuffersEqual=function(e,t,n){t.length!=n.length&&e.fail("Buffers do not have the same length",t,n);for(var r=0;r<t.length;r++)e.equal(t[r],n[r])},ISODate=function(e){var t;if(typeof e.getTime=="function")return e;if(t=e.match(/^(\d{4})(-(\d{2})(-(\d{2})(T(\d{2}):(\d{2})(:(\d{2})(\.(\d+))?)?(Z|((\+|-)(\d{2}):(\d{2}))))?)?)?$/)){var n=new Date;n.setUTCFullYear(Number(t[1]));n.setUTCMonth(Number(t[3])-1||0);n.setUTCDate(Number(t[5])||0);n.setUTCHours(Number(t[7])||0);n.setUTCMinutes(Number(t[8])||0);n.setUTCSeconds(Number(t[10])||0);n.setUTCMilliseconds(Number("."+t[12])*1e3||0);if(t[13]&&t[13]!=="Z"){var r=Number(t[16])||0,i=Number(t[17])||0;r*=36e5;i*=6e4;var s=r+i;t[15]=="+"&&(s=-s);n=new Date(n.valueOf()+s)}return n}throw new Error("Invalid ISO 8601 date given.",__filename)};exports.setUp=function(e){e()};exports.tearDown=function(e){e()};exports.shouldCorrectlyDeserializeUsingTypedArray=function(e){if(typeof ArrayBuffer=="undefined"){e.done();return}var t={string:"客家话",array:[1,2,3],hash:{a:1,b:2},date:new Date,oid:new ObjectID,binary:new Binary(new Buffer("hello")),"int":42,"float":33.3333,regexp:/regexp/,"boolean":!0,"long":Long.fromNumber(100),where:new Code("this.a > i",{i:1}),dbref:new DBRef("namespace",new ObjectID,"integration_tests_"),minkey:new MinKey,maxkey:new MaxKey},n=BSONSE.BSON.serialize(t,!0,!0,!1),r=new Uint8Array(new ArrayBuffer(n.length));for(var i=0;i<n.length;i++)r[i]=n[i];var s=BSONDE.BSON.deserialize(r);e.equal(t.string,s.string);e.deepEqual(t.array,s.array);e.deepEqual(t.date,s.date);e.deepEqual(t.oid.toHexString(),s.oid.toHexString());e.deepEqual(t.binary.length(),s.binary.length());for(var i=0;i<t.binary.length();i++)e.equal(t.binary.value[i],s.binary[i]);e.deepEqual(t.int,s.int);e.deepEqual(t.float,s.float);e.deepEqual(t.regexp,s.regexp);e.deepEqual(t.boolean,s.boolean);e.deepEqual(t.long.toNumber(),s.long);e.deepEqual(t.where,s.where);e.deepEqual(t.dbref.oid.toHexString(),s.dbref.oid.toHexString());e.deepEqual(t.dbref.namespace,s.dbref.namespace);e.deepEqual(t.dbref.db,s.dbref.db);e.deepEqual(t.minkey,s.minkey);e.deepEqual(t.maxkey,s.maxkey);e.done()};exports.shouldCorrectlySerializeUsingTypedArray=function(e){if(typeof ArrayBuffer=="undefined"){e.done();return}var t={string:"hello",array:[1,2,3],hash:{a:1,b:2},date:new Date,oid:new ObjectID,binary:new Binary(new Buffer("hello")),"int":42,"float":33.3333,regexp:/regexp/,"boolean":!0,"long":Long.fromNumber(100),where:new Code("this.a > i",{i:1}),dbref:new DBRef("namespace",new ObjectID,"integration_tests_"),minkey:new MinKey,maxkey:new MaxKey},n=BSONSE.BSON.serialize(t,!0,!1,!1),r=BSONSE.BSON.deserialize(n);e.equal(t.string,r.string);e.deepEqual(t.array,r.array);e.deepEqual(t.date,r.date);e.deepEqual(t.oid.toHexString(),r.oid.toHexString());e.deepEqual(t.binary.length(),r.binary.length());for(var i=0;i<t.binary.length();i++)e.equal(t.binary.value[i],r.binary[i]);e.deepEqual(t.int,r.int);e.deepEqual(t.float,r.float);e.deepEqual(t.regexp,r.regexp);e.deepEqual(t.boolean,r.boolean);e.deepEqual(t.long.toNumber(),r.long);e.deepEqual(t.where,r.where);e.deepEqual(t.dbref.oid.toHexString(),r.dbref.oid.toHexString());e.deepEqual(t.dbref.namespace,r.dbref.namespace);e.deepEqual(t.dbref.db,r.dbref.db);e.deepEqual(t.minkey,r.minkey);e.deepEqual(t.maxkey,r.maxkey);e.done()};exports["exercise all the binary object constructor methods"]=function(e){if(typeof ArrayBuffer=="undefined"){e.done();return}var t="hello world",n=utils.stringToArrayBuffer(t),r=new Binary(utils.stringToArrayBuffer(t));e.ok(t.length,r.buffer.length);e.ok(utils.assertArrayEqual(n,r.buffer));r=new Binary(5);e.ok(5,r.buffer.length);var r=new Binary(utils.stringToArray(t));e.ok(t.length,r.buffer.length);e.ok(utils.assertArrayEqual(n,r.buffer));var r=new Binary(t);e.ok(t.length,r.buffer.length);e.ok(utils.assertArrayEqual(n,r.buffer));e.done()};exports["exercise the put binary object method for an instance when using Uint8Array"]=function(e){if(typeof ArrayBuffer=="undefined"){e.done();return}var t="hello world",n=utils.stringToArrayBuffer(t+"a"),r=new Binary(utils.stringToArrayBuffer(t));e.ok(t.length,r.buffer.length);r.put("a");e.equal(t.length+1,r.position);e.ok(utils.assertArrayEqual(n,r.value(!0)));e.equal("hello worlda",r.value());var r=new Binary;e.ok(Binary.BUFFER_SIZE,r.buffer.length);r.put("a");e.equal(1,r.position);e.ok(utils.assertArrayEqual(["a".charCodeAt(0)],r.value(!0)));e.equal("a",r.value());e.done()},exports["exercise the write binary object method for an instance when using Uint8Array"]=function(e){if(typeof ArrayBuffer=="undefined"){e.done();return}var t="hello world",n=new Uint8Array(new ArrayBuffer(1));n[0]="a".charCodeAt(0);var r=["a".charCodeAt(0)],i=new Binary(utils.stringToArrayBuffer(t));e.ok(t.length,i.buffer.length);i.write("a");e.equal("hello worlda",i.value());i.write("a",0);e.equal("aello worlda",i.value());i.write(n);e.equal("aello worldaa",i.value());i.write(n,5);e.equal("aelloaworldaa",i.value());i.write(r);e.equal("aelloaworldaaa",i.value());i.write(r,6);e.equal("aelloaaorldaaa",i.value());e.done()},exports["exercise the read binary object method for an instance when using Uint8Array"]=function(e){if(typeof ArrayBuffer=="undefined"){e.done();return}var t="hello world",n=utils.stringToArrayBuffer(t),r=new Binary(utils.stringToArrayBuffer(t));e.ok(t.length,r.buffer.length);var i=r.read(0,2);e.ok(utils.assertArrayEqual(utils.stringToArrayBuffer("he"),i));var i=r.read(0);e.ok(utils.assertArrayEqual(utils.stringToArrayBuffer(t),i));var i=r.read(6,5);e.ok(utils.assertArrayEqual(utils.stringToArrayBuffer("world"),i));e.done()};exports.noGlobalsLeaked=function(e){var t=gleak.detectNew();e.equal(0,t.length,"global var leak detected: "+t.join(", "));e.done()};