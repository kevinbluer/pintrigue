this.bson_test={"Full document serialization and deserialization":function(e){var t={string:"客家话",array:[1,2,3],hash:{a:1,b:2},date:new Date,oid:new ObjectID,binary:new Binary("hello world"),"int":42,"float":33.3333,regexp:/regexp/,"boolean":!0,"long":Long.fromNumber(100),where:new Code("this.a > i",{i:1}),dbref:new DBRef("namespace",new ObjectID,"integration_tests_"),minkey:new MinKey,maxkey:new MaxKey},n=BSON.serialize(t,!0,!0,!1),r=BSON.deserialize(n);e.equal(Utf8.decode(t.string),r.string);e.deepEqual(t.array,r.array);e.deepEqual(t.date,r.date);e.deepEqual(t.oid.toHexString(),r.oid.toHexString());e.deepEqual(t.binary.length(),r.binary.length());e.ok(assertArrayEqual(t.binary.value(!0),r.binary.value(!0)));e.deepEqual(t.int,r.int);e.deepEqual(t.float,r.float);e.deepEqual(t.regexp,r.regexp);e.deepEqual(t.boolean,r.boolean);e.deepEqual(t.long.toNumber(),r.long);e.deepEqual(t.where,r.where);e.deepEqual(t.dbref.oid.toHexString(),r.dbref.oid.toHexString());e.deepEqual(t.dbref.namespace,r.dbref.namespace);e.deepEqual(t.dbref.db,r.dbref.db);e.deepEqual(t.minkey,r.minkey);e.deepEqual(t.maxkey,r.maxkey);e.done()},"exercise all the binary object constructor methods":function(e){var t="hello world",n=stringToArrayBuffer(t),r=new Binary(stringToArrayBuffer(t));e.ok(t.length,r.buffer.length);e.ok(assertArrayEqual(n,r.buffer));r=new Binary(5);e.ok(5,r.buffer.length);var r=new Binary(stringToArray(t));e.ok(t.length,r.buffer.length);e.ok(assertArrayEqual(n,r.buffer));var r=new Binary(t);e.ok(t.length,r.buffer.length);e.ok(assertArrayEqual(n,r.buffer));e.done()},"exercise the put binary object method for an instance when using Uint8Array":function(e){var t="hello world",n=stringToArrayBuffer(t+"a"),r=new Binary(stringToArrayBuffer(t));e.ok(t.length,r.buffer.length);r.put("a");e.equal(t.length+1,r.position);e.ok(assertArrayEqual(n,r.value(!0)));e.equal("hello worlda",r.value());var r=new Binary;e.ok(Binary.BUFFER_SIZE,r.buffer.length);r.put("a");e.equal(1,r.position);e.ok(assertArrayEqual(["a".charCodeAt(0)],r.value(!0)));e.equal("a",r.value());e.done()},"exercise the write binary object method for an instance when using Uint8Array":function(e){var t="hello world",n=new Uint8Array(new ArrayBuffer(1));n[0]="a".charCodeAt(0);var r=["a".charCodeAt(0)],i=new Binary(stringToArrayBuffer(t));e.ok(t.length,i.buffer.length);i.write("a");e.equal("hello worlda",i.value());i.write("a",0);e.equal("aello worlda",i.value());i.write(n);e.equal("aello worldaa",i.value());i.write(n,5);e.equal("aelloaworldaa",i.value());i.write(r);e.equal("aelloaworldaaa",i.value());i.write(r,6);e.equal("aelloaaorldaaa",i.value());e.done()},"exercise the read binary object method for an instance when using Uint8Array":function(e){var t="hello world",n=stringToArrayBuffer(t),r=new Binary(stringToArrayBuffer(t));e.ok(t.length,r.buffer.length);var i=r.read(0,2);e.ok(assertArrayEqual(stringToArrayBuffer("he"),i));var i=r.read(0);e.ok(assertArrayEqual(stringToArrayBuffer(t),i));var i=r.read(6,5);e.ok(assertArrayEqual(stringToArrayBuffer("world"),i));e.done()},"Should correctly handle toBson function for an object":function(e){var t={hello:new ObjectID,a:1};t.toBSON=function(){return{b:1}};var n=BSON.serialize(t,!1,!0),r=BSON.deserialize(n);e.equal(1,r.b);e.done()}};var assertArrayEqual=function(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0},stringToArrayBuffer=function(e){var t=new Uint8Array(new ArrayBuffer(e.length));for(var n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t},stringToArray=function(e){var t=new Array(e.length);for(var n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t},Utf8={encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128)t+=String.fromCharCode(r);else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},decode:function(e){var t="",n=0,r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}};