var Server=require("../server").Server,PingStrategy=exports.PingStrategy=function(e,t){this.replicaset=e;this.secondaryAcceptableLatencyMS=t;this.state="disconnected";this.Db=require("../../db").Db};PingStrategy.prototype.start=function(e){this.state="connected";this._pingServer(e)};PingStrategy.prototype.stop=function(e){this.state="disconnected";e(null,null)};PingStrategy.prototype.checkoutSecondary=function(e,t){var n=[];if(!Array.isArray(t)){n=this.replicaset._state.master!=null?[this.replicaset._state.master]:[];var r=Object.keys(this.replicaset._state.secondaries);for(var i=0;i<r.length;i++)n.push(this.replicaset._state.secondaries[r[i]])}else n=t;var s=[];if(e!=null&&typeof e=="object"){var o=Array.isArray(e)?e:[e];for(var u=0;u<o.length;u++){var a=o[u],f=Object.keys(a);for(var i=0;i<n.length;i++){var l=n[i];if(l.tags!=null){var c=!0;for(var h=0;h<f.length;h++)if(l.tags[f[h]]!=a[f[h]]){c=!1;break}c&&s.push(l)}}}}else var s=n;s.sort(function(e,t){return e.runtimeStats.pingMs>t.runtimeStats.pingMs});for(var i=0;i<s.length;i++)if(s[i].runtimeStats.pingMs>s[0].runtimeStats.pingMs+this.secondaryAcceptableLatencyMS){s=s.slice(i);break}return s.length==0?new Error("No replica set members available for query"):s[Math.round(Math.random(1e6)*(s.length-1))].checkoutReader()};PingStrategy.prototype._pingServer=function(e){var t=this,n=function(){if(t.state=="disconnected")return;var e=t.replicaset._state!=null&&t.replicaset._state.addresses!=null?t.replicaset._state.addresses:null,r=Object.keys(e),i=r.length;for(var s=0;s<r.length;s++){var o=e[r[s]];new function(e){var r=new Server(e.host,e.port,{poolSize:1,timeout:500,auto_reconnect:!1}),s=new t.Db(t.replicaset.db.databaseName,r);s.on("error",function(e){i-=1;s.close();i==0&&t.state=="connected"&&setTimeout(n,1e3)});s.open(function(r,o){if(r!=null)s.close();else{var u=(new Date).getTime();o.executeDbCommand({ping:1},function(r,s){i-=1;var a=(new Date).getTime();e!=null&&e.runtimeStats!=null&&e.isConnected()&&(e.runtimeStats.pingMs=a-u);o.close();i==0&&t.state=="connected"&&setTimeout(n,1e3)})}})}(o)}};setTimeout(n,1e3);e(null)};