function Server(e,t,n){EventEmitter.call(this);if(!(this instanceof Server))return new Server(e,t,n);var r=this;this.host=e;this.port=t;this.options=n==null?{}:n;this.internalConnection;this.internalMaster=!1;this.connected=!1;this.poolSize=this.options.poolSize==null?5:this.options.poolSize;this.disableDriverBSONSizeCheck=this.options.disableDriverBSONSizeCheck!=null?this.options.disableDriverBSONSizeCheck:!1;this.ssl=this.options.ssl==null?!1:this.options.ssl;this.slaveOk=this.options.slave_ok;this._used=!1;var i=this.options.readPreference;if(i!=null){if(i!=ReadPreference.PRIMARY&&i!=ReadPreference.SECONDARY&&i!=ReadPreference.NEAREST&&i!=ReadPreference.SECONDARY_PREFERRED&&i!=ReadPreference.PRIMARY_PREFERRED)throw new Error("Illegal readPreference mode specified, "+i);this._readPreference=i}else this._readPreference=null;this.isMasterDoc;this.socketOptions=this.options.socketOptions!=null?this.options.socketOptions:{};this.disableDriverBSONSizeCheck&&(this.socketOptions.disableDriverBSONSizeCheck=this.disableDriverBSONSizeCheck);this.ssl&&(this.socketOptions.ssl=!0);this.logger=this.options.logger!=null&&typeof this.options.logger.debug=="function"&&typeof this.options.logger.error=="function"&&typeof this.options.logger.log=="function"?this.options.logger:{error:function(e,t){},log:function(e,t){},debug:function(e,t){}};this.eventHandlers={error:[],parseError:[],poolReady:[],message:[],close:[],timeout:[]};this._serverState="disconnected";this._state={runtimeStats:{queryStats:new RunningStats}};this.recordQueryStats=!1}var Connection=require("./connection").Connection,ReadPreference=require("./read_preference").ReadPreference,DbCommand=require("../commands/db_command").DbCommand,MongoReply=require("../responses/mongo_reply").MongoReply,ConnectionPool=require("./connection_pool").ConnectionPool,EventEmitter=require("events").EventEmitter,inherits=require("util").inherits;inherits(Server,EventEmitter);Server.READ_PRIMARY=ReadPreference.PRIMARY;Server.READ_SECONDARY=ReadPreference.SECONDARY_PREFERRED;Server.READ_SECONDARY_ONLY=ReadPreference.SECONDARY;Server.prototype.setReadPreference=function(){};Server.prototype.isMongos=function(){return this.isMasterDoc!=null&&this.isMasterDoc["msg"]=="isdbgrid"?!0:!1};Server.prototype._isUsed=function(){return this._used};Server.prototype.close=function(e){this.removeAllListeners();if(this.connectionPool!=null){this.connectionPool.removeAllEventListeners();this.connectionPool.stop(!0)}this._serverState="disconnected";typeof e=="function"&&e()};Server.prototype.isConnected=function(){return this._serverState=="connected"};Server.prototype.allServerInstances=function(){return[this]};Server.prototype.isSetMember=function(){return this["replicasetInstance"]!=null||this["mongosInstance"]!=null};Server.prototype.connect=function(e,t,n){"function"==typeof t&&(n=t,t={});t==null&&(t={});"function"!=typeof n&&(n=null);this.ssl==1&&(this.socketOptions.ssl=!0);var r=this,i=t.eventReceiver!=null?t.eventReceiver:this;this.dbInstance=e;this.dbInstances=[e];r.connectionPool&&r.connectionPool.stop();this._serverState="connecting";e.slaveOk=this.slaveOk?this.slaveOk:e.slaveOk;var s=new ConnectionPool(this.host,this.port,this.poolSize,e.bson,this.socketOptions);s.logger=this.logger;r.connectionPool=s;var o=t.returnIsMasterResults==null?!1:t.returnIsMasterResults,u=function(t,s){var u=n;n=null;if(t!=null&&u==null)return;if(t!=null)return u(t,null);r.master=s.documents[0].ismaster==1?!0:!1;r.connectionPool.setMaxBsonSize(s.documents[0].maxBsonObjectSize);r.connected=!0;r.isMasterDoc=s.documents[0];_emitAcrossAllDbInstances(r,i,"open",null,o?s:e,null);o?u(null,s,r):u(null,e,r)},a=t.connectHandler==null?u:t.connectHandler;s.on("poolReady",function(){var t=DbCommand.NcreateIsMasterCommand(e,e.databaseName),n=s.checkoutConnection();r._serverState="connected";e._registerHandler(t,!1,n,a);n.write(t)});s.on("message",function(t){try{var o=new MongoReply;o.parseHeader(t,s.bson);if(o.messageLength!=t.length){i.listeners("error")&&i.listeners("error").length>0&&i.emit("error",new Error("bson length is different from message length"),r);r.removeAllListeners()}else{var u=(new Date).getTime(),a=null,f=null;for(var l=0;l<r.dbInstances.length;l++){var c=r.dbInstances[l],h=c._hasHandler(o.responseTo.toString());if(h&&a==null){a=c._findHandler(o.responseTo.toString());f=c}else h&&c._removeHandler(o.responseTo.toString())}o.requestId>0&&o.cursorId.toString()!="0"&&a.info&&a.info.exhaust&&e._reRegisterHandler(o.requestId,a);if(a&&a.callback&&Array.isArray(a.info.chained)){var p=a.info.chained,d=0;for(var l=0;l<p.length;l++)f._hasHandler(p[l])&&d++;if(d!=p.length){for(var l=0;l<p.length;l++)f._removeHandler(p[l]);return}o.parseBody(t,s.bson,a.info.raw,function(e){if(e!=null){if(r._serverState==="disconnected")return;r._serverState="disconnected";r.removeAllListeners();s.stop(!0);if(typeof n=="function"){var t=n;n=null;t(new Error("connection closed due to parseError"),null,r)}else r.isSetMember()?r.listeners("parseError")&&r.listeners("parseError").length>0&&r.emit("parseError",new Error("connection closed due to parseError"),r):i.listeners("parseError")&&i.listeners("parseError").length>0&&i.emit("parseError",new Error("connection closed due to parseError"),r);if(!r.isSetMember()){_fireCallbackErrors(r,new Error("connection closed due to parseError"));_emitAcrossAllDbInstances(r,i,"parseError",r,null,!0)}return}var u=f._findHandler(o.responseTo.toString()),a=o&&o.documents;if(a[0].err!=null||a[0].errmsg!=null)f._callHandler(o.responseTo,o,null);else{var l=u.info.chained;if(l.length>0&&l[l.length-1]==o.responseTo){l.pop();for(var c=0;c<l.length;c++)f._removeHandler(l[c]);f._callHandler(o.responseTo,u.info.results.shift(),null)}else for(var c=0;c<l.length;c++){var h=f._findHandler(l[c]);if(h.info!=null){h.info.results=Array.isArray(u.info.results)?u.info.results:[];h.info.results.push(o)}}}})}else a&&a.callback&&o.parseBody(t,s.bson,a.info.raw,function(e){if(e!=null){if(r._serverState==="disconnected")return;r._serverState="disconnected";r.removeAllListeners();s.stop(!0);if(typeof n=="function"){var t=n;n=null;t(new Error("connection closed due to parseError"),null,r)}else r.isSetMember()?r.listeners("parseError")&&r.listeners("parseError").length>0&&r.emit("parseError",new Error("connection closed due to parseError"),r):i.listeners("parseError")&&i.listeners("parseError").length>0&&i.emit("parseError",new Error("connection closed due to parseError"),r);if(!r.isSetMember()){_fireCallbackErrors(r,new Error("connection closed due to parseError"));_emitAcrossAllDbInstances(r,i,"parseError",r,null,!0)}return}r.recordQueryStats==1&&r._state["runtimeStats"]!=null&&r._state.runtimeStats.queryStats instanceof RunningStats&&r._state.runtimeStats.queryStats.push((new Date).getTime()-a.info.start);f._callHandler(o.responseTo,o,null)})}}catch(v){process.nextTick(function(){throw v})}});s.on("timeout",function(e){if(r._serverState==="disconnected")return;r._serverState="disconnected";if(typeof n=="function"){var t=n;n=null;t(e,null,r)}else r.isSetMember()?r.listeners("timeout")&&r.listeners("timeout").length>0&&r.emit("timeout",e,r):i.listeners("timeout")&&i.listeners("timeout").length>0&&i.emit("timeout",e,r);if(!r.isSetMember()){_fireCallbackErrors(r,e);_emitAcrossAllDbInstances(r,i,"timeout",e,r,!0)}});s.on("error",function(e){if(r._serverState==="disconnected")return;r._serverState="disconnected";if(typeof n=="function"){var t=n;n=null;t(new Error(e&&e.err?e.err:e),null,r)}else r.isSetMember()?r.listeners("error")&&r.listeners("error").length>0&&r.emit("error",new Error(e&&e.err?e.err:e),r):i.listeners("error")&&i.listeners("error").length>0&&i.emit("error",new Error(e&&e.err?e.err:e),r);if(!r.isSetMember()){_fireCallbackErrors(r,new Error(e&&e.err?e.err:e));_emitAcrossAllDbInstances(r,i,"error",new Error(e&&e.err?e.err:e),r,!0)}});s.on("close",function(){if(r._serverState==="disconnected")return;r._serverState="disconnected";if(typeof n=="function"){var e=n;n=null;e(new Error("connection closed"),null,r)}else r.isSetMember()?r.listeners("close")&&r.listeners("close").length>0&&r.emit("close",new Error("connection closed"),r):i.listeners("close")&&i.listeners("close").length>0&&i.emit("close",new Error("connection closed"),r);if(!r.isSetMember()){_fireCallbackErrors(r,new Error("connection closed"));_emitAcrossAllDbInstances(r,i,"close",r,null,!0)}});s.on("parseError",function(e){if(r._serverState==="disconnected")return;r._serverState="disconnected";if(typeof n=="function"){var t=n;n=null;t(new Error("connection closed due to parseError"),null,r)}else r.isSetMember()?r.listeners("parseError")&&r.listeners("parseError").length>0&&r.emit("parseError",new Error("connection closed due to parseError"),r):i.listeners("parseError")&&i.listeners("parseError").length>0&&i.emit("parseError",new Error("connection closed due to parseError"),r);if(!r.isSetMember()){_fireCallbackErrors(r,new Error("connection closed due to parseError"));_emitAcrossAllDbInstances(r,i,"parseError",r,null,!0)}});s.start()};var _fireCallbackErrors=function(e,t){for(var n=0;n<e.dbInstances.length;n++){var r=e.dbInstances[n],i=Object.keys(r._callBackStore._notReplied);for(var s=0;s<i.length;s++){var o=r._callBackStore._notReplied[i[s]];if(o&&o.chained&&Array.isArray(o.chained)&&o.chained.length>0){var u=o.chained,a=u.pop();o.connection.socketOptions.host===e.host&&o.connection.socketOptions.port===e.port&&r._callBackStore.emit(a,t,null);u.push(a);for(var n=0;n<u.length;n++)delete r._callBackStore._notReplied[u[n]]}else o&&o.connection.socketOptions.host===e.host&&o.connection.socketOptions.port===e.port&&r._callBackStore.emit(i[s],t,null)}}},_emitAcrossAllDbInstances=function(e,t,n,r,i,s){var o=e.allServerInstances(),u=o[0];if(Array.isArray(u.dbInstances)&&u.dbInstances.length>=1)for(var a=0;a<u.dbInstances.length;a++){var f=u.dbInstances[a];s&&typeof f.openCalled!="undefined"&&(f.openCalled=!1);(t==null||t.databaseName!==f.databaseName||t.tag!==f.tag)&&f.listeners(n).length>0&&f.emit(n,r,i)}};Server.prototype.allRawConnections=function(){return this.connectionPool.getAllConnections()};var canCheckoutWriter=function(e,t){return e.isMasterDoc["arbiterOnly"]==1?new Error("Cannot write to an arbiter"):e.isMasterDoc["secondary"]==1?new Error("Cannot write to a secondary"):t==1&&e._readPreference==ReadPreference.SECONDARY&&e.isMasterDoc["ismaster"]==1?new Error("Cannot read from primary when secondary only specified"):null};Server.prototype.checkoutWriter=function(e){if(e==1)return this.connectionPool.checkoutConnection();var t=canCheckoutWriter(this,e);return t==null&&this.connectionPool!=null?this.connectionPool.checkoutConnection():t==null?null:t};var canCheckoutReader=function(e){if(e.isMasterDoc&&e.isMasterDoc["arbiterOnly"]==1)return new Error("Cannot write to an arbiter");if(e._readPreference!=null){if(e._readPreference==ReadPreference.PRIMARY&&e.isMasterDoc["ismaster"]!=1)return new Error("Read preference is Server.PRIMARY and server is not master");if(e._readPreference==ReadPreference.SECONDARY&&e.isMasterDoc["ismaster"]==1)return new Error("Cannot read from primary when secondary only specified")}return null};Server.prototype.checkoutReader=function(){var e=canCheckoutReader(this);return e==null&&this.connectionPool!=null?this.connectionPool.checkoutConnection():e==null?null:e};Server.prototype.enableRecordQueryStats=function(e){this.recordQueryStats=e};var RunningStats=function(){var e=this;this.m_n=0;this.m_oldM=0;this.m_oldS=0;this.m_newM=0;this.m_newS=0;Object.defineProperty(this,"numDataValues",{enumerable:!0,get:function(){return this.m_n}});Object.defineProperty(this,"mean",{enumerable:!0,get:function(){return this.m_n>0?this.m_newM:0}});Object.defineProperty(this,"variance",{enumerable:!0,get:function(){return this.m_n>1?this.m_newS/(this.m_n-1):0}});Object.defineProperty(this,"standardDeviation",{enumerable:!0,get:function(){return Math.sqrt(this.variance)}});Object.defineProperty(this,"sScore",{enumerable:!0,get:function(){var e=this.mean+this.standardDeviation;return e==0?0:2*this.mean*this.standardDeviation/e}})};RunningStats.prototype.push=function(e){this.m_n=this.m_n+1;if(this.m_n==1){this.m_oldM=this.m_newM=e;this.m_oldS=0}else{this.m_newM=this.m_oldM+(e-this.m_oldM)/this.m_n;this.m_newS=this.m_oldS+(e-this.m_oldM)*(e-this.m_newM);this.m_oldM=this.m_newM;this.m_oldS=this.m_newS}};Object.defineProperty(Server.prototype,"autoReconnect",{enumerable:!0,get:function(){return this.options["auto_reconnect"]==null?!1:this.options.auto_reconnect}});Object.defineProperty(Server.prototype,"connection",{enumerable:!0,get:function(){return this.internalConnection},set:function(e){this.internalConnection=e}});Object.defineProperty(Server.prototype,"master",{enumerable:!0,get:function(){return this.internalMaster},set:function(e){this.internalMaster=e}});Object.defineProperty(Server.prototype,"primary",{enumerable:!0,get:function(){return this}});Object.defineProperty(Server.prototype,"queryStats",{enumerable:!0,get:function(){return this._state.runtimeStats.queryStats}});Object.defineProperty(Server.prototype,"runtimeStats",{enumerable:!0,get:function(){return this._state.runtimeStats}});Object.defineProperty(Server.prototype,"readPreference",{enumerable:!0,get:function(){return this._readPreference==null&&this.readSecondary?Server.READ_SECONDARY:this._readPreference==null&&!this.readSecondary?Server.READ_PRIMARY:this._readPreference}});exports.Server=Server;