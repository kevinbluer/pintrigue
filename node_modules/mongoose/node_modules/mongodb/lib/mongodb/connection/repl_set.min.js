var Connection=require("./connection").Connection,ReadPreference=require("./read_preference").ReadPreference,DbCommand=require("../commands/db_command").DbCommand,MongoReply=require("../responses/mongo_reply").MongoReply,debug=require("util").debug,EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,inspect=require("util").inspect,Server=require("./server").Server,PingStrategy=require("./strategies/ping_strategy").PingStrategy,StatisticsStrategy=require("./strategies/statistics_strategy").StatisticsStrategy;const STATE_STARTING_PHASE_1=0,STATE_PRIMARY=1,STATE_SECONDARY=2,STATE_RECOVERING=3,STATE_FATAL_ERROR=4,STATE_STARTING_PHASE_2=5,STATE_UNKNOWN=6,STATE_ARBITER=7,STATE_DOWN=8,STATE_ROLLBACK=9;var ReplSet=exports.ReplSet=function(e,t){this.count=0;if(!(this instanceof ReplSet))return new ReplSet(e,t);EventEmitter.call(this);for(var n=0;n<e.length;n++)if(!(e[n]instanceof Server))throw new Error("list of servers must be of type Server");var r=this;this.options=t==null?{}:t;this.reconnectWait=this.options["reconnectWait"]!=null?this.options.reconnectWait:1e3;this.retries=this.options["retries"]!=null?this.options.retries:30;this.replicaSet=this.options.rs_name;this.readSecondary=this.options.read_secondary;this.slaveOk=!0;this.closedConnectionCount=0;this._used=!1;this.connectArbiter=this.options.connectArbiter==null?!1:this.options.connectArbiter;this.poolSize=this.options.poolSize==null?5:this.options.poolSize;this._currentServerChoice=0;this.ssl=this.options.ssl==null?!1:this.options.ssl;this.eventHandlers={error:[],parseError:[],poolReady:[],message:[],close:[],timeout:[]};this._serverState="disconnected";this._readPreference=null;this._numberOfServersLeftToInitialize=0;this.recordQueryStats=!1;var i=this.options.readPreference;if(i!=null){if(i!=ReadPreference.PRIMARY&&i!=ReadPreference.PRIMARY_PREFERRED&&i!=ReadPreference.SECONDARY&&i!=ReadPreference.SECONDARY_PREFERRED&&i!=ReadPreference.NEAREST&&typeof i!="object"&&i["_type"]!="ReadPreference")throw new Error("Illegal readPreference mode specified, "+i);this._readPreference=i}else this._readPreference=null;this.secondaryAcceptableLatencyMS=this.options["secondaryAcceptableLatencyMS"]==null?15:this.options.secondaryAcceptableLatencyMS;this.strategy=this.options.strategy;if(this.strategy!=null&&this.strategy!="ping"&&this.strategy!="statistical")throw new Error("Only ping or statistical strategies allowed");if(this.strategy=="ping")this.strategyInstance=new PingStrategy(this,this.secondaryAcceptableLatencyMS);else if(this.strategy=="statistical"){this.strategyInstance=new StatisticsStrategy(this);this.enableRecordQueryStats(!0)}this.socketOptions=this.options.socketOptions!=null?this.options.socketOptions:{};this.logger=this.options.logger!=null&&typeof this.options.logger.debug=="function"&&typeof this.options.logger.error=="function"&&typeof this.options.logger.debug=="function"?this.options.logger:{error:function(e,t){},log:function(e,t){},debug:function(e,t){}};if(!Array.isArray(e)||e.length==0)throw Error("The parameter must be an array of servers and contain at least one server");if(Array.isArray(e)||e.length>0){var s=0;e.forEach(function(e){e instanceof Server&&(s+=1);e.options.auto_reconnect=!1});if(s<e.length)throw Error("All server entries must be of type Server");this.servers=e}var o={};for(var n=0;n<this.servers.length;n++){var u=this.servers[n];o[u.host+":"+u.port]==null&&(o[u.host+":"+u.port]=u)}this.servers=[];for(var a in o)this.servers.push(o[a]);this.haEnabled=this.options["ha"]==null?!0:this.options.ha;this.replicasetStatusCheckInterval=this.options["haInterval"]==null?1e3:this.options.haInterval;this._replicasetTimeoutId=null;this._connectTimeoutMS=1e3;this.pingCandidateServers=[];this.lastReplicaSetTime=(new Date).getTime()};inherits(ReplSet,EventEmitter);ReplSet.prototype.setReadPreference=function(e){this._readPreference=e;if(this._readPreference==ReadPreference.SECONDARY_PREFERRED||this._readPreference==ReadPreference.SECONDARY||this._readPreference!=null&&typeof this._readPreference=="object")this.slaveOk=!0};ReplSet.prototype._isUsed=function(){return this._used};ReplSet.prototype.isMongos=function(){return!1};ReplSet.prototype.isConnected=function(){return this.primary!=null&&this._state.master!=null&&this._state.master.isConnected()};ReplSet.prototype.isSetMember=function(){return!1};ReplSet.prototype.isPrimary=function(e){return this.readSecondary&&Object.keys(this._state.secondaries).length>0?!1:!0};ReplSet.prototype.isReadPrimary=ReplSet.prototype.isPrimary;ReplSet.prototype._checkReplicaSet=function(){if(!this.haEnabled)return!1;var e=(new Date).getTime();if(e-this.lastReplicaSetTime>=this.replicasetStatusCheckInterval){this.lastReplicaSetTime=e;return!0}return!1};ReplSet.prototype.allServerInstances=function(){var e=this,t=e._state.master!=null?[e._state.master]:[],n=Object.keys(e._state.secondaries);for(var r=0;r<n.length;r++)t.push(e._state.secondaries[n[r]]);var n=Object.keys(e._state.arbiters);for(var r=0;r<n.length;r++)t.push(e._state.arbiters[n[r]]);var n=Object.keys(e._state.passives);for(var r=0;r<n.length;r++)t.push(e._state.passives[n[r]]);return t};var __executeAllCallbacksWithError=function(e,t){var n=Object.keys(e._callBackStore._notReplied);for(var r=0;r<n.length;r++){delete e._callBackStore._notReplied[n[r]];e._callBackStore.emit(n[r],t)}};ReplSet.prototype._validateReplicaset=function(e,t){var n=this,r=e.documents[0].members,r=Array.isArray(e.documents[0].members)?e.documents[0].members:[],i={};for(var s=0,o=r.length;s<o;s++){var u=r[s];if(u["health"]!=0&&null==n._state["addresses"][u["name"]]&&null==i[u["name"]]){if(u["stateStr"]=="ARBITER"&&n.connectArbiter!=1)continue;var a=u.name.split(/:/);a.length==1&&(a=[a[0],Connection.DEFAULT_PORT]);var f={host:a[0],port:parseInt(a[1],10)};if(n.socketOptions!=null){var l=Object.keys(n.socketOptions);for(var c=0;c<l.length;c++)f[l[s]]=n.socketOptions[l[s]]}var h=new Server(a[0],parseInt(a[1],10),{auto_reconnect:!1,socketOptions:f,logger:n.logger,ssl:n.ssl,poolSize:n.poolSize});h.replicasetInstance=n;h.on("close",_handler("close",n));h.on("error",_handler("error",n));h.on("timeout",_handler("timeout",n));i[u.name]=h}else if(u["stateStr"]=="PRIMARY"&&n._state.master["name"]!=u["name"]){delete n._state.addresses[n._state.master.name];var p=n._state.addresses[u.name];p.isMasterDoc.ismaster=!0;p.isMasterDoc.secondary=!1;n._state.master=p;delete n._state.secondaries[u.name];p=null}}var d=Object.keys(i);while(d.length>0){var v=d.pop(),m=i[v],g=_connectHandler(n,null,m);m.connect(n.db,{returnIsMasterResults:!0,eventReceiver:h},function(e,r,i){if(e==null&&r!=null){var s=r.documents[0];s.ismaster||s.secondary||s.arbiterOnly?process.nextTick(function(){if(Array.isArray(t)&&t.length>0){var s=t.length;for(var o=0;o<t.length;o++)n.db.authenticate(t[o].username,t[o].password,{authdb:t[o].authdb},function(e,t){s-=1;s==0&&g(e,r,i)})}else g(e,r,i)}):i.close()}else i.close()})}};var _handler=function(e,t){return function(n,r){if(t._state.master&&t._state.master.name==r.name){t.close();__executeAllCallbacksWithError(t.db,n)}else if(t._state.master&&(t._state.secondaries[r.name]!=null||t._state.arbiters[r.name]!=null||t._state.passives[r.name]!=null)){delete t._state.secondaries[r.name];delete t._state.arbiters[r.name];delete t._state.passives[r.name];delete t._state.addresses[r.name]}t._state.master&&t._state.master.host==r.host&&t._state.master.port==r.port&&t.db.listeners(e).length>0&&t.db.emit(e,n)}},_connectHandler=function(e,t,n){return function(r,s){if(e._serverState=="disconnected")return n.close();if(r==null&&s.documents[0].hosts!=null){var o=s.documents[0],u=o.setName,a=o.ismaster,f=o.secondary,l=o.passive,c=o.arbiterOnly,h=Array.isArray(o.hosts)?o.hosts:[],p=Array.isArray(o.arbiters)?o.arbiters:[],d=Array.isArray(o.passives)?o.passives:[],v=o.tags?o.tags:{},m=o.primary,g=n.host+":"+n.port,y=o.me||g;if(e.replicaSet==null)e.replicaSet=u;else if(e.replicaSet!=u){e.close();return e.emit("connectionError",new Error("configured mongodb replicaset does not match provided replicaset ["+u+"] != ["+e.replicaSet+"]"))}delete e._state.addresses[n.host+":"+n.port];e._state.addresses[y]=n;f!=1||l!=0&&l!=null?c==1?e._state.arbiters[y]=n:f==1&&l==1?e._state.passives[y]=n:a==1?e._state.master=n:a==0&&m!=null&&e._state.addresses[m]&&(e._state.master=e._state.addresses[m]):e._state.secondaries[y]=n;n.name=y;n.tags=v;n.on("close",_handler("close",e));n.on("error",_handler("error",e));n.on("timeout",_handler("timeout",e));var b=Array.isArray(h)?h.slice():[];b=Array.isArray(d)?b.concat(d):b;e.connectArbiter==1&&(b=Array.isArray(p)?b.concat(p):b);if(Array.isArray(t))for(var w=0;w<b.length;w++)if(e._state.addresses[b[w]]==null&&b[w]!=null){var E=b[w].split(/:/);E.length==1&&(E=[E[0],Connection.DEFAULT_PORT]);var S=new Server(E[0],parseInt(E[1]));S.name=b[w];e._state.addresses[b[w]]=S;t.push(S)}}else if(r!=null||e._serverState=="disconnected"){delete e._state.addresses[n.host+":"+n.port];n.close()}if(Array.isArray(t)&&t.length>0){var x=t.pop(),T=e._state.addresses,N={};if(e.socketOptions!=null&&typeof e.socketOptions=="object"){var C=Object.keys(e.socketOptions);for(var w=0;w<C.length;w++)N[C[w]]=e.socketOptions[C[w]]}e.ssl&&(serverConnections[i].ssl=!0);N.connectTimeoutMS=e._connectTimeoutMS;N.host=x.host;N.port=x.port;x.socketOptions=N;x.replicasetInstance=e;x.enableRecordQueryStats(e.recordQueryStats);T[x.host+":"+x.port]=x;x.connect(e.db,{returnIsMasterResults:!0,eventReceiver:x},_connectHandler(e,t,x))}else if(Array.isArray(t)){if(e._state.master==null){e.close();return e.emit("connectionError",new Error("no primary server found in set"))}e.emit("fullsetup",null,e.db,e);e.emit("open",null,e.db,e)}}};ReplSet.prototype.connect=function(e,t,n){var r=this;"function"==typeof t&&(n=t,t={});t==null&&(t={});"function"!=typeof n&&(n=null);r.close();this.db=e;this._serverState="connecting";this._callbackList=[];this._state={master:null,secondaries:{},arbiters:{},passives:{},errors:{},addresses:{},setName:null,errorMessages:[],members:[]};e.slaveOk=this.slaveOk?this.slaveOk:e.slaveOk;this.removeAllListeners("fullsetup");this.removeAllListeners("connectionError");this.once("fullsetup",function(){r._serverState="connected";e.emit("open",null,r.db,r);e.emit("fullsetup",null,r.db,r);if(typeof n=="function"){var t=n;n=null;t(null,e,r)}});this.once("connectionError",function(t){r._serverState="disconnected";r.close();if(typeof n=="function"){var i=n;n=null;i(t,e,r)}});var i=this._state.addresses,s={};if(this.socketOptions!=null&&typeof this.socketOptions=="object"){var o=Object.keys(this.socketOptions);for(var u=0;u<o.length;u++)s[o[u]]=this.socketOptions[o[u]]}this.ssl&&(serverConnections[f].ssl=!0);s.connectTimeoutMS=this._connectTimeoutMS;var a;for(var f=0;f<this.servers.length;f++){a=this.servers[f];s.host=a.host;s.port=a.port;a.socketOptions=s;a.replicasetInstance=this;a.enableRecordQueryStats(this.recordQueryStats);i[a.host+":"+a.port]==null&&(i[a.host+":"+a.port]=a)}var l=[];for(var c in i)l.push(i[c]);a=l.pop();a.connect(e,{returnIsMasterResults:!0,eventReceiver:a},_connectHandler(this,l,a))};ReplSet.prototype.checkoutWriter=function(){var e=this._state.master!=null?this._state.master.checkoutWriter():null;return e};var pickFirstConnectedSecondary=function(t,n){var r=Object.keys(t._state.secondaries),i=null;for(var s=0;s<r.length;s++){i=t._state.secondaries[r[s]].checkoutReader();if(i!=null)break}t._readPreference==ReadPreference.SECONDARY_PREFERRED&&(i=t._state.master.checkoutReader());if(i==null){var o=t._readPreference==ReadPreference.SECONDARY_PREFERRED?"secondary":t._readPreference;return new Error("No replica set member available for query with ReadPreference "+o+" and tags "+JSON.stringify(n))}return i},_pickFromTags=function(e,t){var n=Array.isArray(t)?t:[t];for(var r=0;r<n.length;r++){var i=n[r],s=Object.keys(i),o=Object.keys(e._state.secondaries),u=[];for(var a=0;a<o.length;a++){var f=e._state.secondaries[o[a]];if(f.tags!=null){var l=!0;for(var c=0;c<s.length;c++)if(f.tags[s[c]]!=i[s[c]]){l=!1;break}l&&u.push(f)}}if(u.length>0)return this.strategyInstance?this.strategyInstance.checkoutSecondary(t,u):u[Math.floor(Math.random()*u.length)].checkoutReader()}return null};ReplSet.prototype.checkoutReader=function(e,t){var n=null;if(typeof e=="object"&&e["_type"]=="ReadPreference"){if(!e.isValid())throw new Error("Illegal readPreference mode specified, "+e.mode);t=e.tags;e=e.mode}else if(typeof e=="object"&&e["_type"]!="ReadPreference")throw new Error("read preferences must be either a string or an instance of ReadPreference");var r=e!=null?e:this._readPreference;r=r==1?ReadPreference.SECONDARY_PREFERRED:r;if(r=="primary")return typeof t=="object"&&t!=null?new Error("PRIMARY cannot be combined with tags"):this._state.master==null?new Error("No replica set primary available for query with ReadPreference PRIMARY"):this.checkoutWriter();if((this.readSecondary||r==ReadPreference.SECONDARY_PREFERRED||r==ReadPreference.SECONDARY)&&Object.keys(this._state.secondaries).length>0)if(t!=null&&typeof t=="object"){n=_pickFromTags(this,t);if(n==null)return new Error("No replica set members available for query")}else{var i=Object.keys(this._state.secondaries);this._currentServerChoice=this._currentServerChoice%i.length;var s=i[this._currentServerChoice++];n=this._state.secondaries[s]!=null?this._state.secondaries[s].checkoutReader():null;n=n==null?pickFirstConnectedSecondary(this,t):n}else if(r==ReadPreference.PRIMARY_PREFERRED){n=this.checkoutWriter();if(n==null)if(t!=null&&typeof t=="object"){n=_pickFromTags(this,t);if(n==null)return new Error("No replica set members available for query")}else{var i=Object.keys(this._state.secondaries);this._currentServerChoice=this._currentServerChoice%i.length;var s=i[this._currentServerChoice++];n=this._state.secondaries[s]!=null?this._state.secondaries[s].checkoutReader():null;n=n==null?pickFirstConnectedSecondary(this,t):n}}else if(r==ReadPreference.SECONDARY_PREFERRED&&t==null&&Object.keys(this._state.secondaries).length==0){n=this.checkoutWriter();if(n==null){var o=r==ReadPreference.SECONDARY?"secondary":r;n=new Error("No replica set member available for query with ReadPreference "+o+" and tags "+JSON.stringify(t))}}else if(r==ReadPreference.SECONDARY_PREFERRED)if(t!=null&&typeof t=="object"){n=_pickFromTags(this,t);if(n==null){n=this.checkoutWriter();if(n==null)return new Error("No replica set members available for query")}}else this.strategyInstance!=null&&(n=this.strategyInstance.checkoutReader(t));else if(r==ReadPreference.NEAREST&&this.strategyInstance!=null)n=this.strategyInstance.checkoutSecondary(t);else{if(r==ReadPreference.NEAREST&&this.strategyInstance==null)return new Error("A strategy for calculating nearness must be enabled such as ping or statistical");if(r==ReadPreference.SECONDARY&&Object.keys(this._state.secondaries).length==0)if(t!=null&&typeof t=="object"){var o=r==ReadPreference.SECONDARY?"secondary":r;n=new Error("No replica set member available for query with ReadPreference "+o+" and tags "+JSON.stringify(t))}else n=new Error("No replica set secondary available for query with ReadPreference SECONDARY");else n=this.checkoutWriter()}return n};ReplSet.prototype.allRawConnections=function(){var e=[];if(this._state.master==null)return[];var t=this._state.master.connectionPool.getAllConnections();e=e.concat(t);if(this.readSecondary&&Object.keys(this._state.secondaries).length>0){var n=Object.keys(this._state.secondaries);for(var r=0;r<n.length;r++){var i=this._state.secondaries[n[r]].connectionPool.getAllConnections();e=e.concat(i)}}return e};ReplSet.prototype.enableRecordQueryStats=function(e){this.recordQueryStats=e;if(this._state!=null&&this._state.addresses!=null){var t=Object.keys(this._state.addresses);for(var n=0;n<t.length;n++)this._state.addresses[t[n]].enableRecordQueryStats(e)}else if(Array.isArray(this.servers))for(var n=0;n<this.servers.length;n++)this.servers[n].enableRecordQueryStats(e)};ReplSet.prototype.disconnect=function(e){this.close(e)};ReplSet.prototype.close=function(e){var t=this;this._serverState="disconnected";if(this._state&&this._state.addresses)for(var n in this._state.addresses)this._state.addresses[n].close();typeof e=="function"&&e(null,null)};Object.defineProperty(ReplSet.prototype,"autoReconnect",{enumerable:!0,get:function(){return!0}});Object.defineProperty(ReplSet.prototype,"readPreference",{enumerable:!0,get:function(){return this._readPreference==null&&this.readSecondary?ReadPreference.SECONDARY_PREFERRED:this._readPreference==null&&!this.readSecondary?ReadPreference.PRIMARY:this._readPreference}});Object.defineProperty(ReplSet.prototype,"dbInstances",{enumerable:!0,get:function(){var e=this.allServerInstances();return e.length>0?e[0].dbInstances:[]}});Object.defineProperty(ReplSet.prototype,"host",{enumerable:!0,get:function(){if(this.primary!=null)return this.primary.host}});Object.defineProperty(ReplSet.prototype,"port",{enumerable:!0,get:function(){if(this.primary!=null)return this.primary.port}});Object.defineProperty(ReplSet.prototype,"read",{enumerable:!0,get:function(){return this.secondaries.length>0?this.secondaries[0]:null}});Object.defineProperty(ReplSet.prototype,"secondaries",{enumerable:!0,get:function(){var e=Object.keys(this._state.secondaries),t=new Array(e.length);for(var n=0;n<e.length;n++)t[n]=this._state.secondaries[e[n]];return t}});Object.defineProperty(ReplSet.prototype,"allSecondaries",{enumerable:!0,get:function(){return this.secondaries.concat(this.passives)}});Object.defineProperty(ReplSet.prototype,"arbiters",{enumerable:!0,get:function(){var e=Object.keys(this._state.arbiters),t=new Array(e.length);for(var n=0;n<e.length;n++)t[n]=this._state.arbiters[e[n]];return t}});Object.defineProperty(ReplSet.prototype,"passives",{enumerable:!0,get:function(){var e=Object.keys(this._state.passives),t=new Array(e.length);for(var n=0;n<e.length;n++)t[n]=this._state.passives[e[n]];return t}});Object.defineProperty(ReplSet.prototype,"primary",{enumerable:!0,get:function(){return this._state!=null?this._state.master:null}});exports.ReplSetServers=ReplSet;