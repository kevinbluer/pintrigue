var utils=require("./connection_utils"),inherits=require("util").inherits,net=require("net"),EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,binaryutils=require("../utils"),tls=require("tls"),Connection=exports.Connection=function(e,t){EventEmitter.call(this);this.socketOptions=t?t:{host:"localhost",port:27017};this.id=e;this.connected=!1;this.maxBsonSize=t.maxBsonSize?t.maxBsonSize:Connection.DEFAULT_MAX_BSON_SIZE;this.buffer=null;this.sizeOfMessage=0;this.bytesRead=0;this.stubBuffer=0;this.eventHandlers={error:[],parseError:[],poolReady:[],message:[],close:[],timeout:[],end:[]};resetHandlers(this,!1)};Connection.DEFAULT_MAX_BSON_SIZE=4194304;inherits(Connection,EventEmitter);Connection.prototype.start=function(){if(this.socketOptions.ssl){this.connection=new net.Socket;this.connection.setTimeout(this.socketOptions.connectTimeoutMS!=null?this.socketOptions.connectTimeoutMS:this.socketOptions.timeout);process.version.indexOf("v0.4")==-1&&this.connection.setNoDelay(this.socketOptions.noDelay);process.version.indexOf("v0.4")==-1&&(this.socketOptions.keepAlive>0?this.connection.setKeepAlive(!0,this.socketOptions.keepAlive):this.connection.setKeepAlive(!1));var e=this.pair=tls.createSecurePair(!1);this.pair.encrypted.pipe(this.connection);this.connection.pipe(this.pair.encrypted);this.writeSteam=this.pair.cleartext;this.pair.on("secure",connectHandler(this));this.pair.cleartext.on("data",createDataHandler(this));this.connection.on("error",errorHandler(this));this.connection.on("end",endHandler(this));this.connection.on("timeout",timeoutHandler(this));this.connection.on("drain",drainHandler(this));this.writeSteam.on("close",closeHandler(this));this.connection.connect(this.socketOptions.port,this.socketOptions.host)}else{this.connection=net.createConnection(this.socketOptions.port,this.socketOptions.host);this.connection.setTimeout(this.socketOptions.connectTimeoutMS!=null?this.socketOptions.connectTimeoutMS:this.socketOptions.timeout);process.version.indexOf("v0.4")==-1&&this.connection.setNoDelay(this.socketOptions.noDelay);process.version.indexOf("v0.4")==-1&&(this.socketOptions.keepAlive>0?this.connection.setKeepAlive(!0,this.socketOptions.keepAlive):this.connection.setKeepAlive(!1));this.writeSteam=this.connection;this.connection.on("error",errorHandler(this));this.connection.on("connect",connectHandler(this));this.connection.on("data",createDataHandler(this));this.connection.on("timeout",timeoutHandler(this));this.connection.on("drain",drainHandler(this));this.connection.on("close",closeHandler(this))}};Connection.prototype.isConnected=function(){return this.connected&&!this.connection.destroyed&&this.connection.writable&&this.connection.readable};Connection.prototype.write=function(e,t){try{if(Array.isArray(e))for(var n=0;n<e.length;n++){var r=e[n].toBinary();if(!this.socketOptions.disableDriverBSONSizeCheck&&r.length>this.maxBsonSize)return t(new Error("Document exceeds maximal allowed bson size of "+this.maxBsonSize+" bytes"));this.logger!=null&&this.logger.doDebug&&this.logger.debug("writing command to mongodb",r);var i=this.writeSteam.write(r)}else{var r=e.toBinary();if(!this.socketOptions.disableDriverBSONSizeCheck&&r.length>this.maxBsonSize)return t(new Error("Document exceeds maximal allowed bson size of "+this.maxBsonSize+" bytes"));this.logger!=null&&this.logger.doDebug&&this.logger.debug("writing command to mongodb",r);var i=this.writeSteam.write(r)}}catch(s){typeof t=="function"&&t(s)}};Connection.prototype.close=function(){resetHandlers(this,!0);this.connection.on("error",function(){});this.connection.destroy()};var resetHandlers=function(e,t){e.eventHandlers={error:[],connect:[],close:[],end:[],timeout:[],parseError:[],message:[]};if(t&&e.connection!=null){var n=Object.keys(e.eventHandlers);for(var r=0;r<n.length;r++)e.connection.removeAllListeners(n[r])}},connectHandler=function(e){return function(){e.connected=!0;e.connection.setTimeout(e.socketOptions.socketTimeoutMS!=null?e.socketOptions.socketTimeoutMS:e.socketOptions.timeout);e.emit("connect",null,e)}},createDataHandler=exports.Connection.createDataHandler=function(e){return function(t){while(t.length>0)if(e.bytesRead>0&&e.sizeOfMessage>0){var n=e.sizeOfMessage-e.bytesRead;if(n>t.length){t.copy(e.buffer,e.bytesRead);e.bytesRead=e.bytesRead+t.length;t=new Buffer(0)}else{t.copy(e.buffer,e.bytesRead,0,n);t=t.slice(n);try{var r=e.buffer;e.buffer=null;e.sizeOfMessage=0;e.bytesRead=0;e.stubBuffer=null;e.emit("message",r,e)}catch(i){var s={err:"socketHandler",trace:i,bin:buffer,parseState:{sizeOfMessage:e.sizeOfMessage,bytesRead:e.bytesRead,stubBuffer:e.stubBuffer}};e.logger!=null&&e.logger.doError&&e.logger.error("parseError",s);e.emit("parseError",s,e)}}}else if(e.stubBuffer!=null&&e.stubBuffer.length>0)if(e.stubBuffer.length+t.length>4){var o=new Buffer(e.stubBuffer.length+t.length);e.stubBuffer.copy(o,0);t.copy(o,e.stubBuffer.length);t=o;e.buffer=null;e.sizeOfMessage=0;e.bytesRead=0;e.stubBuffer=null}else{var u=new Buffer(e.stubBuffer.length+t.length);e.stubBuffer.copy(u,0);t.copy(u,e.stubBuffer.length);t=new Buffer(0)}else if(t.length>4){var a=binaryutils.decodeUInt32(t,0);if(a<0||a>e.maxBsonSize){var s={err:"socketHandler",trace:"",bin:e.buffer,parseState:{sizeOfMessage:a,bytesRead:e.bytesRead,stubBuffer:e.stubBuffer}};e.logger!=null&&e.logger.doError&&e.logger.error("parseError",s);e.emit("parseError",s,e);return}if(a>4&&a<e.maxBsonSize&&a>t.length){e.buffer=new Buffer(a);t.copy(e.buffer,0);e.bytesRead=t.length;e.sizeOfMessage=a;e.stubBuffer=null;t=new Buffer(0)}else if(a>4&&a<e.maxBsonSize&&a==t.length)try{var r=t;e.buffer=null;e.sizeOfMessage=0;e.bytesRead=0;e.stubBuffer=null;t=new Buffer(0);e.emit("message",r,e)}catch(i){var s={err:"socketHandler",trace:i,bin:e.buffer,parseState:{sizeOfMessage:e.sizeOfMessage,bytesRead:e.bytesRead,stubBuffer:e.stubBuffer}};e.logger!=null&&e.logger.doError&&e.logger.error("parseError",s);e.emit("parseError",s,e)}else if(a<=4||a>e.maxBsonSize){var s={err:"socketHandler",trace:null,bin:t,parseState:{sizeOfMessage:a,bytesRead:0,buffer:null,stubBuffer:null}};e.logger!=null&&e.logger.doError&&e.logger.error("parseError",s);e.emit("parseError",s,e);e.buffer=null;e.sizeOfMessage=0;e.bytesRead=0;e.stubBuffer=null;t=new Buffer(0)}else try{var r=t.slice(0,a);e.buffer=null;e.sizeOfMessage=0;e.bytesRead=0;e.stubBuffer=null;t=t.slice(a);e.emit("message",r,e)}catch(i){var s={err:"socketHandler",trace:i,bin:e.buffer,parseState:{sizeOfMessage:a,bytesRead:e.bytesRead,stubBuffer:e.stubBuffer}};e.logger!=null&&e.logger.doError&&e.logger.error("parseError",s);e.emit("parseError",s,e)}}else{e.stubBuffer=new Buffer(t.length);t.copy(e.stubBuffer,0);t=new Buffer(0)}}},endHandler=function(e){return function(){e.connected=!1;e.emit("end",{err:"connection received Fin packet from ["+e.socketOptions.host+":"+e.socketOptions.port+"]"},e)}},timeoutHandler=function(e){return function(){e.emit("timeout",{err:"connection to ["+e.socketOptions.host+":"+e.socketOptions.port+"] timed out"},e)}},drainHandler=function(e){return function(){}},errorHandler=function(e){return function(t){e.connected=!1;e.emit("error",{err:"failed to connect to ["+e.socketOptions.host+":"+e.socketOptions.port+"]"},e)}},closeHandler=function(e){return function(t){if(t&&!e.connected){e.connected=!1;e.emit("error",{err:"failed to connect to ["+e.socketOptions.host+":"+e.socketOptions.port+"]"},e)}else{e.connected=!1;e.emit("close",{err:"connection closed to ["+e.socketOptions.host+":"+e.socketOptions.port+"]"},e)}}};Connection.DEFAULT_PORT=27017;