/**
 * Module dependencies.
 * @ignore
 */function Db(e,t,n){if(!(this instanceof Db))return new Db(e,t,n);EventEmitter.call(this);this.databaseName=e;this.serverConfig=t;this.options=n==null?{}:n;this._applicationClosed=!1;var r=this.options["override_used_flag"]==null?!1:this.options.override_used_flag;if(!r&&typeof this.serverConfig=="object"&&this.serverConfig._isUsed())throw new Error("A Server or ReplSet instance cannot be shared across multiple Db instances");!r&&typeof this.serverConfig=="object"&&(this.serverConfig._used=!0);validateDatabaseName(e);try{this.native_parser=this.options.native_parser;var i=this.bsonLib=this.options.native_parser?require("bson").BSONNative:(new require("bson")).BSONPure,s=i.BSON;this.bson=new s([i.Long,i.ObjectID,i.Binary,i.Code,i.DBRef,i.Symbol,i.Double,i.Timestamp,i.MaxKey,i.MinKey]);this.bson_deserializer=i;this.bson_serializer=i}catch(o){var u="Native bson parser not compiled, please compile or avoid using native_parser=true";throw Error(u)}this._state="disconnected";this.pkFactory=this.options.pk==null?i.ObjectID:this.options.pk;this.forceServerObjectId=this.options.forceServerObjectId!=null?this.options.forceServerObjectId:!1;this.strict=this.options.strict==null?!1:this.options.strict;this.notReplied={};this.isInitializing=!0;this.auths=[];this.openCalled=!1;this.commands=[];this._callBackStore=new CallbackStore;this.logger=this.options.logger!=null&&typeof this.options.logger.debug=="function"&&typeof this.options.logger.error=="function"&&typeof this.options.logger.log=="function"?this.options.logger:{error:function(e,t){},log:function(e,t){},debug:function(e,t){}};this.slaveOk=this.options["slave_ok"]==null?!1:this.options.slave_ok;var a=this;this.serverConfig.logger=this.logger;this.tag=(new Date).getTime();this.eventHandlers={error:[],parseError:[],poolReady:[],message:[],close:[]};this.serializeFunctions=this.options.serializeFunctions!=null?this.options.serializeFunctions:!1;this.raw=this.options.raw!=null?this.options.raw:!1;this.recordQueryStats=this.options.recordQueryStats!=null?this.options.recordQueryStats:!1;this.recordQueryStats==1&&this.serverConfig.enableRecordQueryStats(!0);this.reaperEnabled=this.options.reaper!=null?this.options.reaper:!1;this._lastReaperTimestamp=(new Date).getTime();this.retryMiliSeconds=this.options.retryMiliSeconds!=null?this.options.retryMiliSeconds:1e3;this.numberOfRetries=this.options.numberOfRetries!=null?this.options.numberOfRetries:60;this.reaperInterval=this.options.reaperInterval!=null?this.options.reaperInterval:1e4;this.reaperTimeout=this.options.reaperTimeout!=null?this.options.reaperTimeout:3e4;this.readPreference=this.options.readPreference}function validateDatabaseName(e){if(typeof e!="string")throw new Error("database name must be a string");if(e.length===0)throw new Error("database name cannot be the empty string");var t=[" ",".","$","/","\\"];for(var n=0;n<t.length;n++)if(e.indexOf(t[n])!=-1)throw new Error("database names cannot contain the character '"+t[n]+"'")}var QueryCommand=require("./commands/query_command").QueryCommand,DbCommand=require("./commands/db_command").DbCommand,MongoReply=require("./responses/mongo_reply").MongoReply,Admin=require("./admin").Admin,Collection=require("./collection").Collection,Server=require("./connection/server").Server,ReplSet=require("./connection/repl_set").ReplSet,ReadPreference=require("./connection/read_preference").ReadPreference,Mongos=require("./connection/mongos").Mongos,Cursor=require("./cursor").Cursor,EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,crypto=require("crypto"),CallbackStore=function(){EventEmitter.call(this);this._notReplied={}};inherits(CallbackStore,EventEmitter);var reaper=function(e,t,n){var r=(new Date).getTime();if(r-e._lastReaperTimestamp>=t){e._lastReaperTimestamp=r;var i=Object.keys(e._callBackStore._notReplied);for(var s=0;s<i.length;s++){var o=i[s],u=e._callBackStore._notReplied[o];if(r-u.start>n){delete e._callBackStore._notReplied[o];process.nextTick(function(){e._callBackStore.emit(o,new Error("operation timed out"),null)})}}return!0}return!1};inherits(Db,EventEmitter);Db.prototype.open=function(e){var t=this;if(this.openCalled){this.close();throw new Error("db object already connecting, open cannot be called multiple times")}this.readPreference!=null&&this.serverConfig.setReadPreference(this.readPreference);this.openCalled=!0;t._state="connecting";if(!(t.serverConfig instanceof Server||t.serverConfig instanceof ReplSet||t.serverConfig instanceof Mongos))return e(Error("Server parameter must be of type Server, ReplSet or Mongos"),null);t.serverConfig.connect(t,{firstCall:!0},function(n,r){if(n!=null){t.openCalled=!1;return e(n,null)}t._state="connected";return e(null,t)})};Db.prototype.db=function(e){var t={};for(var n in this.options)t[n]=this.options[n];t.override_used_flag=!0;var r=new Db(e,this.serverConfig,t);this.serverConfig.db&&(r.auths=this.serverConfig.db.auths);var i=this.serverConfig.allServerInstances();for(var s=0;s<i.length;s++){var o=i[s];o.dbInstances.push(r)}return r};Db.prototype.close=function(e,t){var n=this;this._applicationClosed=!1;typeof e=="function"?t=e:typeof e=="boolean"&&(this._applicationClosed=e);this.serverConfig.close(function(e,r){typeof t!="function"&&n.emit("close");var i=n.serverConfig.allServerInstances();if(Array.isArray(i)&&i.length>0){var s=i[0];if(Array.isArray(s.dbInstances)&&s.dbInstances.length>1)for(var o=0;o<s.dbInstances.length;o++){var u=s.dbInstances[o];u.databaseName!==n.databaseName&&u.tag!==n.tag&&s.dbInstances[o].emit("close")}}n.removeAllEventListeners();n.openCalled=!1;t&&t(e,r)})};Db.prototype.admin=function(e){if(e==null)return new Admin(this);e(null,new Admin(this))};Db.prototype.collectionsInfo=function(e,t){if(t==null&&typeof e=="function"){t=e;e=null}var n={};e!=null&&(n.name=this.databaseName+"."+e);if(!t)return new Cursor(this,new Collection(this,DbCommand.SYSTEM_NAMESPACE_COLLECTION),n);t(null,new Cursor(this,new Collection(this,DbCommand.SYSTEM_NAMESPACE_COLLECTION),n))};Db.prototype.collectionNames=function(e,t,n){var r=this,i=Array.prototype.slice.call(arguments,0);n=i.pop();e=i.length?i.shift():null;t=i.length?i.shift():{};if(e!=null&&typeof e=="object"){t=e;e=null}r.collectionsInfo(e,function(e,i){if(e!=null)return n(e,null);i.toArray(function(e,i){if(e!=null)return n(e,null);var s=i.filter(function(e){return e.name.indexOf(r.databaseName)!=-1&&e.name.indexOf("$")==-1});t.namesOnly&&(s=s.map(function(e){return e.name}));n(null,s)})})};Db.prototype.collection=function(e,t,n){var r=this;if(typeof t=="function"){n=t;t={}}if(!(t&&t.safe||this.strict)){try{var i=new Collection(r,e,r.pkFactory,t)}catch(s){if(n==null)throw s;return n(s,null)}return n==null?i:n(null,i)}r.collectionNames(e,function(i,s){if(i!=null)return n(i,null);if(s.length==0)return n(new Error("Collection "+e+" does not exist. Currently in strict mode."),null);try{var o=new Collection(r,e,r.pkFactory,t)}catch(i){return n(i,null)}return n(null,o)})};Db.prototype.collections=function(e){var t=this;t.collectionNames(function(n,r){if(n!=null)return e(n,null);var i=[];r.forEach(function(e){i.push(new Collection(t,e.name.replace(t.databaseName+".",""),t.pkFactory))});e(null,i)})};Db.prototype.eval=function(e,t,n,r){var i=Array.prototype.slice.call(arguments,1);r=i.pop();t=i.length?i.shift():t;n=i.length?i.shift():{};var s=e,o=[];s instanceof this.bsonLib.Code||(s=new this.bsonLib.Code(s));t!=null&&t.constructor!=Array&&typeof t!="function"?o=[t]:t!=null&&t.constructor==Array&&typeof t!="function"&&(o=t);var u={$eval:s,args:o};n.nolock&&(u.nolock=n.nolock);(new Cursor(this,new Collection(this,DbCommand.SYSTEM_COMMAND_COLLECTION),u,n,0,-1)).setReadPreference(ReadPreference.PRIMARY).nextObject(function(e,t){if(e!=null)return r(e,null);if(t.ok!=1){r(new Error("eval failed: "+t.errmsg),null);return}r(null,t.retval)})};Db.prototype.dereference=function(e,t){var n=this;e.db!=null&&(n=this.db(e.db));var r=n.collection(e.namespace);r.findOne({_id:e.oid},function(e,n){t(e,n)})};Db.prototype.logout=function(e,t){var n=this,r=Array.prototype.slice.call(arguments,0);t=r.pop();e=r.length?r.shift():{};var i=this.serverConfig.allRawConnections().length,s=DbCommand.logoutCommand(n,{logout:1},e);n._executeQueryCommand(s,{onAll:!0},function(e,r){i-=1;if(i<=0&&typeof t=="function"){var s=t;t=null;n.auths=[];e==null&&r.documents[0].ok==1?s(null,!0):e!=null?s(e,!1):s(new Error(r.documents[0].errmsg),!1)}})};Db.prototype.authenticate=function(e,t,n,r){var i=this;if(typeof r=="undefined"){r=n;n={}}var s=n.authdb?n.authdb:i.databaseName,o=this.serverConfig.allRawConnections().length,u=null;this._executeQueryCommand(DbCommand.createGetNonceCommand(i),{onAll:!0},function(n,a,f){if(n==null){var l=a.documents[0].nonce;i._executeQueryCommand(DbCommand.createAuthenticationCommand(i,e,t,l,s),{connection:f},function(n,a){o-=1;if(n)u=n;else if(a.documents[0].err!=null||a.documents[0].errmsg!=null)u=i.wrap(a.documents[0]);if(o<=0&&typeof r=="function"){var f=r;r=null;if(u==null&&a.documents[0].ok==1){i.auths=[{username:e,password:t,authdb:s}];f(u,!0)}else f(u,!1)}})}})};Db.prototype.addUser=function(e,t,n,r){var i=this,s=Array.prototype.slice.call(arguments,2);r=s.pop();n=s.length?s.shift():{};var o=i.strict!=null&&i.strict==0?!0:i.strict;o=n!=null&&n["safe"]!=null?n.safe:o;o=o==null?!0:o;var u=crypto.createHash("md5");u.update(e+":mongo:"+t);var a=u.digest("hex"),f=this.collection(DbCommand.SYSTEM_USER_COLLECTION);f.count({},function(t,i){if(t!=null)return r(t,null);f.find({user:e},{dbName:n.dbName}).toArray(function(t,s){if(t!=null)return r(t,null);f.update({user:e},{$set:{user:e,pwd:a}},{safe:o,dbName:n.dbName,upsert:!0},function(t,n){i==0&&t?r(null,[{user:e,pwd:a}]):t?r(t,null):r(null,[{user:e,pwd:a}])})})})};Db.prototype.removeUser=function(e,t,n){var r=this,i=Array.prototype.slice.call(arguments,1);n=i.pop();t=i.length?i.shift():{};var s=r.strict!=null&&r.strict==0?!0:r.strict;s=t!=null&&t["safe"]!=null?t.safe:s;s=s==null?!0:s;var o=this.collection(DbCommand.SYSTEM_USER_COLLECTION);o.findOne({user:e},{dbName:t.dbName},function(r,i){i!=null?o.remove({user:e},{safe:s,dbName:t.dbName},function(e,t){n(e,!0)}):n(r,!1)})};Db.prototype.createCollection=function(e,t,n){var r=Array.prototype.slice.call(arguments,1);n=r.pop();t=r.length?r.shift():null;var i=this,s=i.strict!=null&&i.strict==0?!0:i.strict;s=t!=null&&t["safe"]!=null?t.safe:s;s=s==null?!0:s;this.collectionNames(e,function(r,o){if(r!=null)return n(r,null);var u=!1;o.forEach(function(t){t.name==i.databaseName+"."+e&&(u=!0)});if(u&&(t&&t.safe||i.strict))return n(new Error("Collection "+e+" already exists. Currently in strict mode."),null);if(u){try{var a=new Collection(i,e,i.pkFactory,t)}catch(r){return n(r,null)}return n(null,a)}i._executeQueryCommand(DbCommand.createCreateCollectionCommand(i,e,t),{read:!1,safe:s},function(r,s){var o=s.documents[0];if(r==null&&o.ok==1){try{var u=new Collection(i,e,i.pkFactory,t)}catch(r){return n(r,null)}return n(null,u)}r!=null?n(r,null):n(i.wrap(o),null)})})};Db.prototype.command=function(e,t,n){var r=Array.prototype.slice.call(arguments,1);n=r.pop();t=r.length?r.shift():{};var i=new Cursor(this,new Collection(this,DbCommand.SYSTEM_COMMAND_COLLECTION),e,{},0,-1,null,null,null,null,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,null,null,null,null,null,null,null,null,null,null,null,null,null,t.dbName),s=t.readPreference?t.readPreference:!1;s!=0&&(e.group||e.aggregate||e.collStats||e.dbStats||e.count||e.distinct||e.geoNear||e.geoSearch||e.geoWalk||(e.mapreduce&&e.out="inline")?i.setReadPreference(s):i.setReadPreference(ReadPreference.PRIMARY));i.nextObject(n)};Db.prototype.dropCollection=function(e,t){var n=this;this._executeQueryCommand(DbCommand.createDropCollectionCommand(this,e),function(e,r){if(e==null&&r.documents[0].ok==1){if(t!=null)return t(null,!0)}else t!=null&&(e!=null?t(e,null):t(n.wrap(r.documents[0]),null))})};Db.prototype.renameCollection=function(e,t,n){var r=this;this._executeQueryCommand(DbCommand.createRenameCollectionCommand(this,e,t),function(e,i){if(e==null&&i.documents[0].ok==1){if(n!=null)return n(null,new Collection(r,t,r.pkFactory))}else n!=null&&(e!=null?n(e,null):n(r.wrap(i.documents[0]),null))})};Db.prototype.lastError=function(e,t,n){var r=Array.prototype.slice.call(arguments,0);n=r.pop();e=r.length?r.shift():{};t=r.length?r.shift():{};this._executeQueryCommand(DbCommand.createGetLastErrorCommand(e,this),t,function(e,t){n(e,t&&t.documents)})};Db.prototype.error=Db.prototype.lastError;Db.prototype.lastStatus=Db.prototype.lastError;Db.prototype.previousErrors=function(e,t){var n=Array.prototype.slice.call(arguments,0);t=n.pop();e=n.length?n.shift():{};this._executeQueryCommand(DbCommand.createGetPreviousErrorsCommand(this),e,function(e,n){t(e,n.documents)})};Db.prototype.executeDbCommand=function(e,t,n){if(n==null){n=t;t={}}this._executeQueryCommand(DbCommand.createDbSlaveOkCommand(this,e,t),t,n)};Db.prototype.executeDbAdminCommand=function(e,t,n){if(n==null){n=t;t={}}this._executeQueryCommand(DbCommand.createAdminDbCommand(this,e),t,n)};Db.prototype.resetErrorHistory=function(e,t){var n=Array.prototype.slice.call(arguments,0);t=n.pop();e=n.length?n.shift():{};this._executeQueryCommand(DbCommand.createResetErrorHistoryCommand(this),e,function(e,n){t(e,n.documents)})};Db.prototype.createIndex=function(e,t,n,r){var i=this,s=Array.prototype.slice.call(arguments,2);r=s.pop();n=s.length?s.shift():{};n=typeof r=="function"?n:r;n=n==null?{}:n;var o=n.safe!=null?n.safe:null;o=o==null&&i.strict!=null?i.strict:o;if(o!=null&&o!=0&&typeof r!="function"&&typeof n!="function")throw new Error("safe cannot be used without a callback");var u=DbCommand.createCreateIndexCommand(this,e,t,n),a={};if(!o||o==0){var c=this._executeInsertCommand(u,a);if(!r)return;return c instanceof Error?r(c):r(null,null)}a.read=!1;o==null&&(a.async=!0);a.safe=o;if(typeof o=="object"){var f=Object.keys(o);for(var l=0;l<f.length;l++)a[f[l]]=o[f[l]]}this._executeInsertCommand(u,a,function(e,t){if(e!=null)return r(e,null);t=t&&t.documents;t[0].err?r(i.wrap(t[0])):r(null,u.documents[0].name)})};Db.prototype.ensureIndex=function(e,t,n,r){var i=this;if(typeof r=="undefined"&&typeof n=="function"){r=n;n={}}n==null&&(n={});var s=n.safe!=null?n.safe:null;s=s==null&&i.strict!=null?i.strict:s;if(s!=null&&s!=0&&typeof r!="function"&&typeof n!="function")throw new Error("safe cannot be used without a callback");var o=DbCommand.createCreateIndexCommand(this,e,t,n),u=o.documents[0].name,a={};this.indexInformation(e,function(e,t){if(e!=null)return r(e,null);if(!t[u]){if(!s||s==0){var l=i._executeInsertCommand(o,a);if(!r)return;return l instanceof Error?r(l):r(null,u)}a.read=!1;s==null&&(a.async=!0);a.safe=s;if(typeof s=="object"){var n=Object.keys(s);for(var f=0;f<n.length;f++)a[n[f]]=s[n[f]]}i._executeInsertCommand(o,a,function(e,t){if(typeof r=="function"){if(e!=null)return r(e,null);t=t&&t.documents;t[0].err?r(i.wrap(t[0])):r(null,o.documents[0].name)}})}else if(typeof r=="function")return r(null,u)})};Db.prototype.cursorInfo=function(e,t){var n=Array.prototype.slice.call(arguments,0);t=n.pop();e=n.length?n.shift():{};this._executeQueryCommand(DbCommand.createDbSlaveOkCommand(this,{cursorInfo:1}),e,function(e,n){t(e,n.documents[0])})};Db.prototype.dropIndex=function(e,t,n){this._executeQueryCommand(DbCommand.createDropIndexCommand(this,e,t),n)};Db.prototype.reIndex=function(e,t){this._executeQueryCommand(DbCommand.createReIndexCommand(this,e),function(e,n){e!=null?t(e,!1):n.documents[0].errmsg==null?t(null,!0):t(new Error(n.documents[0].errmsg),!1)})};Db.prototype.indexInformation=function(e,t,n){if(typeof n=="undefined"){if(typeof t=="undefined"){n=e;e=null}else n=t;t={}}var r=t["full"]==null?!1:t.full,i=e!=null?{ns:this.databaseName+"."+e}:{},s=t.readPreference?t.readPreference:ReadPreference.PRIMARY;this.collection(DbCommand.SYSTEM_INDEX_COLLECTION,function(e,t){t.find(i).setReadPreference(s).toArray(function(e,t){if(e!=null)return n(e,null);var i={};if(r)return n(null,t);for(var s=0;s<t.length;s++){var o=t[s];i[o.name]=[];for(var u in o.key)i[o.name].push([u,o.key[u]])}n(null,i)})})};Db.prototype.dropDatabase=function(e){var t=this;this._executeQueryCommand(DbCommand.createDropDatabaseCommand(this),function(n,r){n==null&&r.documents[0].ok==1?e(null,!0):n?e(n,!1):e(t.wrap(r.documents[0]),!1)})};Db.prototype.stats=function(t,n){var r=Array.prototype.slice.call(arguments,0);n=r.pop();t=r.length?r.shift():{};var i={dbStats:this.collectionName};t["scale"]!=null&&(i.scale=t.scale);this.command(i,t,n)};Db.prototype._registerHandler=function(e,t,n,r,i){var s=Array.isArray(e);if(typeof r=="function"){i=r;r=!1}if(s){var o=[];for(var u=0;u<e.length;u++)o.push(e[u].getRequestId().toString());for(var u=0;u<e.length;u++){var a=e[u];this._callBackStore.once(a.getRequestId(),i);this._callBackStore._notReplied[a.getRequestId().toString()]={start:(new Date).getTime(),raw:t,chained:o,connection:n,exhaust:!1}}}else{this._callBackStore.once(e.getRequestId(),i);this._callBackStore._notReplied[e.getRequestId().toString()]={start:(new Date).getTime(),raw:t,connection:n,exhaust:r}}};Db.prototype._reRegisterHandler=function(e,t,n){this._callBackStore.once(e,t.callback.listener);this._callBackStore._notReplied[e]=t.info};Db.prototype._callHandler=function(e,t,n){if(this._callBackStore.listeners(e).length>=1){var r=this._callBackStore._notReplied[e];delete this._callBackStore._notReplied[e];this._callBackStore.emit(e,n,t,r.connection)}};Db.prototype._hasHandler=function(e){return this._callBackStore.listeners(e).length>=1};Db.prototype._removeHandler=function(e){this._callBackStore._notReplied[e]!=null&&delete this._callBackStore._notReplied[e];this._callBackStore.removeAllListeners(e);this._callBackStore._events!=null&&delete this._callBackStore._events[e]};Db.prototype._findHandler=function(e){var t=this._callBackStore._notReplied[e];return{info:t,callback:this._callBackStore.listeners(e).length>=1?this._callBackStore.listeners(e)[0]:null}};var __executeQueryCommand=function(e,t,n,r){var i=n["read"]!=null?n.read:!1,s=n["raw"]!=null?n.raw:e.raw,o=n["onAll"]!=null?n.onAll:!1,u=n["connection"]!=null?n.connection:null;if(typeof i!="object"&&i._type=="ReadPreference"){i=i==null||i=="primary"||i==0?ReadPreference.PRIMARY:i;if(!ReadPreference.isValid(i))return r(new Error("Illegal readPreference mode specified, "+i))}else if(typeof i=="object"&&i._type=="ReadPreference"&&!i.isValid())return r(new Error("Illegal readPreference mode specified, "+i.mode));e.serverConfig.isMongos()&&i!=null&&i!=0&&t.setMongosReadPreference(i);if(typeof r=="function"&&!o){var a=u!=null?u:null;a==null&&(a=i==null||i=="primary"||i==0?e.serverConfig.checkoutWriter(!0):e.serverConfig.checkoutReader(i));if(a==null)return r(new Error("no open connections"));if(a instanceof Error||a["message"]!=null)return r(a);e.reaperEnabled&&reaper(e,e.reaperInterval,e.reaperTimeout);var f=n.exhaust||!1;e._registerHandler(t,s,a,f,r);a.write(t,function(n){n!=null&&e._callHandler(t.getRequestId(),null,n)})}else if(typeof r=="function"&&o){var l=e.serverConfig.allRawConnections(),c=l.length;for(var h=0;h<l.length;h++){var a=l[h];a=u!=null?u:a;if(a==null)return r(new Error("no open connections"));if(a instanceof Error)return r(a);e._registerHandler(t,s,a,r);a.write(t,function(n){c-=1;n!=null&&e._removeHandler(t.getRequestId());c<=0&&r(n)});t.updateRequestId()}}else{var a=i==null||i=="primary"||i==0?e.serverConfig.checkoutWriter(!0):e.serverConfig.checkoutReader(i);a=u!=null?u:a;if(a==null||a instanceof Error||a["message"]!=null)return null;a.write(t,function(t){t!=null&&e.emit("error",t)})}},__retryCommandOnFailure=function(e,t,n,r,i,s,o){if(this._state=="connected"||this._state=="disconnected")this._state="connecting";var u=n,a=function(e,t,n,i,s,o,u,f){e.serverConfig.connect(e,{},function(l,c,h){t-=1;if(l!=null&&t>0){e._state="connecting";h.close(function(r){setTimeout(function(){a(e,t,n,i,s,o,u,f)},n)})}else if(l!=null&&t<=0){e._state="disconnected";h.close(function(e){typeof f=="function"&&f(l,null)})}else if(l==null&&e.serverConfig.isConnected()==1&&Array.isArray(e.auths)&&e.auths.length>0){e._state="connected";var p=e.auths.length;for(var d=0;d<e.auths.length;d++)e.authenticate(e.auths[d].username,e.auths[d].password,{authdb:e.auths[d].authdb},function(t,n){p-=1;if(p==0){if(t!=null||!n){typeof f=="function"&&f(t,null);return}r(e,o,u,f);process.nextTick(function(){while(e.commands.length>0){var t=e.commands.shift();t["type"]=="query"?__executeQueryCommand(e,t.db_command,t.options,t.callback):t["type"]=="insert"&&__executeInsertCommand(e,t.db_command,t.options,t.callback)}})}})}else if(l==null&&e.serverConfig.isConnected()==1){e._state="connected";r(e,o,u,f);process.nextTick(function(){while(e.commands.length>0){var t=e.commands.shift();t["type"]=="query"?__executeQueryCommand(e,t.db_command,t.options,t.callback):t["type"]=="insert"&&__executeInsertCommand(e,t.db_command,t.options,t.callback)}})}else{e._state="connecting";h.close(function(r){setTimeout(function(){a(e,t,n,i,s,o,u,f)},n)})}})};a(e,u,t,n,r,i,s,o)};Db.prototype._executeQueryCommand=function(e,t,n){var r=this;if(typeof n=="undefined"){n=t;t={}}var i=t["failFast"]!=null?t.failFast:!1;if(this._applicationClosed){if(typeof n=="function")return n(new Error("db closed by application"),null);throw new Error("db closed by application")}if(this._state=="connecting"&&this.serverConfig.autoReconnect&&!i)process.nextTick(function(){r.commands.push({type:"query",db_command:e,options:t,callback:n})});else if(!this.serverConfig.isConnected()&&this.serverConfig.autoReconnect&&!i){this._state="connecting";__retryCommandOnFailure(this,this.retryMiliSeconds,this.numberOfRetries,__executeQueryCommand,e,t,n)}else!this.serverConfig.isConnected()&&!this.serverConfig.autoReconnect&&n?n(new Error("no open connections"),null):this.serverConfig instanceof ReplSet&&this.serverConfig._checkReplicaSet()?__executeQueryCommand(r,e,t,function(e,t,i){e||process.nextTick(function(){if(r._state=="disconnected"){r.close();return}var e=DbCommand.createAdminDbCommandSlaveOk(r,{replSetGetStatus:1},{});__executeQueryCommand(r,e,{readPreference:ReadPreference.SECONDARY_PREFERRED},function(e,t){if(r._state=="disconnected"){r.close(!0);return}e==null&&r.serverConfig._validateReplicaset(t,r.auths)})});n(e,t,i)}):__executeQueryCommand(r,e,t,n)};var __executeInsertCommand=function(e,t,n,r){var i=e.serverConfig.checkoutWriter(),s=n["safe"]!=null?n.safe:!1,o=n["raw"]!=null?n.raw:e.raw,u=n["connection"]!=null?n.connection:null;i=u!=null?u:i;if(typeof r=="function"){if(i==null)return r(new Error("no open connections"));if(i instanceof Error)return r(i);if(s!=null&&s!=0){t=[t,DbCommand.createGetLastErrorCommand(s,e)];e._registerHandler(t[1],o,i,r)}}if(i==null)return null;if(i instanceof Error&&typeof r=="function")return r(i,null);if(i instanceof Error)return null;if(i==null&&typeof r=="function")return r(new Error("no primary server found"),null);i.write(t,function(n){if(typeof r!="function"||s!=null&&s!=0)typeof r=="function"?e._callHandler(t[1].getRequestId(),null,n):e.emit("error",n);else{e.reaperEnabled&&reaper(e,e.reaperInterval,e.reaperTimeout);r(n,null)}})};Db.prototype._executeInsertCommand=function(e,t,n){var r=this;if(n==null&&typeof t=="function"){n=t;t={}}t=t==null?{}:t;if(this._applicationClosed){if(typeof n=="function")return n(new Error("db closed by application"),null);throw new Error("db closed by application")}if(r._state=="connecting"&&this.serverConfig.autoReconnect)process.nextTick(function(){r.commands.push({type:"insert",db_command:e,options:t,callback:n})});else if(!this.serverConfig.isConnected()&&this.serverConfig.autoReconnect){this._state="connecting";__retryCommandOnFailure(this,this.retryMiliSeconds,this.numberOfRetries,__executeInsertCommand,e,t,n)}else if(!this.serverConfig.isConnected()&&!this.serverConfig.autoReconnect&&n)n&&n(new Error("no open connections"),null);else if(this.serverConfig instanceof ReplSet&&this.serverConfig._checkReplicaSet()){__executeInsertCommand(r,e,t,n);var i=DbCommand.createAdminDbCommandSlaveOk(r,{replSetGetStatus:1},{});__executeQueryCommand(r,i,{readPreference:ReadPreference.SECONDARY_PREFERRED},function(e,t){if(r._state=="disconnected"){r.close(!0);return}e==null&&r.serverConfig._validateReplicaset(t,r.auths)})}else __executeInsertCommand(r,e,t,n)};Db.prototype._executeUpdateCommand=Db.prototype._executeInsertCommand;Db.prototype._executeRemoveCommand=Db.prototype._executeInsertCommand;Db.prototype.wrap=function(e){var t=e.err||e.errmsg||e,n=new Error(t);n.name="MongoError";var r=Object.keys(e);for(var i=0;i<r.length;i++)n[r[i]]=e[r[i]];return n};Db.DEFAULT_URL="mongodb://localhost:27017/default";Db.connect=function(e,t,n){var r=Array.prototype.slice.call(arguments,1);n=typeof r[r.length-1]=="function"?r.pop():null;t=r.length?r.shift():null;t=t||{};var i=t.server||{},s=t.replSet||t.replSetServers||{},o=t.db||{};i.socketOptions=i.socketOptions||{};s.socketOptions=i.socketOptions||{};var u=new RegExp("^mongo(?:db)?://(?:|([^@/]*)@)([^@/]*)(?:|/([^?]*)(?:|\\?([^?]*)))$"),a=(e||Db.DEFAULT_URL).match(u);if(!a)throw Error("URL must be in the format mongodb://user:pass@host:port/dbname");var f=a[1]||"",l=f.split(":",2);if(t.uri_decode_auth){l[0]=decodeURIComponent(l[0]);l[1]&&(l[1]=decodeURIComponent(l[1]))}var c=a[2],h=a[3]||"default",p=(a[4]||"").split(/[&;]/);p.forEach(function(e){if(!e)return;var t=e.split("="),n=t[0],r=t[1];switch(n){case"slaveOk":case"slave_ok":i.slave_ok=r=="true";break;case"poolSize":i.poolSize=Number(r);break;case"autoReconnect":case"auto_reconnect":i.auto_reconnect=r=="true";break;case"ssl":i.ssl=r=="true";break;case"replicaSet":case"rs_name":s.rs_name=r;break;case"reconnectWait":s.reconnectWait=Number(r);break;case"retries":s.retries=Number(r);break;case"readSecondary":case"read_secondary":s.retries=Number(r);break;case"safe":o.safe=r=="true";break;case"nativeParser":case"native_parser":o.native_parser=r=="true";break;case"strict":o.strict=r=="true";break;case"connectTimeoutMS":i.socketOptions.connectTimeoutMS=Number(r);s.socketOptions.connectTimeoutMS=Number(r);break;case"socketTimeoutMS":i.socketOptions.socketTimeoutMS=Number(r);s.socketOptions.socketTimeoutMS=Number(r);break;default:}});var d=c.split(",").map(function(e){var t=e.split(":",2);return new Server(t[0]||"localhost",t[1]!=null?parseInt(t[1]):27017,i)}),v;d.length==1?v=d[0]:v=new ReplSet(d,s);var m=new Db(h,v,o);if(t.noOpen)return m;if(n==null)throw new Error("no callback function provided");m.open(function(e,t){e==null&&f?t.authenticate(l[0],l[1],function(e,r){r?n(null,t):n(e?e:new Error("Could not authenticate user "+l[0]),t)}):n(e,t)})};Object.defineProperty(Db.prototype,"state",{enumerable:!0,get:function(){return this.serverConfig._serverState}});exports.connect=Db.connect;exports.Db=Db;Db.prototype.removeAllEventListeners=function(){this.removeAllListeners("close");this.removeAllListeners("error");this.removeAllListeners("timeout");this.removeAllListeners("parseError");this.removeAllListeners("poolReady");this.removeAllListeners("message")};