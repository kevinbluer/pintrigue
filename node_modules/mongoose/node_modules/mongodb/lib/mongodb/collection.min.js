/**
 * Module dependencies.
 * @ignore
 */function Collection(e,t,n,r){if(!(this instanceof Collection))return new Collection(e,t,n,r);checkCollectionName(t);this.db=e;this.collectionName=t;this.internalHint=null;this.opts=r!=null&&"object"==typeof r?r:{};this.slaveOk=r==null||r.slaveOk==null?e.slaveOk:r.slaveOk;this.serializeFunctions=r==null||r.serializeFunctions==null?e.serializeFunctions:r.serializeFunctions;this.raw=r==null||r.raw==null?e.raw:r.raw;this.readPreference=r==null||r.readPreference==null?e.serverConfig.readPreference:r.readPreference;this.readPreference=this.readPreference==null?"primary":this.readPreference;this.pkFactory=n==null?ObjectID:n;var i=this}var InsertCommand=require("./commands/insert_command").InsertCommand,QueryCommand=require("./commands/query_command").QueryCommand,DeleteCommand=require("./commands/delete_command").DeleteCommand,UpdateCommand=require("./commands/update_command").UpdateCommand,DbCommand=require("./commands/db_command").DbCommand,ObjectID=require("bson").ObjectID,Code=require("bson").Code,Cursor=require("./cursor").Cursor,utils=require("./utils");const eErrorMessages=/No matching object found/;var toString=Object.prototype.toString;Collection.prototype.insert=function(t,n,r){"function"==typeof n&&(r=n,n={});n==null&&(n={});"function"!=typeof r&&(r=null);var i=this;insertAll(i,Array.isArray(t)?t:[t],n,r);return this};var checkCollectionName=function(t){if("string"!=typeof t)throw Error("collection name must be a String");if(!t||t.indexOf("..")!=-1)throw Error("collection names cannot be empty");if(t.indexOf("$")!=-1&&t.match(/((^\$cmd)|(oplog\.\$main))/)==null)throw Error("collection names must not contain '$'");if(t.match(/^\.|\.$/)!=null)throw Error("collection names must not start or end with '.'")};Collection.prototype.remove=function(t,n,r){if("function"==typeof t){r=t;t=n={}}else if("function"==typeof n){r=n;n={}}n==null&&(n={});"function"!=typeof r&&(r=null);t=t==null?{}:t;var i=0|(n.single?1:0),s=n.dbName;s==null&&(s=this.db.databaseName);var o=new DeleteCommand(this.db,s+"."+this.collectionName,t,i),u=this,a=n.safe!=null?n.safe:null;a=a==null&&this.opts.safe!=null?this.opts.safe:a;a=a==null&&this.db.strict!=null?this.db.strict:a;if(a&&a["safe"]!=0&&typeof r!="function")throw new Error("safe cannot be used without a callback");if(!(n&&n.safe||this.opts.safe!=null||this.db.strict)){var h=this.db._executeRemoveCommand(o);if(!r)return;return h instanceof Error?r(h):r()}var f={read:!1};a==null&&(f.async=!0);f.safe=!0;if(typeof a=="object"){var l=Object.keys(a);for(var c=0;c<l.length;c++)f[l[c]]=a[l[c]]}this.db._executeRemoveCommand(o,f,function(e,t){t=t&&t.documents;if(!r)return;e?r(e):t[0].err||t[0].errmsg?r(u.db.wrap(t[0])):r(null,t[0].n)})};Collection.prototype.rename=function(t,n){var r=this;checkCollectionName(t);r.db._executeQueryCommand(DbCommand.createRenameCollectionCommand(r.db,r.collectionName,t),function(e,i){if(e==null&&i.documents[0].ok==1){if(n!=null){r.collectionName=t;n(null,r)}}else i.documents[0].errmsg!=null&&n!=null&&(e!=null?n(e,null):n(r.db.wrap(i.documents[0]),null))})};var insertAll=function(t,n,r,i){"function"==typeof r&&(i=r,r={});r==null&&(r={});"function"!=typeof i&&(i=null);var s={};r["keepGoing"]!=null&&(s.keepGoing=r.keepGoing);r["continueOnError"]!=null&&(s.continueOnError=r.continueOnError);var o=r.dbName;o==null&&(o=t.db.databaseName);r["serializeFunctions"]!=null?s.serializeFunctions=r.serializeFunctions:s.serializeFunctions=t.serializeFunctions;var u=new InsertCommand(t.db,o+"."+t.collectionName,!0,s);for(var a=0,f=n.length;a<f;++a){var l=n[a];!Buffer.isBuffer(l)&&l["_id"]==null&&t.db.forceServerObjectId!=1&&(l._id=t.pkFactory.createPk());u.add(l)}var c=r.safe!=null?r.safe:null;c=c==null&&t.opts.safe!=null?t.opts.safe:c;c=c==null&&t.db.strict!=null?t.db.strict:c;if(c&&c["safe"]!=0&&typeof i!="function")throw new Error("safe cannot be used without a callback");var h={};if(!c||c==0){var v=t.db._executeInsertCommand(u,h,i);if(!i)return;return v instanceof Error?i(v):i(null,n)}h.read=!1;c==null&&(h.async=!0);h.safe=c;if(typeof c=="object"){var p=Object.keys(c);for(var d=0;d<p.length;d++)h[p[d]]=c[p[d]]}t.db._executeInsertCommand(u,h,function(e,r){r=r&&r.documents;if(!i)return;e?i(e):r[0].err||r[0].errmsg?i(t.db.wrap(r[0])):i(null,n)})};Collection.prototype.save=function(t,n,r){"function"==typeof n&&(r=n,n=null);n==null&&(n={});"function"!=typeof r&&(r=null);var i=n.safe!=null?n.safe:!1;i=i==null&&this.opts.safe!=null?this.opts.safe:i;var s=t._id;s?this.update({_id:s},t,{upsert:!0,safe:i},r):this.insert(t,{safe:i},r&&function(e,t){if(e)return r(e,null);Array.isArray(t)?r(e,t[0]):r(e,t)})};Collection.prototype.update=function(t,n,r,i){"function"==typeof r&&(i=r,r=null);r==null&&(r={});"function"!=typeof i&&(i=null);var s=r.dbName;s==null&&(s=this.db.databaseName);r["serializeFunctions"]!=null?r.serializeFunctions=r.serializeFunctions:r.serializeFunctions=this.serializeFunctions;var o=new UpdateCommand(this.db,s+"."+this.collectionName,t,n,r),u=this,a=r&&r.safe!=null?r.safe:null;a=a==null&&this.opts.safe!=null?this.opts.safe:a;a=a==null&&this.db.strict!=null?this.db.strict:a;if(a&&a["safe"]!=0&&typeof i!="function")throw new Error("safe cannot be used without a callback");if(!a||a==0){var h=this.db._executeUpdateCommand(o);if(!i)return;return h instanceof Error?i(h):i()}var f={read:!1};a==null&&(f.async=!0);f.safe=!0;if(typeof a=="object"){var l=Object.keys(a);for(var c=0;c<l.length;c++)f[l[c]]=a[l[c]]}this.db._executeUpdateCommand(o,f,function(e,t){t=t&&t.documents;if(!i)return;e?i(e):t[0].err||t[0].errmsg?i(u.db.wrap(t[0])):i(null,t[0].n,t[0])})};Collection.prototype.distinct=function(t,n,r,i){var s=Array.prototype.slice.call(arguments,1);i=s.pop();n=s.length?s.shift():{};r=s.length?s.shift():{};var o={distinct:this.collectionName,query:n,key:t},u=r.readPreference?r.readPreference:!1,a=DbCommand.createDbSlaveOkCommand(this.db,o);this.db._executeQueryCommand(a,{read:u},function(e,t){if(e)return i(e);if(t.documents[0].ok!=1)return i(new Error(t.documents[0].errmsg));i(null,t.documents[0].values)})};Collection.prototype.count=function(t,n,r){var i=Array.prototype.slice.call(arguments,0);r=i.pop();t=i.length?i.shift():{};n=i.length?i.shift():{};var s={count:this.collectionName,query:t,fields:null},o=n.readPreference?n.readPreference:!1,u=QueryCommand.OPTS_NO_CURSOR_TIMEOUT;if(this.slaveOk||this.db.slaveOk)u|=QueryCommand.OPTS_SLAVE;var a=new QueryCommand(this.db,this.db.databaseName+".$cmd",u,0,-1,s,null),f=this;this.db._executeQueryCommand(a,{read:o},function(e,t){t=t&&t.documents;if(!r)return;if(e)return r(e);if(t[0].ok!=1||t[0].errmsg)return r(f.db.wrap(t[0]));r(null,t[0].n)})};Collection.prototype.drop=function(t){this.db.dropCollection(this.collectionName,t)};Collection.prototype.findAndModify=function(t,n,r,i,s){var o=Array.prototype.slice.call(arguments,1);s=o.pop();n=o.length?o.shift():[];r=o.length?o.shift():null;i=o.length?o.shift():{};var u=this,a={findandmodify:this.collectionName,query:t,sort:utils.formattedOrderClause(n)};a.new=i.new?1:0;a.remove=i.remove?1:0;a.upsert=i.upsert?1:0;i.fields&&(a.fields=i.fields);r&&!i.remove&&(a.update=r);i["serializeFunctions"]!=null?i.serializeFunctions=i.serializeFunctions:i.serializeFunctions=this.serializeFunctions;var f=i&&i.safe!=null?i.safe:null;f=f==null&&this.opts.safe!=null?this.opts.safe:f;f=f==null&&this.db.strict!=null?this.db.strict:f;if(f!=null&&typeof f=="object"){var l=[];l.push(DbCommand.createDbCommand(this.db,a,i));var c=f!=null?!0:!1;c&&l.push(DbCommand.createGetLastErrorCommand(f,this.db));this.db._executeQueryCommand(l,{read:!1},function(e,t){if(e!=null)return s(e);t=t&&t.documents;return t[0].err!=null?s(u.db.wrap(t[0]),null):t[0].errmsg!=null&&!t[0].errmsg.match(eErrorMessages)?s(u.db.wrap(t[0]),null,t[0]):s(null,t[0].value,t[0])})}else{var h=DbCommand.createDbCommand(this.db,a,i);this.db._executeQueryCommand(h,{read:!1},function(e,t){if(e!=null)return s(e);t=t&&t.documents;return t[0].errmsg!=null&&!t[0].errmsg.match(eErrorMessages)?s(u.db.wrap(t[0]),null,t[0]):t[0].lastErrorObject&&t[0].lastErrorObject.err!=null?s(u.db.wrap(t[0].lastErrorObject),null):s(null,t[0].value,t[0])})}};Collection.prototype.findAndRemove=function(e,t,n,r){var i=Array.prototype.slice.call(arguments,1);r=i.pop();t=i.length?i.shift():[];n=i.length?i.shift():{};n.remove=!0;this.findAndModify(e,t,null,n,r)};var testForFields={limit:1,sort:1,fields:1,skip:1,hint:1,explain:1,snapshot:1,timeout:1,tailable:1,batchSize:1,raw:1,read:1,returnKey:1,maxScan:1,min:1,max:1,showDiskLoc:1,comment:1,dbName:1,exhaust:1,tailableRetryInterval:1};Collection.prototype.find=function(){var t,n=Array.prototype.slice.call(arguments,0),r=typeof n[n.length-1]=="function",i=typeof n[0]=="function",s=r?n.pop():i?n.shift():null,o=n.length,u=o>=1?n[0]:{},a=o>=2?n[1]:undefined;if(o===1&&i){u={};t=n[0]}if(o===2&&!Array.isArray(a)){var f=Object.getOwnPropertyNames(a),l=!1;for(var c=0;c<f.length;c++)if(testForFields[f[c]]!=null){l=!0;break}if(l){t=a;a=undefined}else t={}}else if(o===2&&Array.isArray(a)&&!Array.isArray(a[0])){var h={};for(var c=0;c<a.length;c++)h[a[c]]=1;a=h}3===o&&(t=n[2]);u=u==null?{}:u;var p=u;if(Buffer.isBuffer(p)){var d=p[0]|p[1]<<8|p[2]<<16|p[3]<<24;if(d!=p.length){var v=new Error("query selector raw message size does not match message header size ["+p.length+"] != ["+d+"]");v.name="MongoError";throw v}}var p=a;if(Buffer.isBuffer(p)){var d=p[0]|p[1]<<8|p[2]<<16|p[3]<<24;if(d!=p.length){var v=new Error("query fields raw message size does not match message header size ["+p.length+"] != ["+d+"]");v.name="MongoError";throw v}}u instanceof ObjectID&&(u={_id:u});if(t&&t.fields&&!Buffer.isBuffer(t.fields)){a={};if(Array.isArray(t.fields))if(!t.fields.length)a._id=1;else for(var c=0,m=t.fields.length;c<m;c++)a[t.fields[c]]=1;else a=t.fields}t||(t={});t.skip=o>3?n[2]:t.skip?t.skip:0;t.limit=o>3?n[3]:t.limit?t.limit:0;t.raw=t.raw!=null&&typeof t.raw=="boolean"?t.raw:this.raw;t.hint=t.hint!=null?normalizeHintField(t.hint):this.internalHint;t.timeout=o==5?n[4]:typeof t.timeout=="undefined"?undefined:t.timeout;t.slaveOk=t.slaveOk!=null?t.slaveOk:this.db.slaveOk;var g=t;g["read"]!=null&&(g.readPreference=g.read);g.read=g.readPreference?g.readPreference:this.readPreference;if(g.read=="secondary"||g.read=="secondaryOnly")t.slaveOk=!0;if(!s)return new Cursor(this.db,this,u,a,g.skip,g.limit,g.sort,g.hint,g.explain,g.snapshot,g.timeout,g.tailable,g.batchSize,g.slaveOk,g.raw,g.read,g.returnKey,g.maxScan,g.min,g.max,g.showDiskLoc,g.comment,g.awaitdata,g.numberOfRetries,g.dbName,g.tailableRetryInterval,g.exhaust);s(null,new Cursor(this.db,this,u,a,g.skip,g.limit,g.sort,g.hint,g.explain,g.snapshot,g.timeout,g.tailable,g.batchSize,g.slaveOk,g.raw,g.read,g.returnKey,g.maxScan,g.min,g.max,g.showDiskLoc,g.comment,g.awaitdata,g.numberOfRetries,g.dbName,g.tailableRetryInterval,g.exhaust))};var normalizeHintField=function(t){var n=null;if(null!=t)switch(t.constructor){case String:n={};n[t]=1;break;case Object:n={};for(var r in t)n[r]=t[r];break;case Array:n={};t.forEach(function(e){n[e]=1})}return n};Collection.prototype.findOne=function(){var t=this,n=Array.prototype.slice.call(arguments,0),r=n.pop(),i=this.find.apply(this,n).limit(-1).batchSize(1);i.toArray(function(e,n){if(e!=null)return r(e instanceof Error?e:t.db.wrap(new Error(e)),null);if(n.length==1)return r(null,n[0]);r(null,null)})};Collection.prototype.createIndex=function(t,n,r){var i=Array.prototype.slice.call(arguments,1);r=i.pop();n=i.length?i.shift():{};n=typeof r=="function"?n:r;n=n==null?{}:n;var s=n.safe!=null?n.safe:null;s=s==null&&this.opts.safe!=null?this.opts.safe:s;s=s==null&&this.db.strict!=null?this.db.strict:s;if(s!=null&&s!=0&&typeof r!="function"&&typeof n!="function")throw new Error("safe cannot be used without a callback");this.db.createIndex(this.collectionName,t,n,r)};Collection.prototype.ensureIndex=function(t,n,r){if(typeof r=="undefined"&&typeof n=="function"){r=n;n={}}n==null&&(n={});var i=n.safe!=null?n.safe:null;i=i==null&&this.opts.safe!=null?this.opts.safe:i;i=i==null&&this.db.strict!=null?this.db.strict:i;if(i!=null&&i!=0&&typeof r!="function"&&typeof n!="function")throw new Error("safe cannot be used without a callback");this.db.ensureIndex(this.collectionName,t,n,r)};Collection.prototype.indexInformation=function(t,n){var r=Array.prototype.slice.call(arguments,0);n=r.pop();t=r.length?r.shift():{};this.db.indexInformation(this.collectionName,t,n)};Collection.prototype.dropIndex=function(t,n){this.db.dropIndex(this.collectionName,t,n)};Collection.prototype.dropAllIndexes=function(t){this.db.dropIndex(this.collectionName,"*",function(e,n){e!=null?t(e,!1):n.documents[0].errmsg==null?t(null,!0):t(new Error(n.documents[0].errmsg),!1)})};Collection.prototype.dropIndexes=Collection.prototype.dropAllIndexes;Collection.prototype.reIndex=function(e){this.db.reIndex(this.collectionName,e)};Collection.prototype.mapReduce=function(t,n,r,i){"function"==typeof r&&(i=r,r={});if(null==r.out)throw new Error("the out option parameter must be defined, see mongodb docs for possible values");"function"==typeof t&&(t=t.toString());"function"==typeof n&&(n=n.toString());"function"==typeof r.finalize&&(r.finalize=r.finalize.toString());var s={mapreduce:this.collectionName,map:t,reduce:n};for(var o in r)s[o]=r[o];var u=r.readPreference?r.readPreference:!1;if(u!=0&&r["out"]!="inline")throw new Error("a readPreference can only be provided when performing an inline mapReduce");var a=this,f=DbCommand.createDbCommand(this.db,s);this.db._executeQueryCommand(f,{read:u},function(e,t){if(e)return i(e);if(1!=t.documents[0].ok||t.documents[0].err||t.documents[0].errmsg)return i(a.db.wrap(t.documents[0]));var n={};t.documents[0].timeMillis&&(n.processtime=t.documents[0].timeMillis);t.documents[0].counts&&(n.counts=t.documents[0].counts);t.documents[0].timing&&(n.timing=t.documents[0].timing);if(t.documents[0].results)return i(null,t.documents[0].results,n);var s=null;if(t.documents[0].result!=null&&typeof t.documents[0].result=="object"){var o=t.documents[0].result;s=a.db.db(o.db).collection(o.collection)}else s=a.db.collection(t.documents[0].result);if(r["verbose"]==null||!r.verbose)return i(e,s);i(e,s,n)})};var groupFunction=function(){var e=db[ns].find(condition),t=new Map,n=reduce;while(e.hasNext()){var r=e.next(),i={};for(var s=0,o=keys.length;s<o;++s){var u=keys[s];i[u]=r[u]}var a=t.get(i);if(a==null){var f=Object.extend({},i);a=Object.extend(f,initial);t.put(i,a)}n(r,a)}return{result:t.values()}}.toString();Collection.prototype.group=function(t,n,r,i,s,o,u,a){var f=Array.prototype.slice.call(arguments,3);a=f.pop();i=f.length?f.shift():null;s=f.length?f.shift():null;o=f.length?f.shift():null;u=f.length?f.shift():{};if(typeof s!="function"){o=s;s=null}!Array.isArray(t)&&t instanceof Object&&typeof t!="function"&&!(t instanceof Code)&&(t=Object.keys(t));typeof i=="function"&&(i=i.toString());typeof s=="function"&&(s=s.toString());o=o==null?!0:o;if(o){var l=i instanceof Code?i:new Code(i),c={group:{ns:this.collectionName,$reduce:l,cond:n,initial:r,out:"inline"}};s!=null&&(c.group.finalize=s);if("function"==typeof t||t instanceof Code)c.group.$keyf=t instanceof Code?t:new Code(t);else{var h={};t.forEach(function(e){h[e]=1});c.group.key=h}var p=DbCommand.createDbSlaveOkCommand(this.db,c),d=u.readPreference?u.readPreference:!1;this.db._executeQueryCommand(p,{read:d},function(e,t){if(e!=null)return a(e);var n=t.documents[0];if(null==n.retval)return a(new Error("group command failed: "+n.errmsg));a(null,n.retval)})}else{var v=i!=null&&i instanceof Code?i.scope:{};v.ns=this.collectionName;v.keys=t;v.condition=n;v.initial=r;var m=groupFunction.replace(/ reduce;/,i.toString()+";");this.db.eval(new Code(m,v),function(e,t){if(e)return a(e,null);a(null,t.result||t)})}};Collection.prototype.options=function(t){this.db.collectionsInfo(this.collectionName,function(e,n){if(e)return t(e);n.nextObject(function(e,n){t(e,n&&n.options||null)})})};Collection.prototype.isCapped=function(t){this.options(function(e,n){e!=null?t(e):t(null,n&&n.capped)})};Collection.prototype.indexExists=function(t,n){this.indexInformation(function(e,r){if(e!=null)return n(e,null);if(Array.isArray(t)){for(var i=0;i<t.length;i++)if(r[t[i]]==null)return n(null,!1);return n(null,!0)}return n(null,r[t]!=null)})};Collection.prototype.geoNear=function(t,n,r,i){var s=Array.prototype.slice.call(arguments,2);i=s.pop();r=s.length?s.shift():{};var o={geoNear:this.collectionName,near:[t,n]};r["num"]!=null&&(o.num=r.num);r["maxDistance"]!=null&&(o.maxDistance=r.maxDistance);r["distanceMultiplier"]!=null&&(o.distanceMultiplier=r.distanceMultiplier);r["query"]!=null&&(o.query=r.query);r["spherical"]!=null&&(o.spherical=r.spherical);r["uniqueDocs"]!=null&&(o.uniqueDocs=r.uniqueDocs);r["includeLocs"]!=null&&(o.includeLocs=r.includeLocs);this.db.command(o,r,i)};Collection.prototype.geoHaystackSearch=function(t,n,r,i){var s=Array.prototype.slice.call(arguments,2);i=s.pop();r=s.length?s.shift():{};var o={geoSearch:this.collectionName,near:[t,n]};r["maxDistance"]!=null&&(o.maxDistance=r.maxDistance);r["query"]!=null&&(o.search=r.query);r["search"]!=null&&(o.search=r.search);r["limit"]!=null&&(o.limit=r.limit);this.db.command(o,r,i)};Collection.prototype.indexes=function(t){this.db.indexInformation(this.collectionName,{full:!0},t)};Collection.prototype.aggregate=function(e,t,n){var r=Array.prototype.slice.call(arguments,0);n=r.pop();var i=this;t=r[r.length-1].explain?r.pop():{};if(!Array.isArray(r[0])){e=[];for(var s=0;s<r.length;s++)e.push(r[s])}var o={aggregate:this.collectionName,pipeline:e},u=Object.keys(t);for(var s=0;s<u.length;s++)o[u[s]]=t[u[s]];this.db.command(o,t,function(e,t){e?n(e):t.err||t.errmsg?n(i.db.wrap(t)):typeof t=="object"&&t.serverPipeline?n(null,t):n(null,t.result)})};Collection.prototype.stats=function(t,n){var r=Array.prototype.slice.call(arguments,0);n=r.pop();t=r.length?r.shift():{};var i={collStats:this.collectionName};t["scale"]!=null&&(i.scale=t.scale);this.db.command(i,t,n)};Object.defineProperty(Collection.prototype,"hint",{enumerable:!0,get:function(){return this.internalHint},set:function(e){this.internalHint=normalizeHintField(e)}});exports.Collection=Collection;