var Binary=require("bson").Binary,ObjectID=require("bson").ObjectID,Chunk=exports.Chunk=function(e,t){if(!(this instanceof Chunk))return new Chunk(e,t);this.file=e;var n=this,r=t==null?{}:t;this.objectId=r._id==null?new ObjectID:r._id;this.chunkNumber=r.n==null?0:r.n;this.data=new Binary;if(r.data!=null)if(typeof r.data=="string"){var i=new Buffer(r.data.length);i.write(r.data,"binary",0);this.data=new Binary(i)}else if(Array.isArray(r.data)){var i=new Buffer(r.data.length);i.write(r.data.join(""),"binary",0);this.data=new Binary(i)}else if(r.data instanceof Binary||Object.prototype.toString.call(r.data)=="[object Binary]")this.data=r.data;else if(!Buffer.isBuffer(r.data))throw Error("Illegal chunk format");this.internalPosition=0};Chunk.prototype.write=function(e,t){this.data.write(e,this.internalPosition);this.internalPosition=this.data.length();return t!=null?t(null,this):this};Chunk.prototype.read=function(e){e=e==null||e==0?this.length():e;if(this.length()-this.internalPosition+1>=e){var t=this.data.read(this.internalPosition,e);this.internalPosition=this.internalPosition+e;return t}return""};Chunk.prototype.readSlice=function(e){if(this.length()-this.internalPosition>=e){var t=null;if(this.data.buffer!=null)t=this.data.buffer.slice(this.internalPosition,this.internalPosition+e);else{t=new Buffer(e);e=this.data.readInto(t,this.internalPosition)}this.internalPosition=this.internalPosition+e;return t}return null};Chunk.prototype.eof=function(){return this.internalPosition==this.length()?!0:!1};Chunk.prototype.getc=function(){return this.read(1)};Chunk.prototype.rewind=function(){this.internalPosition=0;this.data=new Binary};Chunk.prototype.save=function(e){var t=this;t.file.chunkCollection(function(n,r){if(n)return e(n);r.remove({_id:t.objectId},{safe:!0},function(n,i){if(n)return e(n);t.data.length()>0?t.buildMongoObject(function(n){r.insert(n,{safe:!0},function(n,r){e(n,t)})}):e(null,t)})})};Chunk.prototype.buildMongoObject=function(e){var t={_id:this.objectId,files_id:this.file.fileId,n:this.chunkNumber,data:this.data};e(t)};Chunk.prototype.length=function(){return this.data.length()};Object.defineProperty(Chunk.prototype,"position",{enumerable:!0,get:function(){return this.internalPosition},set:function(e){this.internalPosition=e}});Chunk.DEFAULT_CHUNK_SIZE=262144;