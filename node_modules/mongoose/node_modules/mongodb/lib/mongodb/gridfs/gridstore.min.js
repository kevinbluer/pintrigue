/**
 * @fileOverview GridFS is a tool for MongoDB to store files to the database.
 * Because of the restrictions of the object size the database can hold, a
 * facility to split a file into several chunks is needed. The {@link GridStore}
 * class offers a simplified api to interact with files while managing the
 * chunks of split files behind the scenes. More information about GridFS can be
 * found <a href="http://www.mongodb.org/display/DOCS/GridFS">here</a>.
 */var Chunk=require("./chunk").Chunk,DbCommand=require("../commands/db_command").DbCommand,ObjectID=require("bson").ObjectID,Buffer=require("buffer").Buffer,fs=require("fs"),util=require("util"),inherits=util.inherits,ReadStream=require("./readstream").ReadStream,Stream=require("stream"),REFERENCE_BY_FILENAME=0,REFERENCE_BY_ID=1,GridStore=function e(t,n,r,i,s){if(!(this instanceof e))return new e(t,n,r,i,s);var o=this;this.db=t;typeof Stream=="function"?Stream.call(this):Stream.Stream.call(this);s==null&&(s={});if(i==null){i=r;r=null}else if(typeof i=="object"){s=i;i=r;r=null}if(n instanceof ObjectID&&(typeof r=="string"||r==null)){this.referenceBy=1;this.fileId=n;this.filename=r}else if(n instanceof ObjectID||typeof n!="string"||i.indexOf("w")==null)if(n instanceof ObjectID||typeof n!="string"||i.indexOf("r")==null){this.referenceBy=1;this.fileId=n;this.filename=r}else{this.referenceBy=0;this.filename=r}else{this.referenceBy=0;this.fileId=new ObjectID;this.filename=n}this.mode=i==null?"r":i;this.options=s==null?{}:s;this.root=this.options["root"]==null?exports.GridStore.DEFAULT_ROOT_COLLECTION:this.options.root;this.position=0;this.internalChunkSize=this.options["chunkSize"]==null?Chunk.DEFAULT_CHUNK_SIZE:this.options.chunkSize;this.previousChunkSize=0};typeof Stream=="function"?GridStore.prototype={__proto__:Stream.prototype}:GridStore.prototype={__proto__:Stream.Stream.prototype};GridStore.prototype._pipe=GridStore.prototype.pipe;GridStore.prototype.open=function(e){if(this.mode!="w"&&this.mode!="w+"&&this.mode!="r"){e(new Error("Illegal mode "+this.mode),null);return}var t=this;t.mode!="w"&&t.mode!="w+"||t.db.serverConfig.primary==null?_open(t,e):t.collection(function(n,r){if(n)return e(n);r.ensureIndex([["filename",1]],function(n,r){if(n)return e(n);t.chunkCollection(function(n,r){if(n)return e(n);r.ensureIndex([["files_id",1],["n",1]],function(n,r){if(n)return e(n);_open(t,e)})})})})};var _open=function(e,t){function n(e){if(n.err)return;t(n.err=e)}e.collection(function(r,i){if(r!==null){t(new Error("at collection: "+r),null);return}var s=e.referenceBy==REFERENCE_BY_ID?{_id:e.fileId}:{filename:e.filename};s=null==e.fileId&&this.filename==null?null:s;if(s!=null)i.find(s,function(r,i){if(r)return n(r);i.nextObject(function(r,i){if(r)return n(r);if(i!=null){e.fileId=i._id;e.filename=i.filename;e.contentType=i.contentType;e.internalChunkSize=i.chunkSize;e.uploadDate=i.uploadDate;e.aliases=i.aliases;e.length=i.length;e.metadata=i.metadata;e.internalMd5=i.md5}else{e.fileId=e.fileId==null?new ObjectID:e.fileId;e.contentType=exports.GridStore.DEFAULT_CONTENT_TYPE;e.internalChunkSize=e.internalChunkSize==null?Chunk.DEFAULT_CHUNK_SIZE:e.internalChunkSize;e.length=0}e.mode=="r"?nthChunk(e,0,function(r,i){if(r)return n(r);e.currentChunk=i;e.position=0;t(null,e)}):e.mode=="w"?deleteChunks(e,function(r,i){if(r)return n(r);e.currentChunk=new Chunk(e,{n:0});e.contentType=e.options["content_type"]==null?e.contentType:e.options.content_type;e.internalChunkSize=e.options["chunk_size"]==null?e.internalChunkSize:e.options.chunk_size;e.metadata=e.options["metadata"]==null?e.metadata:e.options.metadata;e.position=0;t(null,e)}):e.mode=="w+"&&nthChunk(e,lastChunkNumber(e),function(r,i){if(r)return n(r);e.currentChunk=i==null?new Chunk(e,{n:0}):i;e.currentChunk.position=e.currentChunk.data.length();e.metadata=e.options["metadata"]==null?e.metadata:e.options.metadata;e.position=e.length;t(null,e)})})});else{e.fileId=null==e.fileId?new ObjectID:e.fileId;e.contentType=exports.GridStore.DEFAULT_CONTENT_TYPE;e.internalChunkSize=e.internalChunkSize==null?Chunk.DEFAULT_CHUNK_SIZE:e.internalChunkSize;e.length=0;e.chunkCollection(function(r,i){if(r)return n(r);e.mode=="w"?deleteChunks(e,function(r,i){if(r)return n(r);e.currentChunk=new Chunk(e,{n:0});e.contentType=e.options["content_type"]==null?e.contentType:e.options.content_type;e.internalChunkSize=e.options["chunk_size"]==null?e.internalChunkSize:e.options.chunk_size;e.metadata=e.options["metadata"]==null?e.metadata:e.options.metadata;e.position=0;t(null,e)}):e.mode=="w+"&&nthChunk(e,lastChunkNumber(e),function(r,i){if(r)return n(r);e.currentChunk=i==null?new Chunk(e,{n:0}):i;e.currentChunk.position=e.currentChunk.data.length();e.metadata=e.options["metadata"]==null?e.metadata:e.options.metadata;e.position=e.length;t(null,e)})})}})};GridStore.prototype.writeFile=function(e,t){var n=this;if(typeof e=="string"){fs.open(e,"r",438,function(e,r){if(e)return t(e);n.writeFile(r,t)});return}n.open(function(n,r){if(n)return t(n);fs.fstat(e,function(n,i){if(n)return t(n);var s=0,o=0,u=Math.min(i.size/r.chunkSize),a=function(){fs.read(e,r.chunkSize,s,"binary",function(n,u,f){if(n)return t(n);s+=f;var l=new Chunk(r,{n:o++});l.write(u,function(n,o){if(n)return t(n);o.save(function(n,f){if(n)return t(n);r.position=r.position+u.length;r.currentChunk=o;if(!(s>=i.size))return process.nextTick(a);fs.close(e);r.close(t)})})})};process.nextTick(a)})})};var writeBuffer=function(e,t,n,r){if(typeof n=="function"){r=n;n=null}var i=n==null?!1:n;if(e.mode[0]!="w")r(new Error((e.referenceBy==REFERENCE_BY_ID?e.toHexString():e.filename)+" not opened for writing"),null);else if(e.currentChunk.position+t.length>=e.chunkSize){var s=e.currentChunk.chunkNumber,o=e.chunkSize-e.currentChunk.position,u=t.slice(0,o),a=t.slice(o),f=[e.currentChunk.write(u)];while(a.length>=e.chunkSize){var l=new Chunk(e,{n:s+1}),u=a.slice(0,e.chunkSize);a=a.slice(e.chunkSize);s+=1;l.write(u);f.push(l)}e.currentChunk=new Chunk(e,{n:s+1});a.length>0&&e.currentChunk.write(a);e.position=e.position+t.length;var c=f.length;for(var h=0;h<f.length;h++){var p=f[h];p.save(function(t,n){if(t)return r(t);c-=1;if(c<=0)return r(null,e)})}}else{e.position=e.position+t.length;e.currentChunk.write(t);r(null,e)}},buildMongoObject=function(e,t){var n=0,r=e.previousChunkSize;if(null!=e.currentChunk&&e.currentChunk.chunkNumber>0&&e.currentChunk.position==0)n=e.currentChunk.chunkNumber-1;else{n=e.currentChunk.chunkNumber;r=e.currentChunk.position}var i=e.currentChunk!=null?n*e.chunkSize+r:0,s={_id:e.fileId,filename:e.filename,contentType:e.contentType,length:e.position?e.position:0,chunkSize:e.chunkSize,uploadDate:e.uploadDate,aliases:e.aliases,metadata:e.metadata},o={filemd5:e.fileId,root:e.root};e.db.command(o,function(e,n){s.md5=n.md5;t(s)})};GridStore.prototype.close=function(e){var t=this;t.mode[0]=="w"?t.currentChunk!=null&&t.currentChunk.position>0?t.currentChunk.save(function(n,r){if(n)return e(n);t.collection(function(n,r){if(n)return e(n);if(t.uploadDate!=null)r.remove({_id:t.fileId},{safe:!0},function(n,i){if(n)return e(n);buildMongoObject(t,function(t){r.save(t,{safe:!0},function(n){e(n,t)})})});else{t.uploadDate=new Date;buildMongoObject(t,function(t){r.save(t,{safe:!0},function(n){e(n,t)})})}})}):t.collection(function(n,r){if(n)return e(n);t.uploadDate=new Date;buildMongoObject(t,function(t){r.save(t,{safe:!0},function(n){e(n,t)})})}):t.mode[0]=="r"?e(null,null):e(new Error("Illegal mode "+t.mode),null)};var nthChunk=function(e,t,n){e.chunkCollection(function(r,i){if(r)return n(r);i.find({files_id:e.fileId,n:t},function(t,r){if(t)return n(t);r.nextObject(function(t,r){if(t)return n(t);var i=r==null?{}:r;n(null,new Chunk(e,i))})})})};GridStore.prototype._nthChunk=function(e,t){nthChunk(this,e,t)};var lastChunkNumber=function(e){return Math.floor(e.length/e.chunkSize)};GridStore.prototype.chunkCollection=function(e){this.db.collection(this.root+".chunks",e)};var deleteChunks=function(e,t){e.fileId!=null?e.chunkCollection(function(n,r){if(n)return t(n,!1);r.remove({files_id:e.fileId},{safe:!0},function(e,n){if(e)return t(e,!1);t(null,!0)})}):t(null,!0)};GridStore.prototype.unlink=function(e){var t=this;deleteChunks(this,function(n){if(n!==null){n.message="at deleteChunks: "+n.message;return e(n)}t.collection(function(n,r){if(n!==null){n.message="at collection: "+n.message;return e(n)}r.remove({_id:t.fileId},{safe:!0},function(n){e(n,t)})})})};GridStore.prototype.collection=function(e){this.db.collection(this.root+".files",e)};GridStore.prototype.readlines=function(e,t){var n=Array.prototype.slice.call(arguments,0);t=n.pop();e=n.length?n.shift():"\n";this.read(function(n,r){if(n)return t(n);var i=r.toString().split(e);i=i.length>0?i.splice(0,i.length-1):[];for(var s=0;s<i.length;s++)i[s]=i[s]+e;t(null,i)})};GridStore.prototype.rewind=function(e){var t=this;if(this.currentChunk.chunkNumber!=0)this.mode[0]=="w"?deleteChunks(t,function(n,r){if(n)return e(n);t.currentChunk=new Chunk(t,{n:0});t.position=0;e(null,t)}):t.currentChunk(0,function(n,r){if(n)return e(n);t.currentChunk=r;t.currentChunk.rewind();t.position=0;e(null,t)});else{t.currentChunk.rewind();t.position=0;e(null,t)}};GridStore.prototype.read=function(e,t,n){var r=this,i=Array.prototype.slice.call(arguments,0);n=i.pop();e=i.length?i.shift():null;t=i.length?i.shift():null;var s=e==null?r.length-r.position:e,o=t==null?new Buffer(s):t;o._index=t!=null&&t._index!=null?t._index:0;if(r.currentChunk.length()-r.currentChunk.position+o._index>=s){var u=r.currentChunk.readSlice(s-o._index);u.copy(o,o._index);r.position=o.length;if(s==0&&o.length==0)return n(new Error("File does not exist"),null);n(null,o)}else{var u=r.currentChunk.readSlice(r.currentChunk.length()-r.currentChunk.position);u.copy(o,o._index);o._index+=u.length;nthChunk(r,r.currentChunk.chunkNumber+1,function(t,i){if(t)return n(t);if(i.length()>0){r.currentChunk=i;r.read(e,o,n)}else o._index>0?n(null,o):n(new Error("no chunks found for file, possibly corrupt"),null)})}};GridStore.prototype.tell=function(e){e(null,this.position)};GridStore.prototype.seek=function(e,t,n){var r=this,i=Array.prototype.slice.call(arguments,1);n=i.pop();t=i.length?i.shift():null;var s=t==null?exports.GridStore.IO_SEEK_SET:t,o=e,u=0;s==exports.GridStore.IO_SEEK_CUR?u=r.position+o:s==exports.GridStore.IO_SEEK_END?u=r.length+o:u=o;var a=Math.floor(u/r.chunkSize);if(a!=r.currentChunk.chunkNumber){var f=function(){nthChunk(r,a,function(e,t){r.currentChunk=t;r.position=u;r.currentChunk.position=r.position%r.chunkSize;n(e,r)})};r.mode[0]=="w"?r.currentChunk.save(function(e){if(e)return n(e);f()}):f()}else{r.position=u;r.currentChunk.position=r.position%r.chunkSize;n(null,r)}};GridStore.prototype.eof=function(){return this.position==this.length?!0:!1};GridStore.prototype.getc=function(e){var t=this;if(t.eof())e(null,null);else if(t.currentChunk.eof())nthChunk(t,t.currentChunk.chunkNumber+1,function(n,r){t.currentChunk=r;t.position=t.position+1;e(n,t.currentChunk.getc())});else{t.position=t.position+1;e(null,t.currentChunk.getc())}};GridStore.prototype.puts=function(e,t){var n=e.match(/\n$/)==null?e+"\n":e;this.write(n,t)};GridStore.prototype.stream=function(e){return new ReadStream(e,this)};GridStore.DEFAULT_ROOT_COLLECTION="fs";GridStore.DEFAULT_CONTENT_TYPE="binary/octet-stream";GridStore.IO_SEEK_SET=0;GridStore.IO_SEEK_CUR=1;GridStore.IO_SEEK_END=2;GridStore.exist=function(e,t,n,r){var i=Array.prototype.slice.call(arguments,2);r=i.pop();n=i.length?i.shift():null;var s=n!=null?n:GridStore.DEFAULT_ROOT_COLLECTION;e.collection(s+".files",function(e,n){if(e)return r(e);var i=typeof t=="string"||Object.prototype.toString.call(t)=="[object RegExp]"?{filename:t}:{_id:t};n.find(i,function(e,t){if(e)return r(e);t.nextObject(function(e,t){if(e)return r(e);r(null,t==null?!1:!0)})})})};GridStore.list=function(e,t,n,r){var i=Array.prototype.slice.call(arguments,1);r=i.pop();t=i.length?i.shift():null;n=i.length?i.shift():{};if(t!=null&&typeof t=="object"){n=t;t=null}var s=n["id"]!=null?n.id:!1,o=t!=null?t:GridStore.DEFAULT_ROOT_COLLECTION,u=[];e.collection(o+".files",function(e,t){if(e)return r(e);t.find(function(e,t){if(e)return r(e);t.each(function(e,t){t!=null?u.push(s?t._id:t.filename):r(e,u)})})})};GridStore.read=function(e,t,n,r,i,s){var o=Array.prototype.slice.call(arguments,2);s=o.pop();n=o.length?o.shift():null;r=o.length?o.shift():null;i=o.length?o.shift():null;(new GridStore(e,t,"r",i)).open(function(e,t){if(e)return s(e);if(r&&r>=t.length)return s("offset larger than size of file",null);if(n&&n>t.length)return s("length is larger than the size of the file",null);if(r&&n&&r+n>t.length)return s("offset and length is larger than the size of the file",null);r!=null?t.seek(r,function(e,t){if(e)return s(e);t.read(n,s)}):t.read(n,s)})};GridStore.readlines=function(e,t,n,r,i){var s=Array.prototype.slice.call(arguments,2);i=s.pop();n=s.length?s.shift():null;r=s.length?s.shift():null;var o=n==null?"\n":n;(new GridStore(e,t,"r",r)).open(function(e,t){if(e)return i(e);t.readlines(o,i)})};GridStore.unlink=function(e,t,n,r){var i=this,s=Array.prototype.slice.call(arguments,2);r=s.pop();n=s.length?s.shift():null;if(t.constructor==Array){var o=0;for(var u=0;u<t.length;u++){++o;i.unlink(e,t[u],function(e){--o==0&&r(null,i)})}}else(new GridStore(e,t,"w",n)).open(function(e,t){if(e)return r(e);deleteChunks(t,function(e,n){if(e)return r(e);t.collection(function(e,n){if(e)return r(e);n.remove({_id:t.fileId},{safe:!0},function(e,t){r(e,i)})})})})};Object.defineProperty(GridStore.prototype,"chunkSize",{enumerable:!0,get:function(){return this.internalChunkSize},set:function(e){this.mode[0]!="w"||this.position!=0||this.uploadDate!=null?this.internalChunkSize=this.internalChunkSize:this.internalChunkSize=e}});Object.defineProperty(GridStore.prototype,"md5",{enumerable:!0,get:function(){return this.internalMd5}});Object.defineProperty(GridStore.prototype,"writable",{enumerable:!0,get:function(){this._writeable==null&&(this._writeable=this.mode!=null&&this.mode.indexOf("w")!=-1);return this._writeable},set:function(e){this._writeable=e}});Object.defineProperty(GridStore.prototype,"readable",{enumerable:!0,get:function(){this._readable==null&&(this._readable=this.mode!=null&&this.mode.indexOf("r")!=-1);return this._readable},set:function(e){this._readable=e}});GridStore.prototype.paused;GridStore.prototype.setEncoding=fs.ReadStream.prototype.setEncoding;GridStore.prototype.end=function(t){var n=this;if(!this.writable)return;this.writable=!1;t&&this._q.push(t);this.on("drain",function(){n.close(function(e){if(e)return _error(n,e);n.emit("close")})});_flush(n)};var _writeNormal=function(e,t,n,r){return Buffer.isBuffer(t)?writeBuffer(e,t,n,r):writeBuffer(e,new Buffer(t,"binary"),n,r)};GridStore.prototype.write=function(t,n,r){if(typeof n=="function"||typeof r=="function")return _writeNormal(this,t,n,r);var i=this;if(!this.writable)throw new Error("GridWriteStream is not writable");if(!this._opened){this._q=[];_openStream(i);this._q.push(t);return!1}this._q.push(t);_flush(this);return!0};GridStore.prototype.destroy=function(){if(!this.writable)return;this.readable=!1;if(this.writable){this.writable=!1;this._q.length=0;this.emit("close")}};GridStore.prototype.destroySoon=function(){if(!this._q.length)return this.destroy();this._destroying=!0};GridStore.prototype.pipe=function(e,t){var n=this;this.open(function(r,i){r&&_errorRead(n,r);if(!n.readable)return;n._pipe(e,t);n.emit("open");_read(n)})};var _read=function(t){if(!t.readable||t.paused||t.reading)return;t.reading=!0;var n=t._stream=t.stream();n.paused=t.paused;n.on("data",function(e){if(t._decoder){var n=t._decoder.write(e);n.length&&t.emit("data",n)}else t.emit("data",e)});n.on("end",function(e){t.emit("end",e)});n.on("error",function(e){_errorRead(t,e)});n.on("close",function(e){t.emit("close",e)});t.pause=function(){t.paused=n.paused=!0};t.resume=function(){t.paused=!1;n.resume();t.readable=n.readable};t.destroy=function(){t.readable=!1;n.destroy()}};GridStore.prototype.pause=function(){this.paused=!0};GridStore.prototype.resume=function(){this.paused=!1};var _flush=function t(e,n){if(!e._opened)return;if(!n&&e._flushing)return;e._flushing=!0;if(!e._q.length){e._flushing=!1;e.emit("drain");e._destroying&&e.destroy();return}e.write(e._q.shift(),function(n,r){if(n)return _error(e,n);e.emit("progress",r.position);t(e,!0)})},_openStream=function(t){if(t._opening==1)return;t._opening=!0;t.open(function(e,n){if(e)return _error(t,e);t._opened=!0;t.emit("open");_flush(t)})},_error=function(t,n){t.destroy();t.emit("error",n)},_errorRead=function(t,n){t.readable=!1;t.emit("error",n)};exports.GridStore=GridStore;