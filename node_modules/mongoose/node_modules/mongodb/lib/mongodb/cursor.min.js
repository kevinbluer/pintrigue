function Cursor(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C){this.db=e;this.collection=t;this.selector=n;this.fields=r;this.skipValue=i==null?0:i;this.limitValue=s==null?0:s;this.sortValue=o;this.hint=u;this.explainValue=a;this.snapshot=f;this.timeout=l==null?!0:l;this.tailable=c;this.awaitdata=S;this.numberOfRetries=x==null?5:x;this.currentNumberOfRetries=this.numberOfRetries;this.batchSizeValue=h==null?0:h;this.slaveOk=p==null?t.slaveOk:p;this.raw=d==null?!1:d;this.read=v==null?ReadPreference.PRIMARY:v;this.returnKey=m;this.maxScan=g;this.min=y;this.max=b;this.showDiskLoc=w;this.comment=E;this.tailableRetryInterval=N||100;this.exhaust=C||!1;this.totalNumberOfRecords=0;this.items=[];this.cursorId=Long.fromInt(0);this.dbName=T;this.state=Cursor.INIT;this.queryRun=!1;this.getMoreTimer=!1;this.dbName!=null?this.collectionName=this.dbName+"."+this.collection.collectionName:this.collectionName=(this.db.databaseName?this.db.databaseName+".":"")+this.collection.collectionName}var QueryCommand=require("./commands/query_command").QueryCommand,GetMoreCommand=require("./commands/get_more_command").GetMoreCommand,KillCursorCommand=require("./commands/kill_cursor_command").KillCursorCommand,Long=require("bson").Long,ReadPreference=require("./connection/read_preference").ReadPreference,CursorStream=require("./cursorstream"),utils=require("./utils");Cursor.prototype.rewind=function(){var e=this;if(e.state!=Cursor.INIT){e.state!=Cursor.CLOSED&&e.close(function(){});e.numberOfReturned=0;e.totalNumberOfRecords=0;e.items=[];e.cursorId=Long.fromInt(0);e.state=Cursor.INIT;e.queryRun=!1}return e};Cursor.prototype.toArray=function(e){var t=this;if(!e)throw new Error("callback is mandatory");if(this.tailable)e(new Error("Tailable cursor cannot be converted to array"),null);else if(this.state!=Cursor.CLOSED){var n=[];this.each(function(r,i){if(r!=null)return e(r,null);if(i!=null&&Array.isArray(n))n.push(i);else{var s=n;n=null;t.items=[];e(r,s)}})}else e(new Error("Cursor is closed"),null)};Cursor.prototype.each=function(e){var t=this;if(!e)throw new Error("callback is mandatory");this.state!=Cursor.CLOSED?process.nextTick(function(){var n=new Date;t.nextObject(function(n,r){if(n!=null)return e(n,null);if(r!=null){e(null,r);t.each(e)}else{t.state=Cursor.CLOSED;e(n,null)}})}):e(new Error("Cursor is closed"),null)};Cursor.prototype.count=function(e){this.collection.count(this.selector,e)};Cursor.prototype.sort=function(e,t,n){n=n||function(){};if(typeof t=="function"){n=t;t=null}if(this.tailable)n(new Error("Tailable cursor doesn't support sorting"),null);else if(this.queryRun==1||this.state==Cursor.CLOSED)n(new Error("Cursor is closed"),null);else{var r=e;t!=null&&(r=[[e,t]]);this.sortValue=r;n(null,this)}return this};Cursor.prototype.limit=function(e,t){if(this.tailable){if(!t)throw new Error("Tailable cursor doesn't support limit");t(new Error("Tailable cursor doesn't support limit"),null)}else if(this.queryRun==1||this.state==Cursor.CLOSED){if(!t)throw new Error("Cursor is closed");t(new Error("Cursor is closed"),null)}else if(e!=null&&e.constructor!=Number){if(!t)throw new Error("limit requires an integer");t(new Error("limit requires an integer"),null)}else{this.limitValue=e;if(t)return t(null,this)}return this};Cursor.prototype.setReadPreference=function(e,t,n){typeof t=="function"&&(n=t);n=n||function(){};this.queryRun==1||this.state==Cursor.CLOSED?n(new Error("Cannot change read preference on executed query or closed cursor")):e==null&&e!="primary"&&e!="secondaryOnly"&&e!="secondary"?n(new Error("only readPreference of primary, secondary or secondaryOnly supported")):this.read=e;return this};Cursor.prototype.skip=function(e,t){t=t||function(){};if(this.tailable)t(new Error("Tailable cursor doesn't support skip"),null);else if(this.queryRun==1||this.state==Cursor.CLOSED)t(new Error("Cursor is closed"),null);else if(e!=null&&e.constructor!=Number)t(new Error("skip requires an integer"),null);else{this.skipValue=e;t(null,this)}return this};Cursor.prototype.batchSize=function(e,t){if(this.state==Cursor.CLOSED){if(t!=null)return t(new Error("Cursor is closed"),null);throw new Error("Cursor is closed")}if(e!=null&&e.constructor!=Number){if(t!=null)return t(new Error("batchSize requires an integer"),null);throw new Error("batchSize requires an integer")}this.batchSizeValue=e;return t!=null?t(null,this):this};var limitRequest=function(e){var t=e.limitValue,n=Math.abs(e.limitValue),r=Math.abs(e.batchSizeValue);n>0?r>0&&(t=Math.min(n,r)):t=e.batchSizeValue;return t},generateQueryCommand=function(e){var t=QueryCommand.OPTS_NONE;e.timeout||(t|=QueryCommand.OPTS_NO_CURSOR_TIMEOUT);if(e.tailable!=null){t|=QueryCommand.OPTS_TAILABLE_CURSOR;e.skipValue=e.limitValue=0;e.awaitdata!=null&&(t|=QueryCommand.OPTS_AWAIT_DATA)}e.exhaust&&(t|=QueryCommand.OPTS_EXHAUST);e.slaveOk&&(t|=QueryCommand.OPTS_SLAVE);var n=e.limitValue==-1?-1:limitRequest(e);if(e.sortValue!=null||e.explainValue!=null||e.hint!=null||e.snapshot!=null||e.returnKey!=null||e.maxScan!=null||e.min!=null||e.max!=null||e.showDiskLoc!=null||e.comment!=null){var r={$query:e.selector};e.sortValue!=null&&(r.orderby=utils.formattedOrderClause(e.sortValue));e.hint!=null&&e.hint.constructor==Object&&(r.$hint=e.hint);e.snapshot!=null&&(r.$snapshot=!0);e.returnKey!=null&&(r.$returnKey=e.returnKey);e.maxScan!=null&&(r.$maxScan=e.maxScan);e.min!=null&&(r.$min=e.min);e.max!=null&&(r.$max=e.max);e.showDiskLoc!=null&&(r.$showDiskLoc=e.showDiskLoc);e.comment!=null&&(r.$comment=e.comment);if(e.explainValue!=null){n=-1*Math.abs(n);r.$explain=!0}return new QueryCommand(e.db,e.collectionName,t,e.skipValue,n,r,e.fields)}return new QueryCommand(e.db,e.collectionName,t,e.skipValue,n,e.selector,e.fields)};Cursor.prototype.formattedOrderClause=function(){return utils.formattedOrderClause(this.sortValue)};Cursor.prototype.formatSortValue=function(e){return utils.formatSortValue(e)};Cursor.prototype.nextObject=function(e){var t=this;if(t.state==Cursor.INIT){var n;try{n=generateQueryCommand(t)}catch(r){return e(r,null)}var i=function(n,r){if(n!=null&&r==null)return e(n,null);if(!n&&r.documents[0]&&r.documents[0].$err)return t.close(function(){e(r.documents[0].$err,null)});t.queryRun=!0;t.state=Cursor.OPEN;t.cursorId=r.cursorId;t.totalNumberOfRecords=r.numberReturned;for(var i=0;i<r.documents.length;i++)t.items.push(r.documents[i]);t.exhaust&&r.cursorId.toString()=="0"?t.nextObject(e):(t.exhaust==0||t.exhaust==null)&&t.nextObject(e)};if(t.connection==null)try{t.connection=this.read==null?t.db.serverConfig.checkoutWriter():t.db.serverConfig.checkoutReader(this.read)}catch(r){return e(r,null)}t.db._executeQueryCommand(n,{exhaust:t.exhaust,raw:t.raw,read:this.read,connection:t.connection},i);i=null}else if(t.items.length)e(null,t.items.shift());else{if(!t.cursorId.greaterThan(Long.fromInt(0)))return t.close(function(){e(null,null)});getMore(t,e)}};var getMore=function(e,t){var n=0;if(!e.tailable&&e.limitValue>0){n=e.limitValue-e.totalNumberOfRecords;if(n<1){e.close(function(){t(null,null)});return}}try{var r=new GetMoreCommand(e.db,e.collectionName,limitRequest(e),e.cursorId),i={read:e.read,raw:e.raw,connection:e.connection};e.db._executeQueryCommand(r,i,function(n,r){try{if(n!=null)return t(n,null);var i=1===r.responseFlag&&r.cursorId.isZero();e.cursorId=r.cursorId;e.totalNumberOfRecords+=r.numberReturned;if(r.numberReturned>0){if(e.limitValue>0){var s=e.totalNumberOfRecords-e.limitValue;s>0&&r.documents.splice(-1*s,s)}e.currentNumberOfRetries=e.numberOfRetries;for(var o=0;o<r.documents.length;o++)e.items.push(r.documents[o]);t(null,e.items.shift())}else if(e.tailable&&!i&&e.awaitdata){e.currentNumberOfRetries=e.currentNumberOfRetries-1;e.currentNumberOfRetries==0?e.close(function(){t(new Error("tailable cursor timed out"),null)}):process.nextTick(function(){getMore(e,t)})}else e.tailable&&!i?e.getMoreTimer=setTimeout(function(){getMore(e,t)},e.tailableRetryInterval):e.close(function(){t(null,null)});r=null}catch(n){t(n,null)}});r=null}catch(s){var o=function(){t(s,null)};e.close(o);o=null}};Cursor.prototype.explain=function(e){var t=-1*Math.abs(this.limitValue),n=new Cursor(this.db,this.collection,this.selector,this.fields,this.skipValue,t,this.sortValue,this.hint,!0,this.snapshot,this.timeout,this.tailable,this.batchSizeValue,this.slaveOk,this.raw,this.read,this.returnKey,this.maxScan,this.min,this.max,this.showDiskLoc,this.comment,this.awaitdata,this.numberOfRetries,this.dbName);n.nextObject(function(t,r){if(t!=null)return e(t,null);n.close(function(t,n){if(t!=null)return e(t,null);e(null,r)})})};Cursor.prototype.streamRecords=function(e){function u(e){n.db._executeQueryCommand(e,{exhaust:n.exhaust,read:n.read,raw:n.raw,connection:n.connection},function(e,t){if(e){r.emit("error",e);n.close(function(){});return}if(!n.queryRun&&t){n.queryRun=!0;n.cursorId=t.cursorId;n.state=Cursor.OPEN;n.getMoreCommand=new GetMoreCommand(n.db,n.collectionName,o.numberToReturn,t.cursorId)}var a={CursorNotFound:1,QueryFailure:2,ShardConfigStale:4,AwaitCapable:8};if(t.documents&&t.documents.length&&!(t.responseFlag&a.QueryFailure)){try{t.documents.forEach(function(e){if(i&&s>=i)throw"done";s++;r.emit("data",e)})}catch(e){if(e!="done")throw e;n.close(function(){r.emit("end",i)});n.close(function(){});return}u(n.getMoreCommand)}else n.close(function(){r.emit("end",i)})})}var t=Array.prototype.slice.call(arguments,0);e=t.length?t.shift():{};var n=this,r=new process.EventEmitter,i=this.limitValue||0,s=0,o=generateQueryCommand(n);o.numberToReturn=e.fetchSize?e.fetchSize:500;u(o);return r};Cursor.prototype.stream=function(){return new CursorStream(this)};Cursor.prototype.close=function(e){var t=this;this.getMoreTimer&&clearTimeout(this.getMoreTimer);if(this.cursorId instanceof Long&&this.cursorId.greaterThan(Long.fromInt(0)))try{var n=new KillCursorCommand(this.db,[this.cursorId]);this.db._executeQueryCommand(n,{read:t.read,raw:t.raw,connection:t.connection},null)}catch(r){}t.connection=null;this.cursorId=Long.fromInt(0);this.state=Cursor.CLOSED;if(e){e(null,t);t.items=[]}return this};Cursor.prototype.isClosed=function(){return this.state==Cursor.CLOSED?!0:!1};Cursor.INIT=0;Cursor.OPEN=1;Cursor.CLOSED=2;exports.Cursor=Cursor;