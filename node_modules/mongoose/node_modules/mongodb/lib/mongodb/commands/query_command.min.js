var BaseCommand=require("./base_command").BaseCommand,inherits=require("util").inherits,QueryCommand=exports.QueryCommand=function(e,t,n,r,i,s,o,u){BaseCommand.call(this);var a=s,f;if(Buffer.isBuffer(a)){f=a[0]|a[1]<<8|a[2]<<16|a[3]<<24;if(f!=a.length){var l=new Error("query selector raw message size does not match message header size ["+a.length+"] != ["+f+"]");l.name="MongoError";throw l}}a=o;if(Buffer.isBuffer(a)){f=a[0]|a[1]<<8|a[2]<<16|a[3]<<24;if(f!=a.length){var l=new Error("query fields raw message size does not match message header size ["+a.length+"] != ["+f+"]");l.name="MongoError";throw l}}u=u==null?{}:u;this.collectionName=t;this.queryOptions=n;this.numberToSkip=r;this.numberToReturn=i;s=s==null?{}:s;this.query=s;this.returnFieldSelector=o;this.db=e;u["serializeFunctions"]!=null&&u.serializeFunctions&&(this.serializeFunctions=!0)};inherits(QueryCommand,BaseCommand);QueryCommand.OP_QUERY=2004;QueryCommand.prototype.setMongosReadPreference=function(e,t){e==1?e="secondaryPreferred":e=="false"&&(e="primary");e!=0&&e!="primary"&&(this.queryOptions|=QueryCommand.OPTS_SLAVE);(e!=null||t!=null)&&this.query["$query"]==null&&(this.query={$query:this.query});e==null&&t==null&&(this.queryOptions&QueryCommand.OPTS_SLAVE?this.query.$readPreference={mode:"secondary"}:this.query.$readPreference={mode:"primary"});if(typeof e=="object"&&e["_type"]=="ReadPreference")this.query.$readPreference=e.toObject();else if(e!=null){this.query.$readPreference={mode:e};t!=null&&(this.query.$readPreference.tags=t)}};QueryCommand.prototype.toBinary=function(){var e=0;Buffer.isBuffer(this.query)?e=4+Buffer.byteLength(this.collectionName)+1+4+4+this.query.length+16:e=4+Buffer.byteLength(this.collectionName)+1+4+4+this.db.bson.calculateObjectSize(this.query,this.serializeFunctions,!0)+16;this.returnFieldSelector!=null&&!Buffer.isBuffer(this.returnFieldSelector)?Object.keys(this.returnFieldSelector).length>0&&(e+=this.db.bson.calculateObjectSize(this.returnFieldSelector,this.serializeFunctions,!0)):Buffer.isBuffer(this.returnFieldSelector)&&(e+=this.returnFieldSelector.length);var t=0,n=new Buffer(e);n[t+3]=e>>24&255;n[t+2]=e>>16&255;n[t+1]=e>>8&255;n[t]=e&255;t+=4;n[t+3]=this.requestId>>24&255;n[t+2]=this.requestId>>16&255;n[t+1]=this.requestId>>8&255;n[t]=this.requestId&255;t+=4;n[t++]=0;n[t++]=0;n[t++]=0;n[t++]=0;n[t+3]=QueryCommand.OP_QUERY>>24&255;n[t+2]=QueryCommand.OP_QUERY>>16&255;n[t+1]=QueryCommand.OP_QUERY>>8&255;n[t]=QueryCommand.OP_QUERY&255;t+=4;n[t+3]=this.queryOptions>>24&255;n[t+2]=this.queryOptions>>16&255;n[t+1]=this.queryOptions>>8&255;n[t]=this.queryOptions&255;t+=4;t=t+n.write(this.collectionName,t,"utf8")+1;n[t-1]=0;n[t+3]=this.numberToSkip>>24&255;n[t+2]=this.numberToSkip>>16&255;n[t+1]=this.numberToSkip>>8&255;n[t]=this.numberToSkip&255;t+=4;n[t+3]=this.numberToReturn>>24&255;n[t+2]=this.numberToReturn>>16&255;n[t+1]=this.numberToReturn>>8&255;n[t]=this.numberToReturn&255;t+=4;var r=0,i=this.query;if(Buffer.isBuffer(i)){r=i.length;i.copy(n,t)}else r=this.db.bson.serializeWithBufferAndIndex(i,this.checkKeys,n,t,this.serializeFunctions)-t+1;n[t+3]=r>>24&255;n[t+2]=r>>16&255;n[t+1]=r>>8&255;n[t]=r&255;t+=r;n[t-1]=0;if(this.returnFieldSelector!=null&&!Buffer.isBuffer(this.returnFieldSelector)&&Object.keys(this.returnFieldSelector).length>0){var r=this.db.bson.serializeWithBufferAndIndex(this.returnFieldSelector,this.checkKeys,n,t,this.serializeFunctions)-t+1;n[t+3]=r>>24&255;n[t+2]=r>>16&255;n[t+1]=r>>8&255;n[t]=r&255;t+=r;n[t-1]=0}if(this.returnFieldSelector!=null&&Buffer.isBuffer(this.returnFieldSelector)){var r=0,i=this.returnFieldSelector;r=i.length;i.copy(n,t);n[t+3]=r>>24&255;n[t+2]=r>>16&255;n[t+1]=r>>8&255;n[t]=r&255;t+=r;n[t-1]=0}return n};QueryCommand.OPTS_NONE=0;QueryCommand.OPTS_TAILABLE_CURSOR=2;QueryCommand.OPTS_SLAVE=4;QueryCommand.OPTS_OPLOG_REPLY=8;QueryCommand.OPTS_NO_CURSOR_TIMEOUT=16;QueryCommand.OPTS_AWAIT_DATA=32;QueryCommand.OPTS_EXHAUST=64;