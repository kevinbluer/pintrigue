var QueryCommand=require("./query_command").QueryCommand,InsertCommand=require("./insert_command").InsertCommand,inherits=require("util").inherits,crypto=require("crypto"),DbCommand=exports.DbCommand=function(e,t,n,r,i,s,o,u){QueryCommand.call(this);this.collectionName=t;this.queryOptions=n;this.numberToSkip=r;this.numberToReturn=i;this.query=s;this.returnFieldSelector=o;this.db=e;u=u==null?{}:u;u["serializeFunctions"]!=null&&u.serializeFunctions&&(this.serializeFunctions=!0)};inherits(DbCommand,QueryCommand);DbCommand.SYSTEM_NAMESPACE_COLLECTION="system.namespaces";DbCommand.SYSTEM_INDEX_COLLECTION="system.indexes";DbCommand.SYSTEM_PROFILE_COLLECTION="system.profile";DbCommand.SYSTEM_USER_COLLECTION="system.users";DbCommand.SYSTEM_COMMAND_COLLECTION="$cmd";DbCommand.NcreateIsMasterCommand=function(e,t){return new DbCommand(e,t+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{ismaster:1},null)};DbCommand.createIsMasterCommand=function(e){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{ismaster:1},null)};DbCommand.createCollectionInfoCommand=function(e,t){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_NAMESPACE_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,0,t,null)};DbCommand.createGetNonceCommand=function(e,t){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{getnonce:1},null)};DbCommand.createAuthenticationCommand=function(e,t,n,r,i){var s=crypto.createHash("md5");s.update(t+":mongo:"+n);var o=s.digest("hex");s=crypto.createHash("md5");s.update(r+t+o);var u=s.digest("hex"),a={authenticate:1,user:t,nonce:r,key:u};return new DbCommand(e,i+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NONE,0,-1,a,null)};DbCommand.createLogoutCommand=function(e){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{logout:1},null)};DbCommand.createCreateCollectionCommand=function(e,t,n){var r={create:t};for(var i in n)n[i]!=null&&n[i].constructor!=Function&&(r[i]=n[i]);return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,r,null)};DbCommand.createDropCollectionCommand=function(e,t){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{drop:t},null)};DbCommand.createRenameCollectionCommand=function(e,t,n){var r=e.databaseName+"."+t,i=e.databaseName+"."+n;return new DbCommand(e,"admin."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{renameCollection:r,to:i},null)};DbCommand.createGetLastErrorCommand=function(e,t){if(typeof t=="undefined"){t=e;e={}}var n={getlasterror:1};if("object"==typeof e)for(var r in e)n[r]=e[r];return new DbCommand(t,t.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,n,null)};DbCommand.createGetLastStatusCommand=DbCommand.createGetLastErrorCommand;DbCommand.createGetPreviousErrorsCommand=function(e){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{getpreverror:1},null)};DbCommand.createResetErrorHistoryCommand=function(e){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{reseterror:1},null)};DbCommand.createCreateIndexCommand=function(e,t,n,r){var i={},s=[],o;if(n.constructor===String){s.push(n+"_"+1);i[n]=1}else if(n.constructor===Array)n.forEach(function(e){if(e.constructor===String){s.push(e+"_"+1);i[e]=1}else if(e.constructor===Array){s.push(e[0]+"_"+(e[1]||1));i[e[0]]=e[1]||1}else if(e.constructor===Object){o=Object.keys(e);o.forEach(function(t){s.push(t+"_"+e[t]);i[t]=e[t]})}});else if(n.constructor===Object){o=Object.keys(n);o.forEach(function(e){s.push(e+"_"+n[e]);i[e]=n[e]})}var u=typeof r.name=="string"?r.name:s.join("_"),a={ns:e.databaseName+"."+t,key:i,name:u},f=r==null||"object"==typeof r?!1:r;r=r==null||typeof r=="boolean"?{}:r;var o=Object.keys(r);for(var l=0;l<o.length;l++)a[o[l]]=r[o[l]];a["unique"]==null&&(a.unique=f);return(new InsertCommand(e,e.databaseName+"."+DbCommand.SYSTEM_INDEX_COLLECTION,!1)).add(a)};DbCommand.logoutCommand=function(e,t,n){var r=n!=null&&n["authdb"]!=null?n.authdb:e.databaseName;return new DbCommand(e,r+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,t,null)};DbCommand.createDropIndexCommand=function(e,t,n){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{deleteIndexes:t,index:n},null)};DbCommand.createReIndexCommand=function(e,t){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{reIndex:t},null)};DbCommand.createDropDatabaseCommand=function(e){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,{dropDatabase:1},null)};DbCommand.createDbCommand=function(e,t,n){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,t,null,n)};DbCommand.createAdminDbCommand=function(e,t){return new DbCommand(e,"admin."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT,0,-1,t,null)};DbCommand.createAdminDbCommandSlaveOk=function(e,t){return new DbCommand(e,"admin."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT|QueryCommand.OPTS_SLAVE,0,-1,t,null)};DbCommand.createDbSlaveOkCommand=function(e,t,n){return new DbCommand(e,e.databaseName+"."+DbCommand.SYSTEM_COMMAND_COLLECTION,QueryCommand.OPTS_NO_CURSOR_TIMEOUT|QueryCommand.OPTS_SLAVE,0,-1,t,null,n)};